import { ResourceCollection } from './resource-collection';
import { throwError as observableThrowError } from 'rxjs';
import { getPagedResourceCollectionHttpService } from '../../service/internal/paged-resource-collection-http.service';
import { StageLogger } from '../../logger/stage-logger';
import { Stage } from '../../logger/stage.enum';
import { tap } from 'rxjs/operators';
import { ValidationUtils } from '../../util/validation.utils';
import { isEmpty, isNumber, result } from 'lodash-es';
/**
 * Collection of resources with pagination.
 */
export class PagedResourceCollection extends ResourceCollection {
    /**
     * Create a new paged resource collection from resource collection with the page data.
     *
     * @param resourceCollection collection that will be paged
     * @param pageData contains data about characteristics of the page.
     */
    constructor(resourceCollection, pageData) {
        super(resourceCollection);
        this.totalElements = result(pageData, 'page.totalElements', 0);
        this.totalPages = result(pageData, 'page.totalPages', 1);
        this.pageSize = result(pageData, 'page.size', 20);
        this.pageNumber = result(pageData, 'page.number', 0);
        this.selfLink = result(pageData, '_links.self', null);
        this.nextLink = result(pageData, '_links.next', null);
        this.prevLink = result(pageData, '_links.prev', null);
        this.firstLink = result(pageData, '_links.first', null);
        this.lastLink = result(pageData, '_links.last', null);
    }
    hasFirst() {
        return !!this.firstLink && !!this.firstLink.href;
    }
    hasLast() {
        return !!this.lastLink && !!this.lastLink.href;
    }
    hasNext() {
        return !!this.nextLink && !!this.nextLink.href;
    }
    hasPrev() {
        return !!this.prevLink && !!this.prevLink.href;
    }
    first(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_FIRST_PAGE');
        if (!this.hasFirst()) {
            const errMsg = 'Page has not first url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.firstLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_FIRST_PAGE', { result: 'get first page was performed successful' });
        }));
    }
    last(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_LAST_PAGE');
        if (!this.hasLast()) {
            const errMsg = 'Page has not last url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.lastLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_LAST_PAGE', { result: 'get last page was performed successful' });
        }));
    }
    next(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_NEXT_PAGE');
        if (!this.hasNext()) {
            const errMsg = 'Page has not next url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.nextLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_NEXT_PAGE', { result: 'get next page was performed successful' });
        }));
    }
    prev(options) {
        StageLogger.resourceBeginLog(this.resources[0], 'GET_PREV_PAGE');
        if (!this.hasPrev()) {
            const errMsg = 'Page has not prev url';
            StageLogger.stageErrorLog(Stage.PREPARE_URL, { error: errMsg });
            return observableThrowError(new Error(errMsg));
        }
        return doRequest(this.prevLink.href, options?.useCache).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'GET_PREV_PAGE', { result: 'get prev page was performed successful' });
        }));
    }
    page(pageNumber, options) {
        return this.customPage({ pageParams: { page: pageNumber } }, options);
    }
    size(size, options) {
        return this.customPage({ pageParams: { page: 0, size } }, options);
    }
    sortElements(sortParam, options) {
        return this.customPage({ sort: sortParam }, options);
    }
    /**
     * Perform query with custom page data.
     * That allows you change page size, current page or sort options.
     *
     * @param params contains data about new characteristics of the page.
     * @param options (optional) additional options that will be applied to the request
     * @throws error when required params are not valid or when passed inconsistent data
     */
    customPage(params, options) {
        StageLogger.resourceBeginLog(this.resources[0], 'CustomPage', { pageParam: params.pageParams });
        if (!params.pageParams || isEmpty(params.pageParams)) {
            params.pageParams = {};
            params.pageParams.page = this.pageNumber;
            params.pageParams.size = this.pageSize;
        }
        if (!isNumber(params.pageParams.page) || params.pageParams.page < 0) {
            params.pageParams.page = this.pageNumber;
            StageLogger.stageLog(Stage.PREPARE_PARAMS, {
                message: 'Page number is not passed will be used current value',
                currentPageNumber: this.pageNumber
            });
        }
        if (!isNumber(params.pageParams.size) || params.pageParams.size < 0) {
            params.pageParams.size = this.pageSize;
            StageLogger.stageLog(Stage.PREPARE_PARAMS, {
                message: 'Page size is not passed will be used current value',
                currentPageSize: this.pageSize
            });
        }
        const maxPageNumber = (this.totalElements / params.pageParams.size);
        if (params.pageParams.page > maxPageNumber) {
            const errMsg = `Error page number. Max page number is ${parseInt(maxPageNumber + '', 10)}`;
            StageLogger.stageErrorLog(Stage.PREPARE_PARAMS, { error: errMsg });
            return observableThrowError(errMsg);
        }
        const requestUrl = new URL(this.selfLink.href);
        requestUrl.searchParams.delete('page');
        requestUrl.searchParams.delete('size');
        requestUrl.searchParams.delete('sort');
        return doRequest(requestUrl.href, options?.useCache, params).pipe(tap(() => {
            StageLogger.resourceEndLog(this.resources[0], 'CustomPage', { result: 'custom page was performed successful' });
        }));
    }
}
function doRequest(url, useCache = true, params) {
    ValidationUtils.validateInputParams({ url });
    return getPagedResourceCollectionHttpService()
        .get(url, { ...params, useCache });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZWQtcmVzb3VyY2UtY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oYXRlb2FzLWNsaWVudC9zcmMvbGliL21vZGVsL3Jlc291cmNlL3BhZ2VkLXJlc291cmNlLWNvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFM0QsT0FBTyxFQUFjLFVBQVUsSUFBSSxvQkFBb0IsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RSxPQUFPLEVBQUUscUNBQXFDLEVBQUUsTUFBTSwrREFBK0QsQ0FBQztBQUV0SCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXREOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHVCQUFnRCxTQUFRLGtCQUFxQjtJQWF4Rjs7Ozs7T0FLRztJQUNILFlBQVksa0JBQXlDLEVBQUUsUUFBbUI7UUFDeEUsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDMUIsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9ELElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFF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QUFDO0lBRTNDLE9BQU8scUNBQXFDLEVBQUU7U0FDM0MsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFDLEdBQUcsTUFBTSxFQUFFLFFBQVEsRUFBQyxDQUEyQyxDQUFDO0FBQy9FLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNvdXJjZUNvbGxlY3Rpb24gfSBmcm9tICcuL3Jlc291cmNlLWNvbGxlY3Rpb24nO1xuaW1wb3J0IHsgQmFzZVJlc291cmNlIH0gZnJvbSAnLi9iYXNlLXJlc291cmNlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgYXMgb2JzZXJ2YWJsZVRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGdldFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uSHR0cFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlL2ludGVybmFsL3BhZ2VkLXJlc291cmNlLWNvbGxlY3Rpb24taHR0cC5zZXJ2aWNlJztcbmltcG9ydCB7IExpbmtEYXRhLCBQYWdlRGF0YSwgU29ydCwgU29ydGVkUGFnZVBhcmFtIH0gZnJvbSAnLi4vZGVjbGFyYXRpb25zJztcbmltcG9ydCB7IFN0YWdlTG9nZ2VyIH0gZnJvbSAnLi4vLi4vbG9nZ2VyL3N0YWdlLWxvZ2dlcic7XG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uLy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFZhbGlkYXRpb25VdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvdmFsaWRhdGlvbi51dGlscyc7XG5pbXBvcnQgeyBpc0VtcHR5LCBpc051bWJlciwgcmVzdWx0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuLyoqXG4gKiBDb2xsZWN0aW9uIG9mIHJlc291cmNlcyB3aXRoIHBhZ2luYXRpb24uXG4gKi9cbmV4cG9ydCBjbGFzcyBQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxUIGV4dGVuZHMgQmFzZVJlc291cmNlPiBleHRlbmRzIFJlc291cmNlQ29sbGVjdGlvbjxUPiB7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBzZWxmTGluazogTGlua0RhdGE7XG4gIHByaXZhdGUgcmVhZG9ubHkgbmV4dExpbms6IExpbmtEYXRhO1xuICBwcml2YXRlIHJlYWRvbmx5IHByZXZMaW5rOiBMaW5rRGF0YTtcbiAgcHJpdmF0ZSByZWFkb25seSBmaXJzdExpbms6IExpbmtEYXRhO1xuICBwcml2YXRlIHJlYWRvbmx5IGxhc3RMaW5rOiBMaW5rRGF0YTtcblxuICBwdWJsaWMgcmVhZG9ubHkgdG90YWxFbGVtZW50czogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgdG90YWxQYWdlczogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgcGFnZU51bWJlcjogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgcGFnZVNpemU6IG51bWJlcjtcblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IHBhZ2VkIHJlc291cmNlIGNvbGxlY3Rpb24gZnJvbSByZXNvdXJjZSBjb2xsZWN0aW9uIHdpdGggdGhlIHBhZ2UgZGF0YS5cbiAgICpcbiAgICogQHBhcmFtIHJlc291cmNlQ29sbGVjdGlvbiBjb2xsZWN0aW9uIHRoYXQgd2lsbCBiZSBwYWdlZFxuICAgKiBAcGFyYW0gcGFnZURhdGEgY29udGFpbnMgZGF0YSBhYm91dCBjaGFyYWN0ZXJpc3RpY3Mgb2YgdGhlIHBhZ2UuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihyZXNvdXJjZUNvbGxlY3Rpb246IFJlc291cmNlQ29sbGVjdGlvbjxUPiwgcGFnZURhdGE/OiBQYWdlRGF0YSkge1xuICAgIHN1cGVyKHJlc291cmNlQ29sbGVjdGlvbik7XG4gICAgdGhpcy50b3RhbEVsZW1lbnRzID0gcmVzdWx0KHBhZ2VEYXRhLCAncGFnZS50b3RhbEVsZW1lbnRzJywgMCk7XG4gICAgdGhpcy50b3RhbFBhZ2VzID0gcmVzdWx0KHBhZ2VEYXRhLCAncGFnZS50b3RhbFBhZ2VzJywgMSk7XG4gICAgdGhpcy5wYWdlU2l6ZSA9IHJlc3VsdChwYWdlRGF0YSwgJ3BhZ2Uuc2l6ZScsIDIwKTtcbiAgICB0aGlzLnBhZ2VOdW1iZXIgPSByZXN1bHQocGFnZURhdGEsICdwYWdlLm51bWJlcicsIDApO1xuXG4gICAgdGhpcy5zZWxmTGluayA9IHJlc3VsdChwYWdlRGF0YSwgJ19saW5rcy5zZWxmJywgbnVsbCk7XG4gICAgdGhpcy5uZXh0TGluayA9IHJlc3VsdChwYWdlRGF0YSwgJ19saW5rcy5uZXh0JywgbnVsbCk7XG4gICAgdGhpcy5wcmV2TGluayA9IHJlc3VsdChwYWdlRGF0YSwgJ19saW5rcy5wcmV2JywgbnVsbCk7XG4gICAgdGhpcy5maXJzdExpbmsgPSByZXN1bHQocGFnZURhdGEsICdfbGlua3MuZmlyc3QnLCBudWxsKTtcbiAgICB0aGlzLmxhc3RMaW5rID0gcmVzdWx0KHBhZ2VEYXRhLCAnX2xpbmtzLmxhc3QnLCBudWxsKTtcbiAgfVxuXG4gIHB1YmxpYyBoYXNGaXJzdCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLmZpcnN0TGluayAmJiAhIXRoaXMuZmlyc3RMaW5rLmhyZWY7XG4gIH1cblxuICBwdWJsaWMgaGFzTGFzdCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLmxhc3RMaW5rICYmICEhdGhpcy5sYXN0TGluay5ocmVmO1xuICB9XG5cbiAgcHVibGljIGhhc05leHQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5uZXh0TGluayAmJiAhIXRoaXMubmV4dExpbmsuaHJlZjtcbiAgfVxuXG4gIHB1YmxpYyBoYXNQcmV2KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMucHJldkxpbmsgJiYgISF0aGlzLnByZXZMaW5rLmhyZWY7XG4gIH1cblxuICBwdWJsaWMgZmlyc3Qob3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcbiAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUJlZ2luTG9nKHRoaXMucmVzb3VyY2VzWzBdLCAnR0VUX0ZJUlNUX1BBR0UnKTtcbiAgICBpZiAoIXRoaXMuaGFzRmlyc3QoKSkge1xuICAgICAgY29uc3QgZXJyTXNnID0gJ1BhZ2UgaGFzIG5vdCBmaXJzdCB1cmwnO1xuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VFcnJvckxvZyhTdGFnZS5QUkVQQVJFX1VSTCwge2Vycm9yOiBlcnJNc2d9KTtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlVGhyb3dFcnJvcihuZXcgRXJyb3IoZXJyTXNnKSk7XG4gICAgfVxuICAgIHJldHVybiBkb1JlcXVlc3Q8VD4odGhpcy5maXJzdExpbmsuaHJlZiwgb3B0aW9ucz8udXNlQ2FjaGUpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUVuZExvZyh0aGlzLnJlc291cmNlc1swXSwgJ0dFVF9GSVJTVF9QQUdFJywge3Jlc3VsdDogJ2dldCBmaXJzdCBwYWdlIHdhcyBwZXJmb3JtZWQgc3VjY2Vzc2Z1bCd9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBsYXN0KG9wdGlvbnM/OiB7IHVzZUNhY2hlOiB0cnVlIH0pOiBPYnNlcnZhYmxlPFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQ+PiB7XG4gICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VCZWdpbkxvZyh0aGlzLnJlc291cmNlc1swXSwgJ0dFVF9MQVNUX1BBR0UnKTtcbiAgICBpZiAoIXRoaXMuaGFzTGFzdCgpKSB7XG4gICAgICBjb25zdCBlcnJNc2cgPSAnUGFnZSBoYXMgbm90IGxhc3QgdXJsJztcbiAgICAgIFN0YWdlTG9nZ2VyLnN0YWdlRXJyb3JMb2coU3RhZ2UuUFJFUEFSRV9VUkwsIHtlcnJvcjogZXJyTXNnfSk7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZVRocm93RXJyb3IobmV3IEVycm9yKGVyck1zZykpO1xuICAgIH1cbiAgICByZXR1cm4gZG9SZXF1ZXN0PFQ+KHRoaXMubGFzdExpbmsuaHJlZiwgb3B0aW9ucz8udXNlQ2FjaGUpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUVuZExvZyh0aGlzLnJlc291cmNlc1swXSwgJ0dFVF9MQVNUX1BBR0UnLCB7cmVzdWx0OiAnZ2V0IGxhc3QgcGFnZSB3YXMgcGVyZm9ybWVkIHN1Y2Nlc3NmdWwnfSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgbmV4dChvcHRpb25zPzogeyB1c2VDYWNoZTogdHJ1ZSB9KTogT2JzZXJ2YWJsZTxQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxUPj4ge1xuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcy5yZXNvdXJjZXNbMF0sICdHRVRfTkVYVF9QQUdFJyk7XG4gICAgaWYgKCF0aGlzLmhhc05leHQoKSkge1xuICAgICAgY29uc3QgZXJyTXNnID0gJ1BhZ2UgaGFzIG5vdCBuZXh0IHVybCc7XG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUVycm9yTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7ZXJyb3I6IGVyck1zZ30pO1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVUaHJvd0Vycm9yKG5ldyBFcnJvcihlcnJNc2cpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRvUmVxdWVzdDxUPih0aGlzLm5leHRMaW5rLmhyZWYsIG9wdGlvbnM/LnVzZUNhY2hlKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VFbmRMb2codGhpcy5yZXNvdXJjZXNbMF0sICdHRVRfTkVYVF9QQUdFJywge3Jlc3VsdDogJ2dldCBuZXh0IHBhZ2Ugd2FzIHBlcmZvcm1lZCBzdWNjZXNzZnVsJ30pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHByZXYob3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcbiAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUJlZ2luTG9nKHRoaXMucmVzb3VyY2VzWzBdLCAnR0VUX1BSRVZfUEFHRScpO1xuICAgIGlmICghdGhpcy5oYXNQcmV2KCkpIHtcbiAgICAgIGNvbnN0IGVyck1zZyA9ICdQYWdlIGhhcyBub3QgcHJldiB1cmwnO1xuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VFcnJvckxvZyhTdGFnZS5QUkVQQVJFX1VSTCwge2Vycm9yOiBlcnJNc2d9KTtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlVGhyb3dFcnJvcihuZXcgRXJyb3IoZXJyTXNnKSk7XG4gICAgfVxuICAgIHJldHVybiBkb1JlcXVlc3Q8VD4odGhpcy5wcmV2TGluay5ocmVmLCBvcHRpb25zPy51c2VDYWNoZSkucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlRW5kTG9nKHRoaXMucmVzb3VyY2VzWzBdLCAnR0VUX1BSRVZfUEFHRScsIHtyZXN1bHQ6ICdnZXQgcHJldiBwYWdlIHdhcyBwZXJmb3JtZWQgc3VjY2Vzc2Z1bCd9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBwYWdlKHBhZ2VOdW1iZXI6IG51bWJlciwgb3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcbiAgICByZXR1cm4gdGhpcy5jdXN0b21QYWdlKHtwYWdlUGFyYW1zOiB7cGFnZTogcGFnZU51bWJlcn19LCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBzaXplKHNpemU6IG51bWJlciwgb3B0aW9ucz86IHsgdXNlQ2FjaGU6IHRydWUgfSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcbiAgICByZXR1cm4gdGhpcy5jdXN0b21QYWdlKHtwYWdlUGFyYW1zOiB7cGFnZTogMCwgc2l6ZX19LCBvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBzb3J0RWxlbWVudHMoc29ydFBhcmFtOiBTb3J0LCBvcHRpb25zPzogeyB1c2VDYWNoZTogdHJ1ZSB9KTogT2JzZXJ2YWJsZTxQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxUPj4ge1xuICAgIHJldHVybiB0aGlzLmN1c3RvbVBhZ2Uoe3NvcnQ6IHNvcnRQYXJhbX0sIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gcXVlcnkgd2l0aCBjdXN0b20gcGFnZSBkYXRhLlxuICAgKiBUaGF0IGFsbG93cyB5b3UgY2hhbmdlIHBhZ2Ugc2l6ZSwgY3VycmVudCBwYWdlIG9yIHNvcnQgb3B0aW9ucy5cbiAgICpcbiAgICogQHBhcmFtIHBhcmFtcyBjb250YWlucyBkYXRhIGFib3V0IG5ldyBjaGFyYWN0ZXJpc3RpY3Mgb2YgdGhlIHBhZ2UuXG4gICAqIEBwYXJhbSBvcHRpb25zIChvcHRpb25hbCkgYWRkaXRpb25hbCBvcHRpb25zIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHRvIHRoZSByZXF1ZXN0XG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZCBvciB3aGVuIHBhc3NlZCBpbmNvbnNpc3RlbnQgZGF0YVxuICAgKi9cbiAgcHVibGljIGN1c3RvbVBhZ2UocGFyYW1zOiBTb3J0ZWRQYWdlUGFyYW0sIG9wdGlvbnM/OiB7IHVzZUNhY2hlOiB0cnVlIH0pOiBPYnNlcnZhYmxlPFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQ+PiB7XG4gICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VCZWdpbkxvZyh0aGlzLnJlc291cmNlc1swXSwgJ0N1c3RvbVBhZ2UnLCB7cGFnZVBhcmFtOiBwYXJhbXMucGFnZVBhcmFtc30pO1xuXG4gICAgaWYgKCFwYXJhbXMucGFnZVBhcmFtcyB8fCBpc0VtcHR5KHBhcmFtcy5wYWdlUGFyYW1zKSkge1xuICAgICAgcGFyYW1zLnBhZ2VQYXJhbXMgPSB7fTtcbiAgICAgIHBhcmFtcy5wYWdlUGFyYW1zLnBhZ2UgPSB0aGlzLnBhZ2VOdW1iZXI7XG4gICAgICBwYXJhbXMucGFnZVBhcmFtcy5zaXplID0gdGhpcy5wYWdlU2l6ZTtcbiAgICB9XG4gICAgaWYgKCFpc051bWJlcihwYXJhbXMucGFnZVBhcmFtcy5wYWdlKSB8fCBwYXJhbXMucGFnZVBhcmFtcy5wYWdlIDwgMCkge1xuICAgICAgcGFyYW1zLnBhZ2VQYXJhbXMucGFnZSA9IHRoaXMucGFnZU51bWJlcjtcbiAgICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfUEFSQU1TLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdQYWdlIG51bWJlciBpcyBub3QgcGFzc2VkIHdpbGwgYmUgdXNlZCBjdXJyZW50IHZhbHVlJyxcbiAgICAgICAgY3VycmVudFBhZ2VOdW1iZXI6IHRoaXMucGFnZU51bWJlclxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmICghaXNOdW1iZXIocGFyYW1zLnBhZ2VQYXJhbXMuc2l6ZSkgfHwgcGFyYW1zLnBhZ2VQYXJhbXMuc2l6ZSA8IDApIHtcbiAgICAgIHBhcmFtcy5wYWdlUGFyYW1zLnNpemUgPSB0aGlzLnBhZ2VTaXplO1xuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUFJFUEFSRV9QQVJBTVMsIHtcbiAgICAgICAgbWVzc2FnZTogJ1BhZ2Ugc2l6ZSBpcyBub3QgcGFzc2VkIHdpbGwgYmUgdXNlZCBjdXJyZW50IHZhbHVlJyxcbiAgICAgICAgY3VycmVudFBhZ2VTaXplOiB0aGlzLnBhZ2VTaXplXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBtYXhQYWdlTnVtYmVyID0gKHRoaXMudG90YWxFbGVtZW50cyAvIHBhcmFtcy5wYWdlUGFyYW1zLnNpemUpO1xuICAgIGlmIChwYXJhbXMucGFnZVBhcmFtcy5wYWdlID4gbWF4UGFnZU51bWJlcikge1xuICAgICAgY29uc3QgZXJyTXNnID0gYEVycm9yIHBhZ2UgbnVtYmVyLiBNYXggcGFnZSBudW1iZXIgaXMgJHsgcGFyc2VJbnQobWF4UGFnZU51bWJlciArICcnLCAxMCkgfWA7XG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUVycm9yTG9nKFN0YWdlLlBSRVBBUkVfUEFSQU1TLCB7ZXJyb3I6IGVyck1zZ30pO1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVUaHJvd0Vycm9yKGVyck1zZyk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWVzdFVybCA9IG5ldyBVUkwodGhpcy5zZWxmTGluay5ocmVmKTtcbiAgICByZXF1ZXN0VXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3BhZ2UnKTtcbiAgICByZXF1ZXN0VXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3NpemUnKTtcbiAgICByZXF1ZXN0VXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3NvcnQnKTtcbiAgICByZXR1cm4gZG9SZXF1ZXN0PFQ+KHJlcXVlc3RVcmwuaHJlZiwgb3B0aW9ucz8udXNlQ2FjaGUsIHBhcmFtcykucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlRW5kTG9nKHRoaXMucmVzb3VyY2VzWzBdLCAnQ3VzdG9tUGFnZScsIHtyZXN1bHQ6ICdjdXN0b20gcGFnZSB3YXMgcGVyZm9ybWVkIHN1Y2Nlc3NmdWwnfSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxufVxuXG5mdW5jdGlvbiBkb1JlcXVlc3Q8VCBleHRlbmRzIEJhc2VSZXNvdXJjZT4odXJsOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlQ2FjaGU6IGJvb2xlYW4gPSB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcz86IFNvcnRlZFBhZ2VQYXJhbSk6IE9ic2VydmFibGU8UGFnZWRSZXNvdXJjZUNvbGxlY3Rpb248VD4+IHtcbiAgVmFsaWRhdGlvblV0aWxzLnZhbGlkYXRlSW5wdXRQYXJhbXMoe3VybH0pO1xuXG4gIHJldHVybiBnZXRQYWdlZFJlc291cmNlQ29sbGVjdGlvbkh0dHBTZXJ2aWNlKClcbiAgICAuZ2V0KHVybCwgey4uLnBhcmFtcywgdXNlQ2FjaGV9KSBhcyBPYnNlcnZhYmxlPFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQ+Pjtcbn1cbiJdfQ==