import { BaseResource } from './base-resource';
import { getResourceHttpService } from '../../service/internal/resource-http.service';
import { HttpHeaders } from '@angular/common/http';
import { ResourceUtils } from '../../util/resource.utils';
import { UrlUtils } from '../../util/url.utils';
import { tap } from 'rxjs/operators';
import { Stage } from '../../logger/stage.enum';
import { StageLogger } from '../../logger/stage-logger';
import { ValidationUtils } from '../../util/validation.utils';
import { isArray, isNil, last, split } from 'lodash-es';
/**
 * Resource class.
 * Should be extended by client model classes that represent entity objects.
 *
 * If you have an embedded entity then consider to use the {@link EmbeddedResource} class.
 */
// tslint:disable:variable-name
// tslint:disable:no-string-literal
export class Resource extends BaseResource {
    /**
     * Adding passed entities to the resource collection behind the relation name.
     * Used POST method with 'Content-Type': 'text/uri-list'.
     *
     * This method DOES NOT REPLACE existing resources in the collection instead it adds new ones.
     * To replace collection resource with passed entities use {@link bindRelation} method.
     *
     * @param relationName used to get the specific resource relation link to the resource collection
     * @param entities one or more entities that should be added to the resource collection
     * @throws error when required params are not valid or link not found by relation name
     */
    addCollectionRelation(relationName, entities) {
        StageLogger.resourceBeginLog(this, 'ADD_COLLECTION_RELATION', { relationName, resourceLinks: this._links, entities });
        ValidationUtils.validateInputParams({ relationName, entities });
        const relationLink = this.getRelationLink(relationName);
        const body = entities
            .map(entity => {
            return ResourceUtils.initResource(entity).getSelfLinkHref();
        })
            .join('\n');
        return getResourceHttpService().post(UrlUtils.generateLinkUrl(relationLink), body, {
            observe: 'response',
            headers: new HttpHeaders({ 'Content-Type': 'text/uri-list' })
        }).pipe(tap(() => {
            StageLogger.resourceEndLog(this, 'ADD_COLLECTION_RELATION', { result: `collection relation ${relationName} was updated successfully` });
        }));
    }
    /**
     * Bounding the passed entity or collection of entities to this resource by the relation name.
     * Used PUT method with 'Content-Type': 'text/uri-list'.
     *
     * This method also REPLACED existing resources in the collection by passed entities.
     * To add entities to collection resource use {@link addCollectionRelation} method.
     *
     * @param relationName with which will be associated passed entity to this resource
     * @param entities one or more entities that should be bind to this resource
     * @throws error when required params are not valid or link not found by relation name
     */
    bindRelation(relationName, entities) {
        StageLogger.resourceBeginLog(this, 'BIND_RELATION', { relationName, resourceLinks: this._links, entities });
        ValidationUtils.validateInputParams({ relationName, entities });
        const relationLink = this.getRelationLink(relationName);
        let body;
        if (isArray(entities)) {
            body = entities
                .map(entity => {
                return ResourceUtils.initResource(entity).getSelfLinkHref();
            })
                .join('\n');
        }
        else {
            body = ResourceUtils.initResource(entities).getSelfLinkHref();
        }
        return getResourceHttpService().put(UrlUtils.generateLinkUrl(relationLink), body, {
            observe: 'response',
            headers: new HttpHeaders({ 'Content-Type': 'text/uri-list' })
        }).pipe(tap(() => {
            StageLogger.resourceEndLog(this, 'BIND_RELATION', { result: `relation ${relationName} was bound successfully` });
        }));
    }
    /**
     * Unbinding single resource relation behind resource name.
     * Used DELETE method to relation resource link URL.
     *
     * This method DOES NOT WORK WITH COLLECTION RESOURCE relations.
     * To clear collection resource relation use {@link unbindCollectionRelation} method.
     * To delete one resource from resource collection use {@link deleteRelation} method.
     *
     * @param relationName resource relation name to unbind
     */
    unbindRelation(relationName) {
        StageLogger.resourceBeginLog(this, 'UNBIND_RELATION', { relationName, resourceLinks: this._links });
        ValidationUtils.validateInputParams({ relationName });
        const relationLink = this.getRelationLink(relationName);
        return getResourceHttpService().delete(UrlUtils.generateLinkUrl(relationLink), {
            observe: 'response',
        }).pipe(tap(() => {
            StageLogger.resourceEndLog(this, 'UNBIND_RELATION', { result: `relation ${relationName} was unbound successfully` });
        }));
    }
    /**
     * Unbind all resources from collection by the relation name.
     * Used PUT method with 'Content-Type': 'text/uri-list' and EMPTY body to clear relations.
     *
     * To delete one resource from collection use {@link deleteRelation} method.
     * To delete single resource relations use {@link unbindRelation} or {@link deleteRelation} methods.
     *
     * @param relationName used to get relation link to unbind
     * @throws error when required params are not valid or link not found by relation name
     */
    unbindCollectionRelation(relationName) {
        StageLogger.resourceBeginLog(this, 'UNBIND_COLLECTION_RELATION', { relationName, resourceLinks: this._links });
        ValidationUtils.validateInputParams({ relationName });
        const relationLink = this.getRelationLink(relationName);
        return getResourceHttpService().put(UrlUtils.generateLinkUrl(relationLink), '', {
            observe: 'response',
            headers: new HttpHeaders({ 'Content-Type': 'text/uri-list' })
        }).pipe(tap(() => {
            StageLogger.resourceEndLog(this, 'UNBIND_COLLECTION_RELATION', { result: `relation ${relationName} was unbound successfully` });
        }));
    }
    /**
     * Deleting resource relation.
     * For collection, means that only passed entity will be unbound from the collection.
     * For single resource, deleting relation the same as @{link unbindRelation} method.
     *
     * To delete all resource relations from collection use {@link unbindCollectionRelation} method.
     *
     * @param relationName used to get relation link to unbind
     * @param entity that should be unbind from this relation
     * @throws error when required params are not valid or link not found by relation name
     */
    deleteRelation(relationName, entity) {
        StageLogger.resourceBeginLog(this, 'DELETE_RELATION', { relationName, resourceLinks: this._links, entity });
        ValidationUtils.validateInputParams({ relationName, entity });
        const relationLink = this.getRelationLink(relationName);
        const resource = ResourceUtils.initResource(entity);
        const resourceId = last(split(UrlUtils.generateLinkUrl(resource._links.self), '/'));
        if (isNil(resourceId) || resourceId === '') {
            StageLogger.stageErrorLog(Stage.PREPARE_URL, {
                step: 'ResolveResourceId',
                error: 'Passed resource self link should has id',
                selfLink: UrlUtils.generateLinkUrl(resource._links.self)
            });
            throw Error('Passed resource self link should has id');
        }
        StageLogger.stageLog(Stage.PREPARE_URL, {
            step: 'ResolveResourceId',
            result: resourceId
        });
        return getResourceHttpService().delete(UrlUtils.generateLinkUrl(relationLink) + '/' + resourceId, {
            observe: 'response'
        }).pipe(tap(() => {
            StageLogger.resourceEndLog(this, 'DELETE_RELATION', { result: `relation ${relationName} was deleted successfully` });
        }));
    }
    getSelfLinkHref() {
        return this._links.self.href;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaGF0ZW9hcy1jbGllbnQvc3JjL2xpYi9tb2RlbC9yZXNvdXJjZS9yZXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sOENBQThDLENBQUM7QUFDdEYsT0FBTyxFQUFFLFdBQVcsRUFBZ0IsTUFBTSxzQkFBc0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRWhELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXhEOzs7OztHQUtHO0FBQ0gsK0JBQStCO0FBQy9CLG1DQUFtQztBQUNuQyxNQUFNLE9BQU8sUUFBUyxTQUFRLFlBQVk7SUFVeEM7Ozs7Ozs7Ozs7T0FVRztJQUNJLHFCQUFxQixDQUFxQixZQUFvQixFQUFFLFFBQWtCO1FBQ3ZGLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUseUJBQXlCLEVBQUUsRUFBQyxZQUFZLEVBQUUsYUFBYSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQztRQUNwSCxlQUFlLENBQUMsbUJBQW1CLENBQUMsRUFB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LElBQUksQ0FDTCxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ1AsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsRUFBQyxNQUFNLEVBQUUsWUFBYSxZQUFhLDJCQUEyQixFQUFDLENBQUMsQ0FBQztRQUN2SCxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVNLGVBQWU7UUFDcEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDL0IsQ0FBQztDQUVGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZVJlc291cmNlIH0gZnJvbSAnLi9iYXNlLXJlc291cmNlJztcbmltcG9ydCB7IGdldFJlc291cmNlSHR0cFNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlL2ludGVybmFsL3Jlc291cmNlLWh0dHAuc2VydmljZSc7XG5pbXBvcnQgeyBIdHRwSGVhZGVycywgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUmVzb3VyY2VVdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvcmVzb3VyY2UudXRpbHMnO1xuaW1wb3J0IHsgVXJsVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3VybC51dGlscyc7XG5pbXBvcnQgeyBMaW5rRGF0YSB9IGZyb20gJy4uL2RlY2xhcmF0aW9ucyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uLy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcbmltcG9ydCB7IFN0YWdlTG9nZ2VyIH0gZnJvbSAnLi4vLi4vbG9nZ2VyL3N0YWdlLWxvZ2dlcic7XG5pbXBvcnQgeyBWYWxpZGF0aW9uVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb24udXRpbHMnO1xuaW1wb3J0IHsgaXNBcnJheSwgaXNOaWwsIGxhc3QsIHNwbGl0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuLyoqXG4gKiBSZXNvdXJjZSBjbGFzcy5cbiAqIFNob3VsZCBiZSBleHRlbmRlZCBieSBjbGllbnQgbW9kZWwgY2xhc3NlcyB0aGF0IHJlcHJlc2VudCBlbnRpdHkgb2JqZWN0cy5cbiAqXG4gKiBJZiB5b3UgaGF2ZSBhbiBlbWJlZGRlZCBlbnRpdHkgdGhlbiBjb25zaWRlciB0byB1c2UgdGhlIHtAbGluayBFbWJlZGRlZFJlc291cmNlfSBjbGFzcy5cbiAqL1xuLy8gdHNsaW50OmRpc2FibGU6dmFyaWFibGUtbmFtZVxuLy8gdHNsaW50OmRpc2FibGU6bm8tc3RyaW5nLWxpdGVyYWxcbmV4cG9ydCBjbGFzcyBSZXNvdXJjZSBleHRlbmRzIEJhc2VSZXNvdXJjZSB7XG5cbiAgLyoqXG4gICAqIFJlc291cmNlIHNob3VsZCBoYXMgc2VsZiBsaW5rLlxuICAgKi9cbiAgcHJvdGVjdGVkIF9saW5rczoge1xuICAgIHNlbGY6IExpbmtEYXRhO1xuICAgIFtrZXk6IHN0cmluZ106IExpbmtEYXRhO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRpbmcgcGFzc2VkIGVudGl0aWVzIHRvIHRoZSByZXNvdXJjZSBjb2xsZWN0aW9uIGJlaGluZCB0aGUgcmVsYXRpb24gbmFtZS5cbiAgICogVXNlZCBQT1NUIG1ldGhvZCB3aXRoICdDb250ZW50LVR5cGUnOiAndGV4dC91cmktbGlzdCcuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIERPRVMgTk9UIFJFUExBQ0UgZXhpc3RpbmcgcmVzb3VyY2VzIGluIHRoZSBjb2xsZWN0aW9uIGluc3RlYWQgaXQgYWRkcyBuZXcgb25lcy5cbiAgICogVG8gcmVwbGFjZSBjb2xsZWN0aW9uIHJlc291cmNlIHdpdGggcGFzc2VkIGVudGl0aWVzIHVzZSB7QGxpbmsgYmluZFJlbGF0aW9ufSBtZXRob2QuXG4gICAqXG4gICAqIEBwYXJhbSByZWxhdGlvbk5hbWUgdXNlZCB0byBnZXQgdGhlIHNwZWNpZmljIHJlc291cmNlIHJlbGF0aW9uIGxpbmsgdG8gdGhlIHJlc291cmNlIGNvbGxlY3Rpb25cbiAgICogQHBhcmFtIGVudGl0aWVzIG9uZSBvciBtb3JlIGVudGl0aWVzIHRoYXQgc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSByZXNvdXJjZSBjb2xsZWN0aW9uXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZCBvciBsaW5rIG5vdCBmb3VuZCBieSByZWxhdGlvbiBuYW1lXG4gICAqL1xuICBwdWJsaWMgYWRkQ29sbGVjdGlvblJlbGF0aW9uPFQgZXh0ZW5kcyBSZXNvdXJjZT4ocmVsYXRpb25OYW1lOiBzdHJpbmcsIGVudGl0aWVzOiBBcnJheTxUPik6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPGFueT4+IHtcbiAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUJlZ2luTG9nKHRoaXMsICdBRERfQ09MTEVDVElPTl9SRUxBVElPTicsIHtyZWxhdGlvbk5hbWUsIHJlc291cmNlTGlua3M6IHRoaXMuX2xpbmtzLCBlbnRpdGllc30pO1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtyZWxhdGlvbk5hbWUsIGVudGl0aWVzfSk7XG5cbiAgICBjb25zdCByZWxhdGlvbkxpbmsgPSB0aGlzLmdldFJlbGF0aW9uTGluayhyZWxhdGlvbk5hbWUpO1xuXG4gICAgY29uc3QgYm9keSA9IGVudGl0aWVzXG4gICAgICAubWFwKGVudGl0eSA9PiB7XG4gICAgICAgIHJldHVybiBSZXNvdXJjZVV0aWxzLmluaXRSZXNvdXJjZShlbnRpdHkpLmdldFNlbGZMaW5rSHJlZigpO1xuICAgICAgfSlcbiAgICAgIC5qb2luKCdcXG4nKTtcblxuICAgIHJldHVybiBnZXRSZXNvdXJjZUh0dHBTZXJ2aWNlKCkucG9zdChVcmxVdGlscy5nZW5lcmF0ZUxpbmtVcmwocmVsYXRpb25MaW5rKSwgYm9keSwge1xuICAgICAgb2JzZXJ2ZTogJ3Jlc3BvbnNlJyxcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7J0NvbnRlbnQtVHlwZSc6ICd0ZXh0L3VyaS1saXN0J30pXG4gICAgfSkucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlRW5kTG9nKHRoaXMsICdBRERfQ09MTEVDVElPTl9SRUxBVElPTicsXG4gICAgICAgICAge3Jlc3VsdDogYGNvbGxlY3Rpb24gcmVsYXRpb24gJHsgcmVsYXRpb25OYW1lIH0gd2FzIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5YH0pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEJvdW5kaW5nIHRoZSBwYXNzZWQgZW50aXR5IG9yIGNvbGxlY3Rpb24gb2YgZW50aXRpZXMgdG8gdGhpcyByZXNvdXJjZSBieSB0aGUgcmVsYXRpb24gbmFtZS5cbiAgICogVXNlZCBQVVQgbWV0aG9kIHdpdGggJ0NvbnRlbnQtVHlwZSc6ICd0ZXh0L3VyaS1saXN0Jy5cbiAgICpcbiAgICogVGhpcyBtZXRob2QgYWxzbyBSRVBMQUNFRCBleGlzdGluZyByZXNvdXJjZXMgaW4gdGhlIGNvbGxlY3Rpb24gYnkgcGFzc2VkIGVudGl0aWVzLlxuICAgKiBUbyBhZGQgZW50aXRpZXMgdG8gY29sbGVjdGlvbiByZXNvdXJjZSB1c2Uge0BsaW5rIGFkZENvbGxlY3Rpb25SZWxhdGlvbn0gbWV0aG9kLlxuICAgKlxuICAgKiBAcGFyYW0gcmVsYXRpb25OYW1lIHdpdGggd2hpY2ggd2lsbCBiZSBhc3NvY2lhdGVkIHBhc3NlZCBlbnRpdHkgdG8gdGhpcyByZXNvdXJjZVxuICAgKiBAcGFyYW0gZW50aXRpZXMgb25lIG9yIG1vcmUgZW50aXRpZXMgdGhhdCBzaG91bGQgYmUgYmluZCB0byB0aGlzIHJlc291cmNlXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZCBvciBsaW5rIG5vdCBmb3VuZCBieSByZWxhdGlvbiBuYW1lXG4gICAqL1xuICBwdWJsaWMgYmluZFJlbGF0aW9uPFQgZXh0ZW5kcyBSZXNvdXJjZT4ocmVsYXRpb25OYW1lOiBzdHJpbmcsIGVudGl0aWVzOiBUIHwgQXJyYXk8VD4pOiBPYnNlcnZhYmxlPEh0dHBSZXNwb25zZTxhbnk+PiB7XG4gICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VCZWdpbkxvZyh0aGlzLCAnQklORF9SRUxBVElPTicsIHtyZWxhdGlvbk5hbWUsIHJlc291cmNlTGlua3M6IHRoaXMuX2xpbmtzLCBlbnRpdGllc30pO1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtyZWxhdGlvbk5hbWUsIGVudGl0aWVzfSk7XG5cbiAgICBjb25zdCByZWxhdGlvbkxpbmsgPSB0aGlzLmdldFJlbGF0aW9uTGluayhyZWxhdGlvbk5hbWUpO1xuICAgIGxldCBib2R5O1xuICAgIGlmIChpc0FycmF5KGVudGl0aWVzKSkge1xuICAgICAgYm9keSA9IGVudGl0aWVzXG4gICAgICAgIC5tYXAoZW50aXR5ID0+IHtcbiAgICAgICAgICByZXR1cm4gUmVzb3VyY2VVdGlscy5pbml0UmVzb3VyY2UoZW50aXR5KS5nZXRTZWxmTGlua0hyZWYoKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJ1xcbicpO1xuICAgIH0gZWxzZSB7XG4gICAgICBib2R5ID0gUmVzb3VyY2VVdGlscy5pbml0UmVzb3VyY2UoZW50aXRpZXMpLmdldFNlbGZMaW5rSHJlZigpO1xuICAgIH1cblxuICAgIHJldHVybiBnZXRSZXNvdXJjZUh0dHBTZXJ2aWNlKCkucHV0KFVybFV0aWxzLmdlbmVyYXRlTGlua1VybChyZWxhdGlvbkxpbmspLCBib2R5LCB7XG4gICAgICBvYnNlcnZlOiAncmVzcG9uc2UnLFxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsnQ29udGVudC1UeXBlJzogJ3RleHQvdXJpLWxpc3QnfSlcbiAgICB9KS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VFbmRMb2codGhpcywgJ0JJTkRfUkVMQVRJT04nLCB7cmVzdWx0OiBgcmVsYXRpb24gJHsgcmVsYXRpb25OYW1lIH0gd2FzIGJvdW5kIHN1Y2Nlc3NmdWxseWB9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbmJpbmRpbmcgc2luZ2xlIHJlc291cmNlIHJlbGF0aW9uIGJlaGluZCByZXNvdXJjZSBuYW1lLlxuICAgKiBVc2VkIERFTEVURSBtZXRob2QgdG8gcmVsYXRpb24gcmVzb3VyY2UgbGluayBVUkwuXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIERPRVMgTk9UIFdPUksgV0lUSCBDT0xMRUNUSU9OIFJFU09VUkNFIHJlbGF0aW9ucy5cbiAgICogVG8gY2xlYXIgY29sbGVjdGlvbiByZXNvdXJjZSByZWxhdGlvbiB1c2Uge0BsaW5rIHVuYmluZENvbGxlY3Rpb25SZWxhdGlvbn0gbWV0aG9kLlxuICAgKiBUbyBkZWxldGUgb25lIHJlc291cmNlIGZyb20gcmVzb3VyY2UgY29sbGVjdGlvbiB1c2Uge0BsaW5rIGRlbGV0ZVJlbGF0aW9ufSBtZXRob2QuXG4gICAqXG4gICAqIEBwYXJhbSByZWxhdGlvbk5hbWUgcmVzb3VyY2UgcmVsYXRpb24gbmFtZSB0byB1bmJpbmRcbiAgICovXG4gIHB1YmxpYyB1bmJpbmRSZWxhdGlvbjxUIGV4dGVuZHMgUmVzb3VyY2U+KHJlbGF0aW9uTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8YW55Pj4ge1xuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcywgJ1VOQklORF9SRUxBVElPTicsIHtyZWxhdGlvbk5hbWUsIHJlc291cmNlTGlua3M6IHRoaXMuX2xpbmtzfSk7XG4gICAgVmFsaWRhdGlvblV0aWxzLnZhbGlkYXRlSW5wdXRQYXJhbXMoe3JlbGF0aW9uTmFtZX0pO1xuXG4gICAgY29uc3QgcmVsYXRpb25MaW5rID0gdGhpcy5nZXRSZWxhdGlvbkxpbmsocmVsYXRpb25OYW1lKTtcblxuICAgIHJldHVybiBnZXRSZXNvdXJjZUh0dHBTZXJ2aWNlKCkuZGVsZXRlKFVybFV0aWxzLmdlbmVyYXRlTGlua1VybChyZWxhdGlvbkxpbmspLCB7XG4gICAgICBvYnNlcnZlOiAncmVzcG9uc2UnLFxuICAgIH0pLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICBTdGFnZUxvZ2dlci5yZXNvdXJjZUVuZExvZyh0aGlzLCAnVU5CSU5EX1JFTEFUSU9OJywge3Jlc3VsdDogYHJlbGF0aW9uICR7IHJlbGF0aW9uTmFtZSB9IHdhcyB1bmJvdW5kIHN1Y2Nlc3NmdWxseWB9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVbmJpbmQgYWxsIHJlc291cmNlcyBmcm9tIGNvbGxlY3Rpb24gYnkgdGhlIHJlbGF0aW9uIG5hbWUuXG4gICAqIFVzZWQgUFVUIG1ldGhvZCB3aXRoICdDb250ZW50LVR5cGUnOiAndGV4dC91cmktbGlzdCcgYW5kIEVNUFRZIGJvZHkgdG8gY2xlYXIgcmVsYXRpb25zLlxuICAgKlxuICAgKiBUbyBkZWxldGUgb25lIHJlc291cmNlIGZyb20gY29sbGVjdGlvbiB1c2Uge0BsaW5rIGRlbGV0ZVJlbGF0aW9ufSBtZXRob2QuXG4gICAqIFRvIGRlbGV0ZSBzaW5nbGUgcmVzb3VyY2UgcmVsYXRpb25zIHVzZSB7QGxpbmsgdW5iaW5kUmVsYXRpb259IG9yIHtAbGluayBkZWxldGVSZWxhdGlvbn0gbWV0aG9kcy5cbiAgICpcbiAgICogQHBhcmFtIHJlbGF0aW9uTmFtZSB1c2VkIHRvIGdldCByZWxhdGlvbiBsaW5rIHRvIHVuYmluZFxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWQgb3IgbGluayBub3QgZm91bmQgYnkgcmVsYXRpb24gbmFtZVxuICAgKi9cbiAgcHVibGljIHVuYmluZENvbGxlY3Rpb25SZWxhdGlvbjxUIGV4dGVuZHMgUmVzb3VyY2U+KHJlbGF0aW9uTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8YW55Pj4ge1xuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcywgJ1VOQklORF9DT0xMRUNUSU9OX1JFTEFUSU9OJywge3JlbGF0aW9uTmFtZSwgcmVzb3VyY2VMaW5rczogdGhpcy5fbGlua3N9KTtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVsYXRpb25OYW1lfSk7XG5cbiAgICBjb25zdCByZWxhdGlvbkxpbmsgPSB0aGlzLmdldFJlbGF0aW9uTGluayhyZWxhdGlvbk5hbWUpO1xuXG4gICAgcmV0dXJuIGdldFJlc291cmNlSHR0cFNlcnZpY2UoKS5wdXQoVXJsVXRpbHMuZ2VuZXJhdGVMaW5rVXJsKHJlbGF0aW9uTGluayksICcnLCB7XG4gICAgICBvYnNlcnZlOiAncmVzcG9uc2UnLFxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsnQ29udGVudC1UeXBlJzogJ3RleHQvdXJpLWxpc3QnfSlcbiAgICB9KS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VFbmRMb2codGhpcywgJ1VOQklORF9DT0xMRUNUSU9OX1JFTEFUSU9OJywge3Jlc3VsdDogYHJlbGF0aW9uICR7IHJlbGF0aW9uTmFtZSB9IHdhcyB1bmJvdW5kIHN1Y2Nlc3NmdWxseWB9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGluZyByZXNvdXJjZSByZWxhdGlvbi5cbiAgICogRm9yIGNvbGxlY3Rpb24sIG1lYW5zIHRoYXQgb25seSBwYXNzZWQgZW50aXR5IHdpbGwgYmUgdW5ib3VuZCBmcm9tIHRoZSBjb2xsZWN0aW9uLlxuICAgKiBGb3Igc2luZ2xlIHJlc291cmNlLCBkZWxldGluZyByZWxhdGlvbiB0aGUgc2FtZSBhcyBAe2xpbmsgdW5iaW5kUmVsYXRpb259IG1ldGhvZC5cbiAgICpcbiAgICogVG8gZGVsZXRlIGFsbCByZXNvdXJjZSByZWxhdGlvbnMgZnJvbSBjb2xsZWN0aW9uIHVzZSB7QGxpbmsgdW5iaW5kQ29sbGVjdGlvblJlbGF0aW9ufSBtZXRob2QuXG4gICAqXG4gICAqIEBwYXJhbSByZWxhdGlvbk5hbWUgdXNlZCB0byBnZXQgcmVsYXRpb24gbGluayB0byB1bmJpbmRcbiAgICogQHBhcmFtIGVudGl0eSB0aGF0IHNob3VsZCBiZSB1bmJpbmQgZnJvbSB0aGlzIHJlbGF0aW9uXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZCBvciBsaW5rIG5vdCBmb3VuZCBieSByZWxhdGlvbiBuYW1lXG4gICAqL1xuICBwdWJsaWMgZGVsZXRlUmVsYXRpb248VCBleHRlbmRzIFJlc291cmNlPihyZWxhdGlvbk5hbWU6IHN0cmluZywgZW50aXR5OiBUKTogT2JzZXJ2YWJsZTxIdHRwUmVzcG9uc2U8YW55Pj4ge1xuICAgIFN0YWdlTG9nZ2VyLnJlc291cmNlQmVnaW5Mb2codGhpcywgJ0RFTEVURV9SRUxBVElPTicsIHtyZWxhdGlvbk5hbWUsIHJlc291cmNlTGlua3M6IHRoaXMuX2xpbmtzLCBlbnRpdHl9KTtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVsYXRpb25OYW1lLCBlbnRpdHl9KTtcblxuICAgIGNvbnN0IHJlbGF0aW9uTGluayA9IHRoaXMuZ2V0UmVsYXRpb25MaW5rKHJlbGF0aW9uTmFtZSk7XG4gICAgY29uc3QgcmVzb3VyY2UgPSBSZXNvdXJjZVV0aWxzLmluaXRSZXNvdXJjZShlbnRpdHkpIGFzIFJlc291cmNlO1xuICAgIGNvbnN0IHJlc291cmNlSWQgPSBsYXN0KHNwbGl0KFVybFV0aWxzLmdlbmVyYXRlTGlua1VybChyZXNvdXJjZS5fbGlua3Muc2VsZiksICcvJykpO1xuXG4gICAgaWYgKGlzTmlsKHJlc291cmNlSWQpIHx8IHJlc291cmNlSWQgPT09ICcnKSB7XG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUVycm9yTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICAgIHN0ZXA6ICdSZXNvbHZlUmVzb3VyY2VJZCcsXG4gICAgICAgIGVycm9yOiAnUGFzc2VkIHJlc291cmNlIHNlbGYgbGluayBzaG91bGQgaGFzIGlkJyxcbiAgICAgICAgc2VsZkxpbms6IFVybFV0aWxzLmdlbmVyYXRlTGlua1VybChyZXNvdXJjZS5fbGlua3Muc2VsZilcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgRXJyb3IoJ1Bhc3NlZCByZXNvdXJjZSBzZWxmIGxpbmsgc2hvdWxkIGhhcyBpZCcpO1xuICAgIH1cblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICBzdGVwOiAnUmVzb2x2ZVJlc291cmNlSWQnLFxuICAgICAgcmVzdWx0OiByZXNvdXJjZUlkXG4gICAgfSk7XG5cbiAgICByZXR1cm4gZ2V0UmVzb3VyY2VIdHRwU2VydmljZSgpLmRlbGV0ZShVcmxVdGlscy5nZW5lcmF0ZUxpbmtVcmwocmVsYXRpb25MaW5rKSArICcvJyArIHJlc291cmNlSWQsIHtcbiAgICAgIG9ic2VydmU6ICdyZXNwb25zZSdcbiAgICB9KS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgU3RhZ2VMb2dnZXIucmVzb3VyY2VFbmRMb2codGhpcywgJ0RFTEVURV9SRUxBVElPTicsIHtyZXN1bHQ6IGByZWxhdGlvbiAkeyByZWxhdGlvbk5hbWUgfSB3YXMgZGVsZXRlZCBzdWNjZXNzZnVsbHlgfSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2VsZkxpbmtIcmVmKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2xpbmtzLnNlbGYuaHJlZjtcbiAgfVxuXG59XG4iXX0=