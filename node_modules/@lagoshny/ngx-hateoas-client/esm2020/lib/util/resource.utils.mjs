import { isEmbeddedResource, isResource } from '../model/resource-type';
import { Include } from '../model/declarations';
import { UrlUtils } from './url.utils';
import { Stage } from '../logger/stage.enum';
import { StageLogger } from '../logger/stage-logger';
import { isArray, isEmpty, isNil, isObject, isPlainObject } from 'lodash-es';
import { ConsoleLogger } from '../logger/console-logger';
import { LibConfig } from '../config/lib-config';
import { isMatch, parse } from 'date-fns';
/* tslint:disable:no-string-literal */
export class ResourceUtils {
    static useResourceType(type) {
        this.resourceType = type;
    }
    static useResourceCollectionType(type) {
        this.resourceCollectionType = type;
    }
    static usePagedResourceCollectionType(type) {
        this.pagedResourceCollectionType = type;
    }
    static useEmbeddedResourceType(type) {
        this.embeddedResourceType = type;
    }
    static instantiateResource(payload, isProjection) {
        // @ts-ignore
        if (isEmpty(payload)
            || (!isObject(payload['_links']) || isEmpty(payload['_links']))) {
            ConsoleLogger.warn('Incorrect resource object! Returned \'null\' value, because it has not \'_links\' array. Check that server send right resource object.', { incorrectResource: payload });
            return null;
        }
        return this.createResource(this.resolvePayloadProperties(payload, isProjection), isProjection);
    }
    static resolvePayloadProperties(payload, isProjection) {
        for (const key of Object.keys(payload)) {
            if (key === 'hibernateLazyInitializer') {
                delete payload[key];
                continue;
            }
            if (key === '_links') {
                payload[key] = payload[key];
                continue;
            }
            if (key === '_embedded' && isObject(payload[key])) {
                payload = {
                    ...payload,
                    ...this.resolvePayloadProperties(payload[key], isProjection)
                };
                delete payload['_embedded'];
                continue;
            }
            if (LibConfig.getConfig()?.typesFormat?.date?.patterns && !isEmpty(LibConfig.getConfig().typesFormat.date.patterns)) {
                for (const pattern of LibConfig.getConfig().typesFormat.date.patterns) {
                    if (isMatch(payload[key], pattern)) {
                        const valueAsDate = parse(payload[key], pattern, new Date());
                        if (valueAsDate) {
                            payload[key] = valueAsDate;
                            break;
                        }
                    }
                }
                if (payload[key] instanceof Date) {
                    continue;
                }
            }
            payload[key] = this.resolvePayloadType(key, payload[key], isProjection);
        }
        return payload;
    }
    static resolvePayloadType(key, payload, isProjection) {
        if (isNil(payload)) {
            return payload;
        }
        else if (isArray(payload)) {
            for (let i = 0; i < payload.length; i++) {
                payload[i] = this.resolvePayloadType(key, payload[i], isProjection);
            }
        }
        else if (isProjection && isPlainObject(payload)) {
            // Need to check resource projection relation props because some inner props can be objects that can be also resources
            payload = this.resolvePayloadProperties(this.createResourceProjectionRel(key, payload), isProjection);
        }
        else if (isEmbeddedResource(payload) || ResourceUtils.EMBEDDED_RESOURCE_TYPE_MAP.get(key)) {
            // Need to check embedded resource props because some inner props can be objects that can be also resources
            payload = this.resolvePayloadProperties(this.createEmbeddedResource(key, payload), isProjection);
        }
        else if (isResource(payload)) {
            // Need to check resource props because some inner props can be objects that can be also resources
            payload = this.resolvePayloadProperties(this.createResource(payload), isProjection);
        }
        return payload;
    }
    static createResource(payload, isProjection) {
        const resourceName = this.findResourceName(payload);
        let resourceClass;
        if (isProjection && !ResourceUtils.RESOURCE_NAME_PROJECTION_TYPE_MAP.get(resourceName)) {
            resourceClass = ResourceUtils.RESOURCE_NAME_TYPE_MAP.get(resourceName);
            ConsoleLogger.prettyWarn('Not found projection resource type when create resource projection: \'' + resourceName + '\' so used resource type: \'' + (resourceClass ? resourceClass?.name : ' default Resource') + '\'. \n\r' +
                'It can be when you pass projection param as http request directly instead use projection type with @HateoasProjection.\n\r' +
                '\n\rSee more how to use @HateoasProjection here https://github.com/lagoshny/ngx-hateoas-client#resource-projection-support.');
        }
        else {
            resourceClass = isProjection
                ? ResourceUtils.RESOURCE_NAME_PROJECTION_TYPE_MAP.get(resourceName)
                : ResourceUtils.RESOURCE_NAME_TYPE_MAP.get(resourceName);
        }
        if (resourceClass) {
            return Object.assign(new (resourceClass)(), payload);
        }
        else {
            ConsoleLogger.prettyWarn('Not found resource type when create resource: \'' + resourceName + '\' so used default Resource type, for this can be some reasons: \n\r' +
                '1) You did not pass resource property name as \'' + resourceName + '\' with @HateoasResource decorator. \n\r' +
                '2) You did not declare resource type in configuration "configuration.useTypes.resources". \n\r' +
                '\n\rSee more about declare resource types here: https://github.com/lagoshny/ngx-hateoas-client#usetypes-params..');
            return Object.assign(new this.resourceType(), payload);
        }
    }
    static createResourceProjectionRel(relationName, payload) {
        const relationClass = ResourceUtils.RESOURCE_PROJECTION_REL_NAME_TYPE_MAP.get(relationName);
        if (relationClass) {
            return Object.assign(new (relationClass)(), payload);
        }
        else {
            ConsoleLogger.prettyWarn('Not found resource relation type when create relation: \'' + relationName + '\' so used default Resource type, for this can be some reasons: \n\r' +
                'You did not pass relation type property with @ProjectionRel decorator on relation property \'' + relationName + '\'. \n\r' +
                '\n\rSee more how to use @ProjectionRel here https://github.com/lagoshny/ngx-hateoas-client#resource-projection-support.');
            return Object.assign(new this.resourceType(), payload);
        }
    }
    static createEmbeddedResource(key, payload) {
        const resourceClass = ResourceUtils.EMBEDDED_RESOURCE_TYPE_MAP.get(key);
        if (resourceClass) {
            return Object.assign(new (resourceClass)(), payload);
        }
        else {
            ConsoleLogger.prettyWarn('Not found embedded resource type when create resource: \'' + key + '\' so used default EmbeddedResource type, for this can be some reasons:. \n\r' +
                '1) You did not pass embedded resource property name as \'' + key + '\' with @HateoasEmbeddedResource decorator. \n\r' +
                '2) You did not declare embedded resource type in configuration "configuration.useTypes.embeddedResources". \n\r' +
                '\n\r See more about declare resource types here: https://github.com/lagoshny/ngx-hateoas-client#usetypes-params.');
            return Object.assign(new this.embeddedResourceType(), payload);
        }
    }
    static instantiateResourceCollection(payload, isProjection) {
        if (isEmpty(payload)
            || (!isObject(payload['_links']) || isEmpty(payload['_links']))
            || (!LibConfig.getConfig().halFormat.collections.embeddedOptional &&
                (!('_embedded' in payload) || !isObject(payload['_embedded']) || isEmpty(payload['_embedded'])))) {
            return null;
        }
        const result = new this.resourceCollectionType();
        if ('_embedded' in payload && isObject(payload['_embedded']) && !isEmpty(payload['_embedded'])) {
            for (const resourceName of Object.keys(payload['_embedded'])) {
                payload['_embedded'][resourceName].forEach((resource) => {
                    result.resources.push(this.instantiateResource(resource, isProjection));
                });
            }
        }
        result['_links'] = { ...payload['_links'] };
        return result;
    }
    static instantiatePagedResourceCollection(payload, isProjection) {
        const resourceCollection = this.instantiateResourceCollection(payload, isProjection);
        if (resourceCollection == null) {
            return null;
        }
        let result;
        if (payload['page']) {
            result = new this.pagedResourceCollectionType(resourceCollection, payload);
        }
        else {
            result = new this.pagedResourceCollectionType(resourceCollection);
        }
        return result;
    }
    /**
     * Resolve request body relations.
     * If request body has {@link Resource} value then this value will be replaced by resource self link.
     * If request body has {@link ValuesOption} it will be applied to body values.
     *
     * @param requestBody that contains the body directly and optional body values option {@link ValuesOption}
     */
    static resolveValues(requestBody) {
        if (isEmpty(requestBody) || isNil(requestBody.body)
            || (isObject(requestBody.body) && isEmpty(requestBody.body))) {
            StageLogger.stageLog(Stage.RESOLVE_VALUES, { result: 'body is empty return null' });
            return null;
        }
        const body = requestBody.body;
        if (!isObject(body) || isArray(body)) {
            StageLogger.stageLog(Stage.RESOLVE_VALUES, { result: 'body is not object or array return as is' });
            return body;
        }
        const result = {};
        for (const key in body) {
            if (!body.hasOwnProperty(key)) {
                continue;
            }
            if (body[key] == null && Include.NULL_VALUES === requestBody?.valuesOption?.include) {
                result[key] = null;
                continue;
            }
            if (isNil(body[key])) {
                continue;
            }
            if (isArray(body[key])) {
                const array = body[key];
                result[key] = [];
                array.forEach((element) => {
                    if (isResource(element)) {
                        result[key].push(element?._links?.self?.href);
                    }
                    else {
                        result[key].push(this.resolveValues({ body: element, valuesOption: requestBody?.valuesOption }));
                    }
                });
            }
            else if (isResource(body[key])) {
                result[key] = body[key]._links?.self?.href;
            }
            else if (isPlainObject(body[key])) {
                result[key] = this.resolveValues({ body: body[key], valuesOption: requestBody?.valuesOption });
            }
            else {
                result[key] = body[key];
            }
        }
        StageLogger.stageLog(Stage.RESOLVE_VALUES, { result });
        return result;
    }
    /**
     * Assign {@link Resource} or {@link EmbeddedResource} properties to passed entity.
     *
     * @param entity to be converter to resource
     */
    static initResource(entity) {
        if (isResource(entity)) {
            return Object.assign(new this.resourceType(), entity);
        }
        else if (isEmbeddedResource(entity)) {
            return Object.assign(new this.embeddedResourceType(), entity);
        }
        else {
            return entity;
        }
    }
    /**
     * Define resource name based on resource links.
     * It will get link name that href equals to self href resource link.
     *
     * @param payload that can be a resource for which to find the name
     */
    static findResourceName(payload) {
        if (!payload || !payload['_links'] || !payload['_links'].self) {
            return '';
        }
        const resourceLinks = payload['_links'];
        if (isEmpty(resourceLinks) || isEmpty(resourceLinks.self) || isNil(resourceLinks.self.href)) {
            return '';
        }
        return UrlUtils.getResourceNameFromUrl(UrlUtils.removeTemplateParams(resourceLinks.self.href));
    }
    /**
     * Checks is a resource projection or not.
     *
     * @param payload object that can be resource or resource projection
     */
    static isResourceProjection(payload) {
        if (!payload || !payload['_links'] || !payload['_links'].self) {
            return false;
        }
        const selfLink = payload['_links'].self;
        const resourceLinks = payload['_links'];
        for (const key of Object.keys(resourceLinks)) {
            if (key !== 'self' && resourceLinks[key].href.includes(selfLink.href)) {
                return new URL(resourceLinks[key].href).search.includes('projection');
            }
        }
        return false;
    }
    /**
     * Try to get projectionName from resource type and set it to options. If resourceType has not projectionName then return options as is.
     *
     * @param resourceType from get projectionName
     * @param options to set projectionName
     */
    static fillProjectionNameFromResourceType(resourceType, options) {
        if (!resourceType) {
            return;
        }
        const projectionName = resourceType['__projectionName__'];
        if (projectionName) {
            options = options ? options : { params: {} };
            options = {
                ...options,
                params: {
                    ...options.params,
                    projection: projectionName
                }
            };
        }
        return options;
    }
}
ResourceUtils.RESOURCE_NAME_TYPE_MAP = new Map();
ResourceUtils.RESOURCE_NAME_PROJECTION_TYPE_MAP = new Map();
ResourceUtils.RESOURCE_PROJECTION_REL_NAME_TYPE_MAP = new Map();
ResourceUtils.EMBEDDED_RESOURCE_TYPE_MAP = new Map();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UudXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaGF0ZW9hcy1jbGllbnQvc3JjL2xpYi91dGlsL3Jlc291cmNlLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUd4RSxPQUFPLEVBQWEsT0FBTyxFQUErQixNQUFNLHVCQUF1QixDQUFDO0FBR3hGLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDekQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRTFDLHNDQUFzQztBQUN0QyxNQUFNLE9BQU8sYUFBYTtJQWdCakIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUF3QjtRQUNwRCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztJQUMzQixDQUFDO0lBRU0sTUFBTSxDQUFDLHlCQUF5QixDQUFDLElBQStDO1FBQ3JGLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUM7SUFDckMsQ0FBQztJQUVNLE1BQU0sQ0FBQyw4QkFBOEIsQ0FBQyxJQUNIO1FBQ3hDLElBQUksQ0FBQywyQkFBMkIsR0FBRyxJQUFJLENBQUM7SUFDMUMsQ0FBQztJQUVNLE1BQU0sQ0FB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WSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUNELE1BQU0sY0FBYyxHQUFHLFlBQVksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQzFELElBQUksY0FBYyxFQUFFO1lBQ2xCLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBQyxNQUFNLEVBQUUsRUFBRSxFQUFDLENBQUM7WUFDM0MsT0FBTyxHQUFHO2dCQUNSLEdBQUcsT0FBTztnQkFDVixNQUFNLEVBQUU7b0JBQ04sR0FBRyxPQUFPLENBQUMsTUFBTTtvQkFDakIsVUFBVSxFQUFFLGNBQWM7aUJBQzNCO2FBQ0YsQ0FBQztTQUNIO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQzs7QUFyVWEsb0NBQXNCLEdBQXFCLElBQUksR0FBRyxFQUFlLENBQUM7QUFDbEUsK0NBQWlDLEdBQXFCLElBQUksR0FBRyxFQUFlLENBQUM7QUFDN0UsbURBQXFDLEdBQXFCLElBQUksR0FBRyxFQUFlLENBQUM7QUFDakYsd0NBQTBCLEdBQXFCLElBQUksR0FBRyxFQUFlLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlUmVzb3VyY2UgfSBmcm9tICcuLi9tb2RlbC9yZXNvdXJjZS9iYXNlLXJlc291cmNlJztcbmltcG9ydCB7IGlzRW1iZWRkZWRSZXNvdXJjZSwgaXNSZXNvdXJjZSB9IGZyb20gJy4uL21vZGVsL3Jlc291cmNlLXR5cGUnO1xuaW1wb3J0IHsgUmVzb3VyY2VDb2xsZWN0aW9uIH0gZnJvbSAnLi4vbW9kZWwvcmVzb3VyY2UvcmVzb3VyY2UtY29sbGVjdGlvbic7XG5pbXBvcnQgeyBQYWdlZFJlc291cmNlQ29sbGVjdGlvbiB9IGZyb20gJy4uL21vZGVsL3Jlc291cmNlL3BhZ2VkLXJlc291cmNlLWNvbGxlY3Rpb24nO1xuaW1wb3J0IHsgR2V0T3B0aW9uLCBJbmNsdWRlLCBMaW5rLCBQYWdlRGF0YSwgUmVxdWVzdEJvZHkgfSBmcm9tICcuLi9tb2RlbC9kZWNsYXJhdGlvbnMnO1xuaW1wb3J0IHsgUmVzb3VyY2UgfSBmcm9tICcuLi9tb2RlbC9yZXNvdXJjZS9yZXNvdXJjZSc7XG5pbXBvcnQgeyBFbWJlZGRlZFJlc291cmNlIH0gZnJvbSAnLi4vbW9kZWwvcmVzb3VyY2UvZW1iZWRkZWQtcmVzb3VyY2UnO1xuaW1wb3J0IHsgVXJsVXRpbHMgfSBmcm9tICcuL3VybC51dGlscyc7XG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcbmltcG9ydCB7IFN0YWdlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL3N0YWdlLWxvZ2dlcic7XG5pbXBvcnQgeyBpc0FycmF5LCBpc0VtcHR5LCBpc05pbCwgaXNPYmplY3QsIGlzUGxhaW5PYmplY3QgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQ29uc29sZUxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlci9jb25zb2xlLWxvZ2dlcic7XG5pbXBvcnQgeyBMaWJDb25maWcgfSBmcm9tICcuLi9jb25maWcvbGliLWNvbmZpZyc7XG5pbXBvcnQgeyBpc01hdGNoLCBwYXJzZSB9IGZyb20gJ2RhdGUtZm5zJztcblxuLyogdHNsaW50OmRpc2FibGU6bm8tc3RyaW5nLWxpdGVyYWwgKi9cbmV4cG9ydCBjbGFzcyBSZXNvdXJjZVV0aWxzIHtcblxuICBwdWJsaWMgc3RhdGljIFJFU09VUkNFX05BTUVfVFlQRV9NQVA6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuICBwdWJsaWMgc3RhdGljIFJFU09VUkNFX05BTUVfUFJPSkVDVElPTl9UWVBFX01BUDogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gIHB1YmxpYyBzdGF0aWMgUkVTT1VSQ0VfUFJPSkVDVElPTl9SRUxfTkFNRV9UWVBFX01BUDogTWFwPHN0cmluZywgYW55PiA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gIHB1YmxpYyBzdGF0aWMgRU1CRURERURfUkVTT1VSQ0VfVFlQRV9NQVA6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuXG4gIHByaXZhdGUgc3RhdGljIHJlc291cmNlVHlwZTogbmV3KCkgPT4gQmFzZVJlc291cmNlO1xuXG4gIHByaXZhdGUgc3RhdGljIHJlc291cmNlQ29sbGVjdGlvblR5cGU6IG5ldygpID0+IFJlc291cmNlQ29sbGVjdGlvbjxCYXNlUmVzb3VyY2U+O1xuXG4gIHByaXZhdGUgc3RhdGljIHBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uVHlwZTogbmV3KGNvbGxlY3Rpb246IFJlc291cmNlQ29sbGVjdGlvbjxCYXNlUmVzb3VyY2U+LCBwYWdlRGF0YT86IFBhZ2VEYXRhKVxuICAgID0+IFBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPEJhc2VSZXNvdXJjZT47XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZW1iZWRkZWRSZXNvdXJjZVR5cGU6IG5ldygpID0+IEVtYmVkZGVkUmVzb3VyY2U7XG5cbiAgcHVibGljIHN0YXRpYyB1c2VSZXNvdXJjZVR5cGUodHlwZTogbmV3ICgpID0+IFJlc291cmNlKSB7XG4gICAgdGhpcy5yZXNvdXJjZVR5cGUgPSB0eXBlO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyB1c2VSZXNvdXJjZUNvbGxlY3Rpb25UeXBlKHR5cGU6IG5ldygpID0+IFJlc291cmNlQ29sbGVjdGlvbjxCYXNlUmVzb3VyY2U+KSB7XG4gICAgdGhpcy5yZXNvdXJjZUNvbGxlY3Rpb25UeXBlID0gdHlwZTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgdXNlUGFnZWRSZXNvdXJjZUNvbGxlY3Rpb25UeXBlKHR5cGU6IG5ldyhjb2xsZWN0aW9uOiBSZXNvdXJjZUNvbGxlY3Rpb248QmFzZVJlc291cmNlPilcbiAgICA9PiBQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxCYXNlUmVzb3VyY2U+KSB7XG4gICAgdGhpcy5wYWdlZFJlc291cmNlQ29sbGVjdGlvblR5cGUgPSB0eXBlO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyB1c2VFbWJlZGRlZFJlc291cmNlVHlwZSh0eXBlOiBuZXcoKSA9PiBFbWJlZGRlZFJlc291cmNlKSB7XG4gICAgdGhpcy5lbWJlZGRlZFJlc291cmNlVHlwZSA9IHR5cGU7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGluc3RhbnRpYXRlUmVzb3VyY2U8VCBleHRlbmRzIEJhc2VSZXNvdXJjZT4ocGF5bG9hZDogb2JqZWN0LCBpc1Byb2plY3Rpb24/OiBib29sZWFuKTogVCB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGlmIChpc0VtcHR5KHBheWxvYWQpXG4gICAgICB8fCAoIWlzT2JqZWN0KHBheWxvYWRbJ19saW5rcyddKSB8fCBpc0VtcHR5KHBheWxvYWRbJ19saW5rcyddKSkpIHtcbiAgICAgIENvbnNvbGVMb2dnZXIud2FybignSW5jb3JyZWN0IHJlc291cmNlIG9iamVjdCEgUmV0dXJuZWQgXFwnbnVsbFxcJyB2YWx1ZSwgYmVjYXVzZSBpdCBoYXMgbm90IFxcJ19saW5rc1xcJyBhcnJheS4gQ2hlY2sgdGhhdCBzZXJ2ZXIgc2VuZCByaWdodCByZXNvdXJjZSBvYmplY3QuJywge2luY29ycmVjdFJlc291cmNlOiBwYXlsb2FkfSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5jcmVhdGVSZXNvdXJjZSh0aGlzLnJlc29sdmVQYXlsb2FkUHJvcGVydGllcyhwYXlsb2FkLCBpc1Byb2plY3Rpb24pLCBpc1Byb2plY3Rpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmVzb2x2ZVBheWxvYWRQcm9wZXJ0aWVzPFQgZXh0ZW5kcyBCYXNlUmVzb3VyY2U+KHBheWxvYWQ6IG9iamVjdCwgaXNQcm9qZWN0aW9uPzogYm9vbGVhbik6IG9iamVjdCB7XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMocGF5bG9hZCkpIHtcbiAgICAgIGlmIChrZXkgPT09ICdoaWJlcm5hdGVMYXp5SW5pdGlhbGl6ZXInKSB7XG4gICAgICAgIGRlbGV0ZSBwYXlsb2FkW2tleV07XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKGtleSA9PT0gJ19saW5rcycpIHtcbiAgICAgICAgcGF5bG9hZFtrZXldID0gcGF5bG9hZFtrZXldO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGtleSA9PT0gJ19lbWJlZGRlZCcgJiYgaXNPYmplY3QocGF5bG9hZFtrZXldKSkge1xuICAgICAgICBwYXlsb2FkID0ge1xuICAgICAgICAgIC4uLnBheWxvYWQsXG4gICAgICAgICAgLi4udGhpcy5yZXNvbHZlUGF5bG9hZFByb3BlcnRpZXMocGF5bG9hZFtrZXldLCBpc1Byb2plY3Rpb24pXG4gICAgICAgIH07XG4gICAgICAgIGRlbGV0ZSBwYXlsb2FkWydfZW1iZWRkZWQnXTtcblxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKExpYkNvbmZpZy5nZXRDb25maWcoKT8udHlwZXNGb3JtYXQ/LmRhdGU/LnBhdHRlcm5zICYmICFpc0VtcHR5KExpYkNvbmZpZy5nZXRDb25maWcoKS50eXBlc0Zvcm1hdC5kYXRlLnBhdHRlcm5zKSkge1xuICAgICAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgTGliQ29uZmlnLmdldENvbmZpZygpLnR5cGVzRm9ybWF0LmRhdGUucGF0dGVybnMpIHtcbiAgICAgICAgICBpZiAoaXNNYXRjaChwYXlsb2FkW2tleV0sIHBhdHRlcm4pKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZUFzRGF0ZSA9IHBhcnNlKHBheWxvYWRba2V5XSwgcGF0dGVybiwgbmV3IERhdGUoKSk7XG4gICAgICAgICAgICBpZiAodmFsdWVBc0RhdGUpIHtcbiAgICAgICAgICAgICAgcGF5bG9hZFtrZXldID0gdmFsdWVBc0RhdGU7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocGF5bG9hZFtrZXldIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHBheWxvYWRba2V5XSA9IHRoaXMucmVzb2x2ZVBheWxvYWRUeXBlKGtleSwgcGF5bG9hZFtrZXldLCBpc1Byb2plY3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiBwYXlsb2FkO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmVzb2x2ZVBheWxvYWRUeXBlPFQgZXh0ZW5kcyBCYXNlUmVzb3VyY2U+KGtleTogc3RyaW5nLCBwYXlsb2FkOiBvYmplY3QsIGlzUHJvamVjdGlvbj86IGJvb2xlYW4pOiBvYmplY3Qge1xuICAgIGlmIChpc05pbChwYXlsb2FkKSkge1xuICAgICAgcmV0dXJuIHBheWxvYWQ7XG4gICAgfSBlbHNlIGlmIChpc0FycmF5KHBheWxvYWQpKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBheWxvYWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcGF5bG9hZFtpXSA9IHRoaXMucmVzb2x2ZVBheWxvYWRUeXBlKGtleSwgcGF5bG9hZFtpXSwgaXNQcm9qZWN0aW9uKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzUHJvamVjdGlvbiAmJiBpc1BsYWluT2JqZWN0KHBheWxvYWQpKSB7XG4gICAgICAvLyBOZWVkIHRvIGNoZWNrIHJlc291cmNlIHByb2plY3Rpb24gcmVsYXRpb24gcHJvcHMgYmVjYXVzZSBzb21lIGlubmVyIHByb3BzIGNhbiBiZSBvYmplY3RzIHRoYXQgY2FuIGJlIGFsc28gcmVzb3VyY2VzXG4gICAgICBwYXlsb2FkID0gdGhpcy5yZXNvbHZlUGF5bG9hZFByb3BlcnRpZXModGhpcy5jcmVhdGVSZXNvdXJjZVByb2plY3Rpb25SZWwoa2V5LCBwYXlsb2FkKSwgaXNQcm9qZWN0aW9uKTtcbiAgICB9IGVsc2UgaWYgKGlzRW1iZWRkZWRSZXNvdXJjZShwYXlsb2FkKSB8fCBSZXNvdXJjZVV0aWxzLkVNQkVEREVEX1JFU09VUkNFX1RZUEVfTUFQLmdldChrZXkpKSB7XG4gICAgICAvLyBOZWVkIHRvIGNoZWNrIGVtYmVkZGVkIHJlc291cmNlIHByb3BzIGJlY2F1c2Ugc29tZSBpbm5lciBwcm9wcyBjYW4gYmUgb2JqZWN0cyB0aGF0IGNhbiBiZSBhbHNvIHJlc291cmNlc1xuICAgICAgcGF5bG9hZCA9IHRoaXMucmVzb2x2ZVBheWxvYWRQcm9wZXJ0aWVzKHRoaXMuY3JlYXRlRW1iZWRkZWRSZXNvdXJjZShrZXksIHBheWxvYWQpLCBpc1Byb2plY3Rpb24pO1xuICAgIH0gZWxzZSBpZiAoaXNSZXNvdXJjZShwYXlsb2FkKSkge1xuICAgICAgLy8gTmVlZCB0byBjaGVjayByZXNvdXJjZSBwcm9wcyBiZWNhdXNlIHNvbWUgaW5uZXIgcHJvcHMgY2FuIGJlIG9iamVjdHMgdGhhdCBjYW4gYmUgYWxzbyByZXNvdXJjZXNcbiAgICAgIHBheWxvYWQgPSB0aGlzLnJlc29sdmVQYXlsb2FkUHJvcGVydGllcyh0aGlzLmNyZWF0ZVJlc291cmNlKHBheWxvYWQpLCBpc1Byb2plY3Rpb24pO1xuICAgIH1cblxuICAgIHJldHVybiBwYXlsb2FkO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlUmVzb3VyY2U8VCBleHRlbmRzIEJhc2VSZXNvdXJjZT4ocGF5bG9hZDogYW55LCBpc1Byb2plY3Rpb24/OiBib29sZWFuKTogVCB7XG4gICAgY29uc3QgcmVzb3VyY2VOYW1lID0gdGhpcy5maW5kUmVzb3VyY2VOYW1lKHBheWxvYWQpO1xuICAgIGxldCByZXNvdXJjZUNsYXNzO1xuICAgIGlmIChpc1Byb2plY3Rpb24gJiYgIVJlc291cmNlVXRpbHMuUkVTT1VSQ0VfTkFNRV9QUk9KRUNUSU9OX1RZUEVfTUFQLmdldChyZXNvdXJjZU5hbWUpKSB7XG4gICAgICByZXNvdXJjZUNsYXNzID0gUmVzb3VyY2VVdGlscy5SRVNPVVJDRV9OQU1FX1RZUEVfTUFQLmdldChyZXNvdXJjZU5hbWUpO1xuICAgICAgQ29uc29sZUxvZ2dlci5wcmV0dHlXYXJuKCdOb3QgZm91bmQgcHJvamVjdGlvbiByZXNvdXJjZSB0eXBlIHdoZW4gY3JlYXRlIHJlc291cmNlIHByb2plY3Rpb246IFxcJycgKyByZXNvdXJjZU5hbWUgKyAnXFwnIHNvIHVzZWQgcmVzb3VyY2UgdHlwZTogXFwnJyArIChyZXNvdXJjZUNsYXNzID8gcmVzb3VyY2VDbGFzcz8ubmFtZSA6ICcgZGVmYXVsdCBSZXNvdXJjZScpICsgJ1xcJy4gXFxuXFxyJyArXG4gICAgICAgICdJdCBjYW4gYmUgd2hlbiB5b3UgcGFzcyBwcm9qZWN0aW9uIHBhcmFtIGFzIGh0dHAgcmVxdWVzdCBkaXJlY3RseSBpbnN0ZWFkIHVzZSBwcm9qZWN0aW9uIHR5cGUgd2l0aCBASGF0ZW9hc1Byb2plY3Rpb24uXFxuXFxyJyArXG4gICAgICAgICdcXG5cXHJTZWUgbW9yZSBob3cgdG8gdXNlIEBIYXRlb2FzUHJvamVjdGlvbiBoZXJlIGh0dHBzOi8vZ2l0aHViLmNvbS9sYWdvc2hueS9uZ3gtaGF0ZW9hcy1jbGllbnQjcmVzb3VyY2UtcHJvamVjdGlvbi1zdXBwb3J0LicpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNvdXJjZUNsYXNzID0gaXNQcm9qZWN0aW9uXG4gICAgICAgID8gUmVzb3VyY2VVdGlscy5SRVNPVVJDRV9OQU1FX1BST0pFQ1RJT05fVFlQRV9NQVAuZ2V0KHJlc291cmNlTmFtZSlcbiAgICAgICAgOiBSZXNvdXJjZVV0aWxzLlJFU09VUkNFX05BTUVfVFlQRV9NQVAuZ2V0KHJlc291cmNlTmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKHJlc291cmNlQ2xhc3MpIHtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyAocmVzb3VyY2VDbGFzcykoKSBhcyBULCBwYXlsb2FkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgQ29uc29sZUxvZ2dlci5wcmV0dHlXYXJuKCdOb3QgZm91bmQgcmVzb3VyY2UgdHlwZSB3aGVuIGNyZWF0ZSByZXNvdXJjZTogXFwnJyArIHJlc291cmNlTmFtZSArICdcXCcgc28gdXNlZCBkZWZhdWx0IFJlc291cmNlIHR5cGUsIGZvciB0aGlzIGNhbiBiZSBzb21lIHJlYXNvbnM6IFxcblxccicgK1xuICAgICAgICAnMSkgWW91IGRpZCBub3QgcGFzcyByZXNvdXJjZSBwcm9wZXJ0eSBuYW1lIGFzIFxcJycgKyByZXNvdXJjZU5hbWUgKyAnXFwnIHdpdGggQEhhdGVvYXNSZXNvdXJjZSBkZWNvcmF0b3IuIFxcblxccicgK1xuICAgICAgICAnMikgWW91IGRpZCBub3QgZGVjbGFyZSByZXNvdXJjZSB0eXBlIGluIGNvbmZpZ3VyYXRpb24gXCJjb25maWd1cmF0aW9uLnVzZVR5cGVzLnJlc291cmNlc1wiLiBcXG5cXHInICtcbiAgICAgICAgJ1xcblxcclNlZSBtb3JlIGFib3V0IGRlY2xhcmUgcmVzb3VyY2UgdHlwZXMgaGVyZTogaHR0cHM6Ly9naXRodWIuY29tL2xhZ29zaG55L25neC1oYXRlb2FzLWNsaWVudCN1c2V0eXBlcy1wYXJhbXMuLicpO1xuXG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5yZXNvdXJjZVR5cGUoKSwgcGF5bG9hZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlUmVzb3VyY2VQcm9qZWN0aW9uUmVsPFQgZXh0ZW5kcyBSZXNvdXJjZT4ocmVsYXRpb25OYW1lOiBzdHJpbmcsIHBheWxvYWQ6IGFueSk6IFQge1xuICAgIGNvbnN0IHJlbGF0aW9uQ2xhc3MgPSBSZXNvdXJjZVV0aWxzLlJFU09VUkNFX1BST0pFQ1RJT05fUkVMX05BTUVfVFlQRV9NQVAuZ2V0KHJlbGF0aW9uTmFtZSk7XG4gICAgaWYgKHJlbGF0aW9uQ2xhc3MpIHtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyAocmVsYXRpb25DbGFzcykoKSBhcyBULCBwYXlsb2FkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgQ29uc29sZUxvZ2dlci5wcmV0dHlXYXJuKCdOb3QgZm91bmQgcmVzb3VyY2UgcmVsYXRpb24gdHlwZSB3aGVuIGNyZWF0ZSByZWxhdGlvbjogXFwnJyArIHJlbGF0aW9uTmFtZSArICdcXCcgc28gdXNlZCBkZWZhdWx0IFJlc291cmNlIHR5cGUsIGZvciB0aGlzIGNhbiBiZSBzb21lIHJlYXNvbnM6IFxcblxccicgK1xuICAgICAgICAnWW91IGRpZCBub3QgcGFzcyByZWxhdGlvbiB0eXBlIHByb3BlcnR5IHdpdGggQFByb2plY3Rpb25SZWwgZGVjb3JhdG9yIG9uIHJlbGF0aW9uIHByb3BlcnR5IFxcJycgKyByZWxhdGlvbk5hbWUgKyAnXFwnLiBcXG5cXHInICtcbiAgICAgICAgJ1xcblxcclNlZSBtb3JlIGhvdyB0byB1c2UgQFByb2plY3Rpb25SZWwgaGVyZSBodHRwczovL2dpdGh1Yi5jb20vbGFnb3Nobnkvbmd4LWhhdGVvYXMtY2xpZW50I3Jlc291cmNlLXByb2plY3Rpb24tc3VwcG9ydC4nKTtcblxuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IHRoaXMucmVzb3VyY2VUeXBlKCksIHBheWxvYWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGNyZWF0ZUVtYmVkZGVkUmVzb3VyY2U8VCBleHRlbmRzIEJhc2VSZXNvdXJjZT4oa2V5OiBzdHJpbmcsIHBheWxvYWQ6IGFueSk6IFQge1xuICAgIGNvbnN0IHJlc291cmNlQ2xhc3MgPSBSZXNvdXJjZVV0aWxzLkVNQkVEREVEX1JFU09VUkNFX1RZUEVfTUFQLmdldChrZXkpO1xuICAgIGlmIChyZXNvdXJjZUNsYXNzKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgKHJlc291cmNlQ2xhc3MpKCkgYXMgVCwgcGF5bG9hZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIENvbnNvbGVMb2dnZXIucHJldHR5V2FybignTm90IGZvdW5kIGVtYmVkZGVkIHJlc291cmNlIHR5cGUgd2hlbiBjcmVhdGUgcmVzb3VyY2U6IFxcJycgKyBrZXkgKyAnXFwnIHNvIHVzZWQgZGVmYXVsdCBFbWJlZGRlZFJlc291cmNlIHR5cGUsIGZvciB0aGlzIGNhbiBiZSBzb21lIHJlYXNvbnM6LiBcXG5cXHInICtcbiAgICAgICAgJzEpIFlvdSBkaWQgbm90IHBhc3MgZW1iZWRkZWQgcmVzb3VyY2UgcHJvcGVydHkgbmFtZSBhcyBcXCcnICsga2V5ICsgJ1xcJyB3aXRoIEBIYXRlb2FzRW1iZWRkZWRSZXNvdXJjZSBkZWNvcmF0b3IuIFxcblxccicgK1xuICAgICAgICAnMikgWW91IGRpZCBub3QgZGVjbGFyZSBlbWJlZGRlZCByZXNvdXJjZSB0eXBlIGluIGNvbmZpZ3VyYXRpb24gXCJjb25maWd1cmF0aW9uLnVzZVR5cGVzLmVtYmVkZGVkUmVzb3VyY2VzXCIuIFxcblxccicgK1xuICAgICAgICAnXFxuXFxyIFNlZSBtb3JlIGFib3V0IGRlY2xhcmUgcmVzb3VyY2UgdHlwZXMgaGVyZTogaHR0cHM6Ly9naXRodWIuY29tL2xhZ29zaG55L25neC1oYXRlb2FzLWNsaWVudCN1c2V0eXBlcy1wYXJhbXMuJyk7XG5cbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKG5ldyB0aGlzLmVtYmVkZGVkUmVzb3VyY2VUeXBlKCksIHBheWxvYWQpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgaW5zdGFudGlhdGVSZXNvdXJjZUNvbGxlY3Rpb248VCBleHRlbmRzIFJlc291cmNlQ29sbGVjdGlvbjxCYXNlUmVzb3VyY2U+PihwYXlsb2FkOiBvYmplY3QsIGlzUHJvamVjdGlvbj86IGJvb2xlYW4pOiBUIHtcbiAgICBpZiAoaXNFbXB0eShwYXlsb2FkKVxuICAgICAgfHwgKCFpc09iamVjdChwYXlsb2FkWydfbGlua3MnXSkgfHwgaXNFbXB0eShwYXlsb2FkWydfbGlua3MnXSkpXG4gICAgICB8fCAoIUxpYkNvbmZpZy5nZXRDb25maWcoKS5oYWxGb3JtYXQuY29sbGVjdGlvbnMuZW1iZWRkZWRPcHRpb25hbCAmJlxuICAgICAgICAoISgnX2VtYmVkZGVkJyBpbiBwYXlsb2FkKSB8fCAhaXNPYmplY3QocGF5bG9hZFsnX2VtYmVkZGVkJ10pIHx8IGlzRW1wdHkocGF5bG9hZFsnX2VtYmVkZGVkJ10pKSkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSBuZXcgdGhpcy5yZXNvdXJjZUNvbGxlY3Rpb25UeXBlKCkgYXMgVDtcbiAgICBpZiAoJ19lbWJlZGRlZCcgaW4gcGF5bG9hZCAmJiBpc09iamVjdChwYXlsb2FkWydfZW1iZWRkZWQnXSkgJiYgIWlzRW1wdHkocGF5bG9hZFsnX2VtYmVkZGVkJ10pKSB7XG4gICAgICBmb3IgKGNvbnN0IHJlc291cmNlTmFtZSBvZiBPYmplY3Qua2V5cyhwYXlsb2FkWydfZW1iZWRkZWQnXSkpIHtcbiAgICAgICAgcGF5bG9hZFsnX2VtYmVkZGVkJ11bcmVzb3VyY2VOYW1lXS5mb3JFYWNoKChyZXNvdXJjZSkgPT4ge1xuICAgICAgICAgIHJlc3VsdC5yZXNvdXJjZXMucHVzaCh0aGlzLmluc3RhbnRpYXRlUmVzb3VyY2UocmVzb3VyY2UsIGlzUHJvamVjdGlvbikpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzdWx0WydfbGlua3MnXSA9IHsuLi5wYXlsb2FkWydfbGlua3MnXX07XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBpbnN0YW50aWF0ZVBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uPFQgZXh0ZW5kcyBQYWdlZFJlc291cmNlQ29sbGVjdGlvbjxCYXNlUmVzb3VyY2U+PihwYXlsb2FkOiBvYmplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNQcm9qZWN0aW9uPzogYm9vbGVhbik6IFQge1xuICAgIGNvbnN0IHJlc291cmNlQ29sbGVjdGlvbiA9IHRoaXMuaW5zdGFudGlhdGVSZXNvdXJjZUNvbGxlY3Rpb24ocGF5bG9hZCwgaXNQcm9qZWN0aW9uKTtcbiAgICBpZiAocmVzb3VyY2VDb2xsZWN0aW9uID09IG51bGwpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGxldCByZXN1bHQ7XG4gICAgaWYgKHBheWxvYWRbJ3BhZ2UnXSkge1xuICAgICAgcmVzdWx0ID0gbmV3IHRoaXMucGFnZWRSZXNvdXJjZUNvbGxlY3Rpb25UeXBlKHJlc291cmNlQ29sbGVjdGlvbiwgcGF5bG9hZCBhcyBQYWdlRGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdCA9IG5ldyB0aGlzLnBhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uVHlwZShyZXNvdXJjZUNvbGxlY3Rpb24pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0IGFzIFQ7XG4gIH1cblxuICAvKipcbiAgICogUmVzb2x2ZSByZXF1ZXN0IGJvZHkgcmVsYXRpb25zLlxuICAgKiBJZiByZXF1ZXN0IGJvZHkgaGFzIHtAbGluayBSZXNvdXJjZX0gdmFsdWUgdGhlbiB0aGlzIHZhbHVlIHdpbGwgYmUgcmVwbGFjZWQgYnkgcmVzb3VyY2Ugc2VsZiBsaW5rLlxuICAgKiBJZiByZXF1ZXN0IGJvZHkgaGFzIHtAbGluayBWYWx1ZXNPcHRpb259IGl0IHdpbGwgYmUgYXBwbGllZCB0byBib2R5IHZhbHVlcy5cbiAgICpcbiAgICogQHBhcmFtIHJlcXVlc3RCb2R5IHRoYXQgY29udGFpbnMgdGhlIGJvZHkgZGlyZWN0bHkgYW5kIG9wdGlvbmFsIGJvZHkgdmFsdWVzIG9wdGlvbiB7QGxpbmsgVmFsdWVzT3B0aW9ufVxuICAgKi9cbiAgcHVibGljIHN0YXRpYyByZXNvbHZlVmFsdWVzKHJlcXVlc3RCb2R5OiBSZXF1ZXN0Qm9keTxhbnk+KTogYW55IHtcbiAgICBpZiAoaXNFbXB0eShyZXF1ZXN0Qm9keSkgfHwgaXNOaWwocmVxdWVzdEJvZHkuYm9keSlcbiAgICAgIHx8IChpc09iamVjdChyZXF1ZXN0Qm9keS5ib2R5KSAmJiBpc0VtcHR5KHJlcXVlc3RCb2R5LmJvZHkpKSkge1xuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUkVTT0xWRV9WQUxVRVMsIHtyZXN1bHQ6ICdib2R5IGlzIGVtcHR5IHJldHVybiBudWxsJ30pO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IGJvZHkgPSByZXF1ZXN0Qm9keS5ib2R5O1xuICAgIGlmICghaXNPYmplY3QoYm9keSkgfHwgaXNBcnJheShib2R5KSkge1xuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUkVTT0xWRV9WQUxVRVMsIHtyZXN1bHQ6ICdib2R5IGlzIG5vdCBvYmplY3Qgb3IgYXJyYXkgcmV0dXJuIGFzIGlzJ30pO1xuICAgICAgcmV0dXJuIGJvZHk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdWx0OiBvYmplY3QgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGtleSBpbiBib2R5KSB7XG4gICAgICBpZiAoIWJvZHkuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChib2R5W2tleV0gPT0gbnVsbCAmJiBJbmNsdWRlLk5VTExfVkFMVUVTID09PSByZXF1ZXN0Qm9keT8udmFsdWVzT3B0aW9uPy5pbmNsdWRlKSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gbnVsbDtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoaXNOaWwoYm9keVtrZXldKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChpc0FycmF5KGJvZHlba2V5XSkpIHtcbiAgICAgICAgY29uc3QgYXJyYXk6IGFueVtdID0gYm9keVtrZXldO1xuICAgICAgICByZXN1bHRba2V5XSA9IFtdO1xuICAgICAgICBhcnJheS5mb3JFYWNoKChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgaWYgKGlzUmVzb3VyY2UoZWxlbWVudCkpIHtcbiAgICAgICAgICAgIHJlc3VsdFtrZXldLnB1c2goZWxlbWVudD8uX2xpbmtzPy5zZWxmPy5ocmVmKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzdWx0W2tleV0ucHVzaCh0aGlzLnJlc29sdmVWYWx1ZXMoe2JvZHk6IGVsZW1lbnQsIHZhbHVlc09wdGlvbjogcmVxdWVzdEJvZHk/LnZhbHVlc09wdGlvbn0pKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmIChpc1Jlc291cmNlKGJvZHlba2V5XSkpIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSBib2R5W2tleV0uX2xpbmtzPy5zZWxmPy5ocmVmO1xuICAgICAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KGJvZHlba2V5XSkpIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSB0aGlzLnJlc29sdmVWYWx1ZXMoe2JvZHk6IGJvZHlba2V5XSwgdmFsdWVzT3B0aW9uOiByZXF1ZXN0Qm9keT8udmFsdWVzT3B0aW9ufSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHRba2V5XSA9IGJvZHlba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUkVTT0xWRV9WQUxVRVMsIHtyZXN1bHR9KTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogQXNzaWduIHtAbGluayBSZXNvdXJjZX0gb3Ige0BsaW5rIEVtYmVkZGVkUmVzb3VyY2V9IHByb3BlcnRpZXMgdG8gcGFzc2VkIGVudGl0eS5cbiAgICpcbiAgICogQHBhcmFtIGVudGl0eSB0byBiZSBjb252ZXJ0ZXIgdG8gcmVzb3VyY2VcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgaW5pdFJlc291cmNlKGVudGl0eTogYW55KTogQmFzZVJlc291cmNlIHwgYW55IHtcbiAgICBpZiAoaXNSZXNvdXJjZShlbnRpdHkpKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5yZXNvdXJjZVR5cGUoKSwgZW50aXR5KTtcbiAgICB9IGVsc2UgaWYgKGlzRW1iZWRkZWRSZXNvdXJjZShlbnRpdHkpKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5lbWJlZGRlZFJlc291cmNlVHlwZSgpLCBlbnRpdHkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZW50aXR5O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZpbmUgcmVzb3VyY2UgbmFtZSBiYXNlZCBvbiByZXNvdXJjZSBsaW5rcy5cbiAgICogSXQgd2lsbCBnZXQgbGluayBuYW1lIHRoYXQgaHJlZiBlcXVhbHMgdG8gc2VsZiBocmVmIHJlc291cmNlIGxpbmsuXG4gICAqXG4gICAqIEBwYXJhbSBwYXlsb2FkIHRoYXQgY2FuIGJlIGEgcmVzb3VyY2UgZm9yIHdoaWNoIHRvIGZpbmQgdGhlIG5hbWVcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGZpbmRSZXNvdXJjZU5hbWUocGF5bG9hZDogb2JqZWN0KTogc3RyaW5nIHtcbiAgICBpZiAoIXBheWxvYWQgfHwgIXBheWxvYWRbJ19saW5rcyddIHx8ICFwYXlsb2FkWydfbGlua3MnXS5zZWxmKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIGNvbnN0IHJlc291cmNlTGlua3MgPSBwYXlsb2FkWydfbGlua3MnXSBhcyBMaW5rO1xuICAgIGlmIChpc0VtcHR5KHJlc291cmNlTGlua3MpIHx8IGlzRW1wdHkocmVzb3VyY2VMaW5rcy5zZWxmKSB8fCBpc05pbChyZXNvdXJjZUxpbmtzLnNlbGYuaHJlZikpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICByZXR1cm4gVXJsVXRpbHMuZ2V0UmVzb3VyY2VOYW1lRnJvbVVybChVcmxVdGlscy5yZW1vdmVUZW1wbGF0ZVBhcmFtcyhyZXNvdXJjZUxpbmtzLnNlbGYuaHJlZikpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpcyBhIHJlc291cmNlIHByb2plY3Rpb24gb3Igbm90LlxuICAgKlxuICAgKiBAcGFyYW0gcGF5bG9hZCBvYmplY3QgdGhhdCBjYW4gYmUgcmVzb3VyY2Ugb3IgcmVzb3VyY2UgcHJvamVjdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgaXNSZXNvdXJjZVByb2plY3Rpb24ocGF5bG9hZDogb2JqZWN0KTogYm9vbGVhbiB7XG4gICAgaWYgKCFwYXlsb2FkIHx8ICFwYXlsb2FkWydfbGlua3MnXSB8fCAhcGF5bG9hZFsnX2xpbmtzJ10uc2VsZikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IHNlbGZMaW5rID0gcGF5bG9hZFsnX2xpbmtzJ10uc2VsZjtcbiAgICBjb25zdCByZXNvdXJjZUxpbmtzID0gcGF5bG9hZFsnX2xpbmtzJ107XG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMocmVzb3VyY2VMaW5rcykpIHtcbiAgICAgIGlmIChrZXkgIT09ICdzZWxmJyAmJiByZXNvdXJjZUxpbmtzW2tleV0uaHJlZi5pbmNsdWRlcyhzZWxmTGluay5ocmVmKSkge1xuICAgICAgICByZXR1cm4gbmV3IFVSTChyZXNvdXJjZUxpbmtzW2tleV0uaHJlZikuc2VhcmNoLmluY2x1ZGVzKCdwcm9qZWN0aW9uJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyeSB0byBnZXQgcHJvamVjdGlvbk5hbWUgZnJvbSByZXNvdXJjZSB0eXBlIGFuZCBzZXQgaXQgdG8gb3B0aW9ucy4gSWYgcmVzb3VyY2VUeXBlIGhhcyBub3QgcHJvamVjdGlvbk5hbWUgdGhlbiByZXR1cm4gb3B0aW9ucyBhcyBpcy5cbiAgICpcbiAgICogQHBhcmFtIHJlc291cmNlVHlwZSBmcm9tIGdldCBwcm9qZWN0aW9uTmFtZVxuICAgKiBAcGFyYW0gb3B0aW9ucyB0byBzZXQgcHJvamVjdGlvbk5hbWVcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZmlsbFByb2plY3Rpb25OYW1lRnJvbVJlc291cmNlVHlwZTxUIGV4dGVuZHMgUmVzb3VyY2U+KHJlc291cmNlVHlwZTogbmV3ICgpID0+IFQsIG9wdGlvbnM/OiBHZXRPcHRpb24pIHtcbiAgICBpZiAoIXJlc291cmNlVHlwZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBwcm9qZWN0aW9uTmFtZSA9IHJlc291cmNlVHlwZVsnX19wcm9qZWN0aW9uTmFtZV9fJ107XG4gICAgaWYgKHByb2plY3Rpb25OYW1lKSB7XG4gICAgICBvcHRpb25zID0gb3B0aW9ucyA/IG9wdGlvbnMgOiB7cGFyYW1zOiB7fX07XG4gICAgICBvcHRpb25zID0ge1xuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAuLi5vcHRpb25zLnBhcmFtcyxcbiAgICAgICAgICBwcm9qZWN0aW9uOiBwcm9qZWN0aW9uTmFtZVxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBvcHRpb25zO1xuICB9XG5cbn1cbiJdfQ==