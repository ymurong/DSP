import { HttpParams } from '@angular/common/http';
import { isResource } from '../model/resource-type';
import { ValidationUtils } from './validation.utils';
import { LibConfig } from '../config/lib-config';
import { isArray, isEmpty, isNil, isObject, toString } from 'lodash-es';
import { UriTemplate } from 'uri-templates-es';
import { ConsoleLogger } from '../logger/console-logger';
export class UrlUtils {
    /**
     * Convert passed params to the {@link HttpParams}.
     *
     * @param options which need to convert
     * @param httpParams (optional) if passed then will be applied to this one, otherwise created a new one
     */
    static convertToHttpParams(options, httpParams) {
        let resultParams = httpParams ? httpParams : new HttpParams();
        if (isEmpty(options) || isNil(options)) {
            return resultParams;
        }
        UrlUtils.checkDuplicateParams(options);
        if (isObject(options.params) && !isEmpty(options.params)) {
            for (const [key, value] of Object.entries(options.params)) {
                if (options.params.hasOwnProperty(key)) {
                    if (isResource(value)) {
                        // Append resource as resource link
                        resultParams = resultParams.append(key, value.getSelfLinkHref());
                    }
                    else if (isArray(options.params[key])) {
                        // Append arrays params as repeated key with each value from array
                        options.params[key].forEach((item) => {
                            resultParams = resultParams.append(`${key.toString()}`, item);
                        });
                    }
                    else {
                        // Else append simple param as is
                        resultParams = resultParams.append(key, value.toString());
                    }
                }
            }
        }
        if (!isEmpty(options.pageParams)) {
            resultParams = resultParams.append('page', toString(options.pageParams.page));
            resultParams = resultParams.append('size', toString(options.pageParams.size));
        }
        if (!isEmpty(options.sort)) {
            resultParams = UrlUtils.generateSortParams(options.sort, resultParams);
        }
        return resultParams;
    }
    /**
     * Convert ngx-hateoas-client option to Angular HttpClient.
     * @param options ngx-hateoas-client options
     */
    static convertToHttpOptions(options) {
        if (isEmpty(options) || isNil(options)) {
            return {};
        }
        return {
            params: UrlUtils.convertToHttpParams(options),
            headers: options.headers,
            observe: options.observe,
            reportProgress: options.reportProgress,
            withCredentials: options.withCredentials,
        };
    }
    /**
     * Generate link url.
     * If proxyUrl is not empty then relation url will be use proxy.
     *
     * @param relationLink resource link to which need to generate the url
     * @param options (optional) additional options that should be applied to the request
     * @throws error when required params are not valid
     */
    static generateLinkUrl(relationLink, options) {
        ValidationUtils.validateInputParams({ relationLink, linkUrl: relationLink?.href });
        let url;
        if (options && !isEmpty(options)) {
            url = relationLink.templated ? UrlUtils.fillTemplateParams(relationLink.href, options) : relationLink.href;
        }
        else {
            url = relationLink.templated ? UrlUtils.removeTemplateParams(relationLink.href) : relationLink.href;
        }
        const route = UrlUtils.guessResourceRoute(url);
        if (route.proxyUrl) {
            return url.replace(route.rootUrl, route.proxyUrl);
        }
        return url;
    }
    /**
     * Return server api url based on proxy url when it is not empty or root url otherwise.
     *
     * @param routeName resource route name that configured in {@link MultipleResourceRoutes}.
     */
    static getApiUrl(routeName) {
        const route = UrlUtils.getRouteByName(routeName);
        if (route.proxyUrl) {
            return route.proxyUrl;
        }
        else {
            return route.rootUrl;
        }
    }
    /**
     * Try to determine resource route by passed resource url.
     * @param url resource url
     */
    static guessResourceRoute(url) {
        let resourceRoute;
        for (const [routeName] of Object.entries(UrlUtils.getRoutes())) {
            const route = UrlUtils.getRouteByName(routeName);
            const lowerCaseUrl = url.toLowerCase();
            if (lowerCaseUrl.includes(route.rootUrl.toLowerCase())
                || (!isEmpty(route.proxyUrl) && lowerCaseUrl.includes(route.proxyUrl.toLowerCase()))) {
                resourceRoute = route;
                break;
            }
        }
        if (isEmpty(resourceRoute)) {
            throw new Error(`Failed to determine resource route by url: ${url}`);
        }
        return resourceRoute;
    }
    /**
     * Generate url use base and the resource name.
     *
     * @param baseUrl will be as first part as a result url
     * @param resourceName added to the base url through slash
     * @param query (optional) if passed then adds to end of the url
     * @throws error when required params are not valid
     */
    static generateResourceUrl(baseUrl, resourceName, query) {
        ValidationUtils.validateInputParams({ baseUrl, resourceName });
        let url = baseUrl;
        if (!url.endsWith('/')) {
            url = url.concat('/');
        }
        return url.concat(resourceName).concat(query ? `${query.startsWith('/') ? query : '/' + query}` : '');
    }
    /**
     * Retrieve a resource name from resource url.
     *
     * @param url resource url
     */
    static getResourceNameFromUrl(url) {
        ValidationUtils.validateInputParams({ url });
        const lowerCaseUrl = url.toLowerCase();
        const resourceRoute = UrlUtils.guessResourceRoute(url);
        let baseUrl;
        if (lowerCaseUrl.includes(resourceRoute.rootUrl)) {
            baseUrl = resourceRoute.rootUrl;
        }
        else if (!isEmpty(resourceRoute.proxyUrl) && lowerCaseUrl.includes(resourceRoute.proxyUrl)) {
            baseUrl = resourceRoute.proxyUrl;
        }
        else {
            throw new Error(`Failed to determine resource name from url: ${url}, found resource route ${JSON.stringify(resourceRoute)}`);
        }
        if (!baseUrl.endsWith('/')) {
            baseUrl = baseUrl.concat('/');
        }
        return url.toLowerCase().replace(`${baseUrl}`, '').split('/')[0];
    }
    /**
     * Clear url from template params.
     *
     * @param url to be cleaned
     * @throws error when required params are not valid
     */
    static removeTemplateParams(url) {
        ValidationUtils.validateInputParams({ url });
        return UrlUtils.fillTemplateParams(url, {});
    }
    /**
     * Clear all url params.
     *
     * @param url to clear params
     * @throws error when required params are not valid
     */
    static clearUrlParams(url) {
        ValidationUtils.validateInputParams({ url });
        const srcUrl = new URL(url);
        return srcUrl.origin + srcUrl.pathname;
    }
    /**
     * Fill url template params.
     *
     * @param url to be filled
     * @param options contains params to apply to result url, if empty then template params will be cleared
     * @throws error when required params are not valid
     */
    static fillTemplateParams(url, options) {
        ValidationUtils.validateInputParams({ url });
        UrlUtils.checkDuplicateParams(options);
        /*
           Sort params will be applied through Http request params not with template params
           because often sort params is not present in template params then sort params need to put through Http request params.
           But when sort params present in template params we need to avoid duplication sort params from Http request params
           and template params therefore we need to add it in one place.
        */
        const paramsWithoutSortParam = {
            ...options,
            ...options?.params,
            ...options?.pageParams,
        };
        return new UriTemplate(url).fill(isNil(paramsWithoutSortParam) ? {} : paramsWithoutSortParam);
    }
    static fillDefaultPageDataIfNoPresent(options) {
        const pagedOptions = !isEmpty(options) ? options : {};
        if (isEmpty(pagedOptions.pageParams)) {
            pagedOptions.pageParams = LibConfig.getConfig().pagination.defaultPage;
        }
        else if (!pagedOptions.pageParams.size) {
            pagedOptions.pageParams.size = LibConfig.getConfig().pagination.defaultPage.size;
        }
        else if (!pagedOptions.pageParams.page) {
            pagedOptions.pageParams.page = LibConfig.getConfig().pagination.defaultPage.page;
        }
        return pagedOptions;
    }
    static generateSortParams(sort, httpParams) {
        let resultParams = httpParams ? httpParams : new HttpParams();
        if (!isEmpty(sort)) {
            for (const [sortPath, sortOrder] of Object.entries(sort)) {
                resultParams = resultParams.append('sort', `${sortPath},${sortOrder}`);
            }
        }
        return resultParams;
    }
    static checkDuplicateParams(options) {
        if (isEmpty(options) || isEmpty(options.params)) {
            return;
        }
        if ('page' in options.params || 'size' in options.params) {
            throw Error('Please, pass page params in page object key, not with params object!');
        }
    }
    static getRouteByName(routeName) {
        const route = LibConfig.getConfig().http[routeName];
        if (isEmpty(route)) {
            ConsoleLogger.error(`No Resource route found by name: '${routeName}'. Check you configuration. Read more about this ...`, {
                availableRoutes: UrlUtils.getRoutes()
            });
            throw Error(`No Resource route found by name: '${routeName}'.`);
        }
        return route;
    }
    static getRoutes() {
        return LibConfig.getConfig().http;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXJsLnV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWhhdGVvYXMtY2xpZW50L3NyYy9saWIvdXRpbC91cmwudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUdwRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFekQsTUFBTSxPQUFPLFFBQVE7SUFFbkI7Ozs7O09BS0c7SUFDSSxNQUFNLENBQUMsbUJBQW1CLENBQUMsT0FBdUIsRUFBRSxVQUF1QjtRQUNoRixJQUFJLFlBQVksR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUM5RCxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdEMsT0FBTyxZQUFZLENBQUM7U0FDckI7UUFDRCxRQUFRLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdkMsSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4RCxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVB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c0RBQXNELEVBQUU7Z0JBQzFILGVBQWUsRUFBRSxRQUFRLENBQUMsU0FBUyxFQUFFO2FBQ3RDLENBQUMsQ0FBQztZQUNILE1BQU0sS0FBSyxDQUFDLHFDQUFzQyxTQUFVLElBQUksQ0FBQyxDQUFDO1NBQ25FO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU0sTUFBTSxDQUFDLFNBQVM7UUFDckIsT0FBTyxTQUFTLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBOEIsQ0FBQztJQUM5RCxDQUFDO0NBRUYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwUGFyYW1zIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgaXNSZXNvdXJjZSB9IGZyb20gJy4uL21vZGVsL3Jlc291cmNlLXR5cGUnO1xuaW1wb3J0IHsgUmVzb3VyY2UgfSBmcm9tICcuLi9tb2RlbC9yZXNvdXJjZS9yZXNvdXJjZSc7XG5pbXBvcnQgeyBHZXRPcHRpb24sIEh0dHBDbGllbnRPcHRpb25zLCBMaW5rRGF0YSwgUGFnZWRHZXRPcHRpb24sIFNvcnQgfSBmcm9tICcuLi9tb2RlbC9kZWNsYXJhdGlvbnMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvblV0aWxzIH0gZnJvbSAnLi92YWxpZGF0aW9uLnV0aWxzJztcbmltcG9ydCB7IExpYkNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9saWItY29uZmlnJztcbmltcG9ydCB7IGlzQXJyYXksIGlzRW1wdHksIGlzTmlsLCBpc09iamVjdCwgdG9TdHJpbmcgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgVXJpVGVtcGxhdGUgfSBmcm9tICd1cmktdGVtcGxhdGVzLWVzJztcbmltcG9ydCB7IE11bHRpcGxlUmVzb3VyY2VSb3V0ZXMsIFJlc291cmNlUm91dGUgfSBmcm9tICcuLi9jb25maWcvaGF0ZW9hcy1jb25maWd1cmF0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBDb25zb2xlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL2NvbnNvbGUtbG9nZ2VyJztcblxuZXhwb3J0IGNsYXNzIFVybFV0aWxzIHtcblxuICAvKipcbiAgICogQ29udmVydCBwYXNzZWQgcGFyYW1zIHRvIHRoZSB7QGxpbmsgSHR0cFBhcmFtc30uXG4gICAqXG4gICAqIEBwYXJhbSBvcHRpb25zIHdoaWNoIG5lZWQgdG8gY29udmVydFxuICAgKiBAcGFyYW0gaHR0cFBhcmFtcyAob3B0aW9uYWwpIGlmIHBhc3NlZCB0aGVuIHdpbGwgYmUgYXBwbGllZCB0byB0aGlzIG9uZSwgb3RoZXJ3aXNlIGNyZWF0ZWQgYSBuZXcgb25lXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGNvbnZlcnRUb0h0dHBQYXJhbXMob3B0aW9uczogUGFnZWRHZXRPcHRpb24sIGh0dHBQYXJhbXM/OiBIdHRwUGFyYW1zKTogSHR0cFBhcmFtcyB7XG4gICAgbGV0IHJlc3VsdFBhcmFtcyA9IGh0dHBQYXJhbXMgPyBodHRwUGFyYW1zIDogbmV3IEh0dHBQYXJhbXMoKTtcbiAgICBpZiAoaXNFbXB0eShvcHRpb25zKSB8fCBpc05pbChvcHRpb25zKSkge1xuICAgICAgcmV0dXJuIHJlc3VsdFBhcmFtcztcbiAgICB9XG4gICAgVXJsVXRpbHMuY2hlY2tEdXBsaWNhdGVQYXJhbXMob3B0aW9ucyk7XG5cbiAgICBpZiAoaXNPYmplY3Qob3B0aW9ucy5wYXJhbXMpICYmICFpc0VtcHR5KG9wdGlvbnMucGFyYW1zKSkge1xuICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob3B0aW9ucy5wYXJhbXMpKSB7XG4gICAgICAgIGlmIChvcHRpb25zLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgaWYgKGlzUmVzb3VyY2UodmFsdWUpKSB7XG4gICAgICAgICAgICAvLyBBcHBlbmQgcmVzb3VyY2UgYXMgcmVzb3VyY2UgbGlua1xuICAgICAgICAgICAgcmVzdWx0UGFyYW1zID0gcmVzdWx0UGFyYW1zLmFwcGVuZChrZXksICh2YWx1ZSBhcyBSZXNvdXJjZSkuZ2V0U2VsZkxpbmtIcmVmKCkpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShvcHRpb25zLnBhcmFtc1trZXldKSkge1xuICAgICAgICAgICAgLy8gQXBwZW5kIGFycmF5cyBwYXJhbXMgYXMgcmVwZWF0ZWQga2V5IHdpdGggZWFjaCB2YWx1ZSBmcm9tIGFycmF5XG4gICAgICAgICAgICAob3B0aW9ucy5wYXJhbXNba2V5XSBhcyBBcnJheTxhbnk+KS5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgIHJlc3VsdFBhcmFtcyA9IHJlc3VsdFBhcmFtcy5hcHBlbmQoYCR7IGtleS50b1N0cmluZygpIH1gLCBpdGVtKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBFbHNlIGFwcGVuZCBzaW1wbGUgcGFyYW0gYXMgaXNcbiAgICAgICAgICAgIHJlc3VsdFBhcmFtcyA9IHJlc3VsdFBhcmFtcy5hcHBlbmQoa2V5LCB2YWx1ZS50b1N0cmluZygpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWlzRW1wdHkob3B0aW9ucy5wYWdlUGFyYW1zKSkge1xuICAgICAgcmVzdWx0UGFyYW1zID0gcmVzdWx0UGFyYW1zLmFwcGVuZCgncGFnZScsIHRvU3RyaW5nKG9wdGlvbnMucGFnZVBhcmFtcy5wYWdlKSk7XG4gICAgICByZXN1bHRQYXJhbXMgPSByZXN1bHRQYXJhbXMuYXBwZW5kKCdzaXplJywgdG9TdHJpbmcob3B0aW9ucy5wYWdlUGFyYW1zLnNpemUpKTtcbiAgICB9XG4gICAgaWYgKCFpc0VtcHR5KG9wdGlvbnMuc29ydCkpIHtcbiAgICAgIHJlc3VsdFBhcmFtcyA9IFVybFV0aWxzLmdlbmVyYXRlU29ydFBhcmFtcyhvcHRpb25zLnNvcnQsIHJlc3VsdFBhcmFtcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdFBhcmFtcztcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IG5neC1oYXRlb2FzLWNsaWVudCBvcHRpb24gdG8gQW5ndWxhciBIdHRwQ2xpZW50LlxuICAgKiBAcGFyYW0gb3B0aW9ucyBuZ3gtaGF0ZW9hcy1jbGllbnQgb3B0aW9uc1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBjb252ZXJ0VG9IdHRwT3B0aW9ucyhvcHRpb25zOiBQYWdlZEdldE9wdGlvbik6IEh0dHBDbGllbnRPcHRpb25zIHtcbiAgICBpZiAoaXNFbXB0eShvcHRpb25zKSB8fCBpc05pbChvcHRpb25zKSkge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBwYXJhbXM6IFVybFV0aWxzLmNvbnZlcnRUb0h0dHBQYXJhbXMob3B0aW9ucyksXG4gICAgICBoZWFkZXJzOiBvcHRpb25zLmhlYWRlcnMsXG4gICAgICBvYnNlcnZlOiBvcHRpb25zLm9ic2VydmUsXG4gICAgICByZXBvcnRQcm9ncmVzczogb3B0aW9ucy5yZXBvcnRQcm9ncmVzcyxcbiAgICAgIHdpdGhDcmVkZW50aWFsczogb3B0aW9ucy53aXRoQ3JlZGVudGlhbHMsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBsaW5rIHVybC5cbiAgICogSWYgcHJveHlVcmwgaXMgbm90IGVtcHR5IHRoZW4gcmVsYXRpb24gdXJsIHdpbGwgYmUgdXNlIHByb3h5LlxuICAgKlxuICAgKiBAcGFyYW0gcmVsYXRpb25MaW5rIHJlc291cmNlIGxpbmsgdG8gd2hpY2ggbmVlZCB0byBnZW5lcmF0ZSB0aGUgdXJsXG4gICAqIEBwYXJhbSBvcHRpb25zIChvcHRpb25hbCkgYWRkaXRpb25hbCBvcHRpb25zIHRoYXQgc2hvdWxkIGJlIGFwcGxpZWQgdG8gdGhlIHJlcXVlc3RcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdlbmVyYXRlTGlua1VybChyZWxhdGlvbkxpbms6IExpbmtEYXRhLCBvcHRpb25zPzogUGFnZWRHZXRPcHRpb24pOiBzdHJpbmcge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtyZWxhdGlvbkxpbmssIGxpbmtVcmw6IHJlbGF0aW9uTGluaz8uaHJlZn0pO1xuICAgIGxldCB1cmw7XG4gICAgaWYgKG9wdGlvbnMgJiYgIWlzRW1wdHkob3B0aW9ucykpIHtcbiAgICAgIHVybCA9IHJlbGF0aW9uTGluay50ZW1wbGF0ZWQgPyBVcmxVdGlscy5maWxsVGVtcGxhdGVQYXJhbXMocmVsYXRpb25MaW5rLmhyZWYsIG9wdGlvbnMpIDogcmVsYXRpb25MaW5rLmhyZWY7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVybCA9IHJlbGF0aW9uTGluay50ZW1wbGF0ZWQgPyBVcmxVdGlscy5yZW1vdmVUZW1wbGF0ZVBhcmFtcyhyZWxhdGlvbkxpbmsuaHJlZikgOiByZWxhdGlvbkxpbmsuaHJlZjtcbiAgICB9XG5cbiAgICBjb25zdCByb3V0ZSA9IFVybFV0aWxzLmd1ZXNzUmVzb3VyY2VSb3V0ZSh1cmwpO1xuICAgIGlmIChyb3V0ZS5wcm94eVVybCkge1xuICAgICAgcmV0dXJuIHVybC5yZXBsYWNlKHJvdXRlLnJvb3RVcmwsIHJvdXRlLnByb3h5VXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHVybDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gc2VydmVyIGFwaSB1cmwgYmFzZWQgb24gcHJveHkgdXJsIHdoZW4gaXQgaXMgbm90IGVtcHR5IG9yIHJvb3QgdXJsIG90aGVyd2lzZS5cbiAgICpcbiAgICogQHBhcmFtIHJvdXRlTmFtZSByZXNvdXJjZSByb3V0ZSBuYW1lIHRoYXQgY29uZmlndXJlZCBpbiB7QGxpbmsgTXVsdGlwbGVSZXNvdXJjZVJvdXRlc30uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldEFwaVVybChyb3V0ZU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3Qgcm91dGUgPSBVcmxVdGlscy5nZXRSb3V0ZUJ5TmFtZShyb3V0ZU5hbWUpO1xuICAgIGlmIChyb3V0ZS5wcm94eVVybCkge1xuICAgICAgcmV0dXJuIHJvdXRlLnByb3h5VXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcm91dGUucm9vdFVybDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVHJ5IHRvIGRldGVybWluZSByZXNvdXJjZSByb3V0ZSBieSBwYXNzZWQgcmVzb3VyY2UgdXJsLlxuICAgKiBAcGFyYW0gdXJsIHJlc291cmNlIHVybFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBndWVzc1Jlc291cmNlUm91dGUodXJsOiBzdHJpbmcpOiBSZXNvdXJjZVJvdXRlIHtcbiAgICBsZXQgcmVzb3VyY2VSb3V0ZTogUmVzb3VyY2VSb3V0ZTtcbiAgICBmb3IgKGNvbnN0IFtyb3V0ZU5hbWVdIG9mIE9iamVjdC5lbnRyaWVzKFVybFV0aWxzLmdldFJvdXRlcygpKSkge1xuICAgICAgY29uc3Qgcm91dGUgPSBVcmxVdGlscy5nZXRSb3V0ZUJ5TmFtZShyb3V0ZU5hbWUpO1xuICAgICAgY29uc3QgbG93ZXJDYXNlVXJsID0gdXJsLnRvTG93ZXJDYXNlKCk7XG4gICAgICBpZiAobG93ZXJDYXNlVXJsLmluY2x1ZGVzKHJvdXRlLnJvb3RVcmwudG9Mb3dlckNhc2UoKSlcbiAgICAgICAgfHwgKCFpc0VtcHR5KHJvdXRlLnByb3h5VXJsKSAmJiBsb3dlckNhc2VVcmwuaW5jbHVkZXMocm91dGUucHJveHlVcmwudG9Mb3dlckNhc2UoKSkpKSB7XG4gICAgICAgIHJlc291cmNlUm91dGUgPSByb3V0ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGlzRW1wdHkocmVzb3VyY2VSb3V0ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGRldGVybWluZSByZXNvdXJjZSByb3V0ZSBieSB1cmw6ICR7IHVybCB9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc291cmNlUm91dGU7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgdXJsIHVzZSBiYXNlIGFuZCB0aGUgcmVzb3VyY2UgbmFtZS5cbiAgICpcbiAgICogQHBhcmFtIGJhc2VVcmwgd2lsbCBiZSBhcyBmaXJzdCBwYXJ0IGFzIGEgcmVzdWx0IHVybFxuICAgKiBAcGFyYW0gcmVzb3VyY2VOYW1lIGFkZGVkIHRvIHRoZSBiYXNlIHVybCB0aHJvdWdoIHNsYXNoXG4gICAqIEBwYXJhbSBxdWVyeSAob3B0aW9uYWwpIGlmIHBhc3NlZCB0aGVuIGFkZHMgdG8gZW5kIG9mIHRoZSB1cmxcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdlbmVyYXRlUmVzb3VyY2VVcmwoYmFzZVVybDogc3RyaW5nLCByZXNvdXJjZU5hbWU6IHN0cmluZywgcXVlcnk/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtiYXNlVXJsLCByZXNvdXJjZU5hbWV9KTtcblxuICAgIGxldCB1cmwgPSBiYXNlVXJsO1xuICAgIGlmICghdXJsLmVuZHNXaXRoKCcvJykpIHtcbiAgICAgIHVybCA9IHVybC5jb25jYXQoJy8nKTtcbiAgICB9XG4gICAgcmV0dXJuIHVybC5jb25jYXQocmVzb3VyY2VOYW1lKS5jb25jYXQocXVlcnkgPyBgJHsgcXVlcnkuc3RhcnRzV2l0aCgnLycpID8gcXVlcnkgOiAnLycgKyBxdWVyeSB9YCA6ICcnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZSBhIHJlc291cmNlIG5hbWUgZnJvbSByZXNvdXJjZSB1cmwuXG4gICAqXG4gICAqIEBwYXJhbSB1cmwgcmVzb3VyY2UgdXJsXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGdldFJlc291cmNlTmFtZUZyb21VcmwodXJsOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHt1cmx9KTtcbiAgICBjb25zdCBsb3dlckNhc2VVcmwgPSB1cmwudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCByZXNvdXJjZVJvdXRlID0gVXJsVXRpbHMuZ3Vlc3NSZXNvdXJjZVJvdXRlKHVybCk7XG5cbiAgICBsZXQgYmFzZVVybDtcbiAgICBpZiAobG93ZXJDYXNlVXJsLmluY2x1ZGVzKHJlc291cmNlUm91dGUucm9vdFVybCkpIHtcbiAgICAgIGJhc2VVcmwgPSByZXNvdXJjZVJvdXRlLnJvb3RVcmw7XG4gICAgfSBlbHNlIGlmICghaXNFbXB0eShyZXNvdXJjZVJvdXRlLnByb3h5VXJsKSAmJiBsb3dlckNhc2VVcmwuaW5jbHVkZXMocmVzb3VyY2VSb3V0ZS5wcm94eVVybCkpIHtcbiAgICAgIGJhc2VVcmwgPSByZXNvdXJjZVJvdXRlLnByb3h5VXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBkZXRlcm1pbmUgcmVzb3VyY2UgbmFtZSBmcm9tIHVybDogJHsgdXJsIH0sIGZvdW5kIHJlc291cmNlIHJvdXRlICR7IEpTT04uc3RyaW5naWZ5KHJlc291cmNlUm91dGUpIH1gKTtcbiAgICB9XG5cbiAgICBpZiAoIWJhc2VVcmwuZW5kc1dpdGgoJy8nKSkge1xuICAgICAgYmFzZVVybCA9IGJhc2VVcmwuY29uY2F0KCcvJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVybC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoYCR7IGJhc2VVcmwgfWAsICcnKS5zcGxpdCgnLycpWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHVybCBmcm9tIHRlbXBsYXRlIHBhcmFtcy5cbiAgICpcbiAgICogQHBhcmFtIHVybCB0byBiZSBjbGVhbmVkXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyByZW1vdmVUZW1wbGF0ZVBhcmFtcyh1cmw6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgVmFsaWRhdGlvblV0aWxzLnZhbGlkYXRlSW5wdXRQYXJhbXMoe3VybH0pO1xuXG4gICAgcmV0dXJuIFVybFV0aWxzLmZpbGxUZW1wbGF0ZVBhcmFtcyh1cmwsIHt9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgdXJsIHBhcmFtcy5cbiAgICpcbiAgICogQHBhcmFtIHVybCB0byBjbGVhciBwYXJhbXNcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGNsZWFyVXJsUGFyYW1zKHVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7dXJsfSk7XG4gICAgY29uc3Qgc3JjVXJsID0gbmV3IFVSTCh1cmwpO1xuXG4gICAgcmV0dXJuIHNyY1VybC5vcmlnaW4gKyBzcmNVcmwucGF0aG5hbWU7XG4gIH1cblxuICAvKipcbiAgICogRmlsbCB1cmwgdGVtcGxhdGUgcGFyYW1zLlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIGJlIGZpbGxlZFxuICAgKiBAcGFyYW0gb3B0aW9ucyBjb250YWlucyBwYXJhbXMgdG8gYXBwbHkgdG8gcmVzdWx0IHVybCwgaWYgZW1wdHkgdGhlbiB0ZW1wbGF0ZSBwYXJhbXMgd2lsbCBiZSBjbGVhcmVkXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBmaWxsVGVtcGxhdGVQYXJhbXModXJsOiBzdHJpbmcsIG9wdGlvbnM6IFBhZ2VkR2V0T3B0aW9uKTogc3RyaW5nIHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7dXJsfSk7XG4gICAgVXJsVXRpbHMuY2hlY2tEdXBsaWNhdGVQYXJhbXMob3B0aW9ucyk7XG5cbiAgICAvKlxuICAgICAgIFNvcnQgcGFyYW1zIHdpbGwgYmUgYXBwbGllZCB0aHJvdWdoIEh0dHAgcmVxdWVzdCBwYXJhbXMgbm90IHdpdGggdGVtcGxhdGUgcGFyYW1zXG4gICAgICAgYmVjYXVzZSBvZnRlbiBzb3J0IHBhcmFtcyBpcyBub3QgcHJlc2VudCBpbiB0ZW1wbGF0ZSBwYXJhbXMgdGhlbiBzb3J0IHBhcmFtcyBuZWVkIHRvIHB1dCB0aHJvdWdoIEh0dHAgcmVxdWVzdCBwYXJhbXMuXG4gICAgICAgQnV0IHdoZW4gc29ydCBwYXJhbXMgcHJlc2VudCBpbiB0ZW1wbGF0ZSBwYXJhbXMgd2UgbmVlZCB0byBhdm9pZCBkdXBsaWNhdGlvbiBzb3J0IHBhcmFtcyBmcm9tIEh0dHAgcmVxdWVzdCBwYXJhbXNcbiAgICAgICBhbmQgdGVtcGxhdGUgcGFyYW1zIHRoZXJlZm9yZSB3ZSBuZWVkIHRvIGFkZCBpdCBpbiBvbmUgcGxhY2UuXG4gICAgKi9cbiAgICBjb25zdCBwYXJhbXNXaXRob3V0U29ydFBhcmFtID0ge1xuICAgICAgLi4ub3B0aW9ucyxcbiAgICAgIC4uLm9wdGlvbnM/LnBhcmFtcyxcbiAgICAgIC4uLm9wdGlvbnM/LnBhZ2VQYXJhbXMsXG4gICAgfTtcbiAgICByZXR1cm4gbmV3IFVyaVRlbXBsYXRlKHVybCkuZmlsbChpc05pbChwYXJhbXNXaXRob3V0U29ydFBhcmFtKSA/IHt9IDogcGFyYW1zV2l0aG91dFNvcnRQYXJhbSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGZpbGxEZWZhdWx0UGFnZURhdGFJZk5vUHJlc2VudChvcHRpb25zOiBQYWdlZEdldE9wdGlvbikge1xuICAgIGNvbnN0IHBhZ2VkT3B0aW9ucyA9ICFpc0VtcHR5KG9wdGlvbnMpID8gb3B0aW9ucyA6IHt9O1xuICAgIGlmIChpc0VtcHR5KHBhZ2VkT3B0aW9ucy5wYWdlUGFyYW1zKSkge1xuICAgICAgcGFnZWRPcHRpb25zLnBhZ2VQYXJhbXMgPSBMaWJDb25maWcuZ2V0Q29uZmlnKCkucGFnaW5hdGlvbi5kZWZhdWx0UGFnZTtcbiAgICB9IGVsc2UgaWYgKCFwYWdlZE9wdGlvbnMucGFnZVBhcmFtcy5zaXplKSB7XG4gICAgICBwYWdlZE9wdGlvbnMucGFnZVBhcmFtcy5zaXplID0gTGliQ29uZmlnLmdldENvbmZpZygpLnBhZ2luYXRpb24uZGVmYXVsdFBhZ2Uuc2l6ZTtcbiAgICB9IGVsc2UgaWYgKCFwYWdlZE9wdGlvbnMucGFnZVBhcmFtcy5wYWdlKSB7XG4gICAgICBwYWdlZE9wdGlvbnMucGFnZVBhcmFtcy5wYWdlID0gTGliQ29uZmlnLmdldENvbmZpZygpLnBhZ2luYXRpb24uZGVmYXVsdFBhZ2UucGFnZTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGFnZWRPcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgZ2VuZXJhdGVTb3J0UGFyYW1zKHNvcnQ6IFNvcnQsIGh0dHBQYXJhbXM/OiBIdHRwUGFyYW1zKTogSHR0cFBhcmFtcyB7XG4gICAgbGV0IHJlc3VsdFBhcmFtcyA9IGh0dHBQYXJhbXMgPyBodHRwUGFyYW1zIDogbmV3IEh0dHBQYXJhbXMoKTtcbiAgICBpZiAoIWlzRW1wdHkoc29ydCkpIHtcbiAgICAgIGZvciAoY29uc3QgW3NvcnRQYXRoLCBzb3J0T3JkZXJdIG9mIE9iamVjdC5lbnRyaWVzKHNvcnQpKSB7XG4gICAgICAgIHJlc3VsdFBhcmFtcyA9IHJlc3VsdFBhcmFtcy5hcHBlbmQoJ3NvcnQnLCBgJHsgc29ydFBhdGggfSwkeyBzb3J0T3JkZXIgfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXN1bHRQYXJhbXM7XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBjaGVja0R1cGxpY2F0ZVBhcmFtcyhvcHRpb25zOiBHZXRPcHRpb24pOiB2b2lkIHtcbiAgICBpZiAoaXNFbXB0eShvcHRpb25zKSB8fCBpc0VtcHR5KG9wdGlvbnMucGFyYW1zKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoJ3BhZ2UnIGluIG9wdGlvbnMucGFyYW1zIHx8ICdzaXplJyBpbiBvcHRpb25zLnBhcmFtcykge1xuICAgICAgdGhyb3cgRXJyb3IoJ1BsZWFzZSwgcGFzcyBwYWdlIHBhcmFtcyBpbiBwYWdlIG9iamVjdCBrZXksIG5vdCB3aXRoIHBhcmFtcyBvYmplY3QhJyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRSb3V0ZUJ5TmFtZShyb3V0ZU5hbWU6IHN0cmluZyk6IFJlc291cmNlUm91dGUge1xuICAgIGNvbnN0IHJvdXRlID0gTGliQ29uZmlnLmdldENvbmZpZygpLmh0dHBbcm91dGVOYW1lXTtcbiAgICBpZiAoaXNFbXB0eShyb3V0ZSkpIHtcbiAgICAgIENvbnNvbGVMb2dnZXIuZXJyb3IoYE5vIFJlc291cmNlIHJvdXRlIGZvdW5kIGJ5IG5hbWU6ICckeyByb3V0ZU5hbWUgfScuIENoZWNrIHlvdSBjb25maWd1cmF0aW9uLiBSZWFkIG1vcmUgYWJvdXQgdGhpcyAuLi5gLCB7XG4gICAgICAgIGF2YWlsYWJsZVJvdXRlczogVXJsVXRpbHMuZ2V0Um91dGVzKClcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgRXJyb3IoYE5vIFJlc291cmNlIHJvdXRlIGZvdW5kIGJ5IG5hbWU6ICckeyByb3V0ZU5hbWUgfScuYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJvdXRlO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXRSb3V0ZXMoKTogTXVsdGlwbGVSZXNvdXJjZVJvdXRlcyB7XG4gICAgcmV0dXJuIExpYkNvbmZpZy5nZXRDb25maWcoKS5odHRwIGFzIE11bHRpcGxlUmVzb3VyY2VSb3V0ZXM7XG4gIH1cblxufVxuIl19