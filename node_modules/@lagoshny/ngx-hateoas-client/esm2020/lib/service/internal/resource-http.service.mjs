import { Injectable } from '@angular/core';
import { throwError as observableThrowError } from 'rxjs';
import { catchError, map } from 'rxjs/operators';
import { ResourceUtils } from '../../util/resource.utils';
import { DependencyInjector } from '../../util/dependency-injector';
import { UrlUtils } from '../../util/url.utils';
import { getResourceType, isResource } from '../../model/resource-type';
import { HttpExecutor } from '../http-executor';
import { LibConfig } from '../../config/lib-config';
import { Stage } from '../../logger/stage.enum';
import { StageLogger } from '../../logger/stage-logger';
import { ValidationUtils } from '../../util/validation.utils';
import { toString } from 'lodash-es';
import { CacheKey } from './cache/model/cache-key';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./cache/resource-cache.service";
/**
 * Get instance of the ResourceHttpService by Angular DependencyInjector.
 */
export function getResourceHttpService() {
    return DependencyInjector.get(ResourceHttpService);
}
/**
 * Service to perform HTTP requests to get {@link Resource} type.
 */
export class ResourceHttpService extends HttpExecutor {
    constructor(httpClient, cacheService) {
        super(httpClient, cacheService);
    }
    /**
     * Perform GET request to retrieve resource.
     *
     * @param url to perform request
     * @param options request options
     * @throws error when required params are not valid or returned resource type is not resource
     */
    get(url, options) {
        const httpOptions = UrlUtils.convertToHttpOptions(options);
        return super.getHttp(url, httpOptions, options?.useCache)
            .pipe(map((data) => {
            if (!isResource(data)) {
                if (LibConfig.getConfig().cache.enabled) {
                    this.cacheService.evictResource(CacheKey.of(url, httpOptions));
                }
                const errMsg = `You try to get wrong resource type: expected Resource type, actual ${getResourceType(data)} type.`;
                StageLogger.stageErrorLog(Stage.INIT_RESOURCE, {
                    options,
                    error: errMsg
                });
                throw new Error(errMsg);
            }
            return ResourceUtils.instantiateResource(data, httpOptions?.params?.has('projection'));
        }), catchError(error => observableThrowError(error)));
    }
    /**
     * Perform POST request.
     *
     * @param url to perform request
     * @param body request body
     * @param options request options
     * @throws error when required params are not valid
     */
    post(url, body, options) {
        return super.postHttp(url, body, UrlUtils.convertToHttpOptions(options))
            .pipe(map((data) => {
            if (isResource(data)) {
                return ResourceUtils.instantiateResource(data);
            }
            return data;
        }), catchError(error => observableThrowError(error)));
    }
    /**
     * Perform PUT request.
     *
     * @param url to perform request
     * @param body request body
     * @param options request options
     * @throws error when required params are not valid
     */
    put(url, body, options) {
        return super.putHttp(url, body, UrlUtils.convertToHttpOptions(options))
            .pipe(map((data) => {
            if (isResource(data)) {
                return ResourceUtils.instantiateResource(data);
            }
            return data;
        }), catchError(error => observableThrowError(error)));
    }
    /**
     * Perform PATCH request.
     *
     * @param url to perform request
     * @param body request body
     * @param options request options
     * @throws error when required params are not valid
     */
    patch(url, body, options) {
        return super.patchHttp(url, body, UrlUtils.convertToHttpOptions(options))
            .pipe(map((data) => {
            if (isResource(data)) {
                return ResourceUtils.instantiateResource(data);
            }
            return data;
        }), catchError(error => observableThrowError(error)));
    }
    /**
     * Perform DELETE request.
     *
     * @param url to perform request
     * @param options request options
     * @throws error when required params are not valid
     */
    delete(url, options) {
        return super.deleteHttp(url, {
            ...UrlUtils.convertToHttpOptions(options),
            observe: options?.observe ? options?.observe : 'response'
        })
            .pipe(map((data) => {
            if (isResource(data)) {
                return ResourceUtils.instantiateResource(data);
            }
            return data;
        }), catchError(error => observableThrowError(error)));
    }
    /**
     * Perform get resource request with url built by the resource name.
     *
     * @param resourceName used to build root url to the resource
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param id resource id
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    getResource(resourceName, resourceOptions, id, options) {
        ValidationUtils.validateInputParams({ resourceName, id });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName).concat('/', toString(id));
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', id: '${id}'`,
            options
        });
        return this.get(url, options);
    }
    /**
     * Perform POST resource request with url built by the resource name.
     *
     * @param resourceName to be post
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param body resource to create
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    postResource(resourceName, resourceOptions, body, options) {
        ValidationUtils.validateInputParams({ resourceName, body });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName);
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}'`,
            options
        });
        return this.post(url, body, options);
    }
    /**
     * Perform PATCH resource request with url built by the resource name and resource id.
     *
     * @param resourceName to be patched
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param id resource id
     * @param body contains data to patch resource properties
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    patchResource(resourceName, resourceOptions, id, body, options) {
        ValidationUtils.validateInputParams({ resourceName, id, body });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName, toString(id));
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', resourceId: '${id}'`,
            options
        });
        return this.patch(url, body, options);
    }
    /**
     * Perform PUT resource request with url built by the resource name and resource id.
     *
     * @param resourceName to be put
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param id resource id
     * @param body contains data to replace resource properties
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    putResource(resourceName, resourceOptions, id, body, options) {
        ValidationUtils.validateInputParams({ resourceName, id, body });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName, toString(id));
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', resourceId: '${id}'`,
            options
        });
        return this.put(url, body, options);
    }
    /**
     * Perform DELETE resource request with url built by the resource name and resource id.
     *
     * @param resourceName to be deleted
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param id resource id
     * @param options (optional) additional options that will be applied to the request
     * @throws error when required params are not valid
     */
    deleteResource(resourceName, resourceOptions, id, options) {
        ValidationUtils.validateInputParams({ resourceName, id });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName, toString(id));
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', resourceId: '${id}'`,
            options
        });
        return this.delete(url, options);
    }
    /**
     * Perform search single resource request with url built by the resource name.
     *
     * @param resourceName used to build root url to the resource
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param searchQuery name of the search method
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    search(resourceName, resourceOptions, searchQuery, options) {
        ValidationUtils.validateInputParams({ resourceName, searchQuery });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName)
            .concat('/search/' + searchQuery);
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', searchQuery: '${searchQuery}'`,
            options
        });
        return this.get(url, options);
    }
}
ResourceHttpService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceHttpService, deps: [{ token: i1.HttpClient }, { token: i2.ResourceCacheService }], target: i0.ɵɵFactoryTarget.Injectable });
ResourceHttpService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceHttpService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceHttpService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: i2.ResourceCacheService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtaHR0cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWhhdGVvYXMtY2xpZW50L3NyYy9saWIvc2VydmljZS9pbnRlcm5hbC9yZXNvdXJjZS1odHRwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsVUFBVSxJQUFJLG9CQUFvQixFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXRFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRTFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLFVBQVUsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXhFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNyQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0seUJBQXlCLENBQUM7Ozs7QUFJbkQ7O0dBRUc7QUFDSCxNQUFNLFVBQVUsc0JBQXNCO0lBQ3BDLE9BQU8sa0JBQWtCLENBQUMsR0FBRyxDQUFDLG1CQUFt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TUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFlBQVksQ0FBQzthQUNsRyxNQUFNLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQyxDQUFDO1FBRXBDLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUN0QyxNQUFNLEVBQUUsR0FBRztZQUNYLFFBQVEsRUFBRSxhQUFjLFFBQVEsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBRSxpQkFBa0IsWUFBYSxvQkFBcUIsV0FBWSxHQUFHO1lBQ3pJLE9BQU87U0FDUixDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7O2dIQTNSVSxtQkFBbUI7b0hBQW5CLG1CQUFtQixjQUZsQixNQUFNOzJGQUVQLG1CQUFtQjtrQkFIL0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCB0aHJvd0Vycm9yIGFzIG9ic2VydmFibGVUaHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmVzb3VyY2VVdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvcmVzb3VyY2UudXRpbHMnO1xuaW1wb3J0IHsgQmFzZVJlc291cmNlIH0gZnJvbSAnLi4vLi4vbW9kZWwvcmVzb3VyY2UvYmFzZS1yZXNvdXJjZSc7XG5pbXBvcnQgeyBEZXBlbmRlbmN5SW5qZWN0b3IgfSBmcm9tICcuLi8uLi91dGlsL2RlcGVuZGVuY3ktaW5qZWN0b3InO1xuaW1wb3J0IHsgVXJsVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3VybC51dGlscyc7XG5pbXBvcnQgeyBnZXRSZXNvdXJjZVR5cGUsIGlzUmVzb3VyY2UgfSBmcm9tICcuLi8uLi9tb2RlbC9yZXNvdXJjZS10eXBlJztcbmltcG9ydCB7IEdldE9wdGlvbiwgUmVxdWVzdE9wdGlvbiB9IGZyb20gJy4uLy4uL21vZGVsL2RlY2xhcmF0aW9ucyc7XG5pbXBvcnQgeyBIdHRwRXhlY3V0b3IgfSBmcm9tICcuLi9odHRwLWV4ZWN1dG9yJztcbmltcG9ydCB7IExpYkNvbmZpZyB9IGZyb20gJy4uLy4uL2NvbmZpZy9saWItY29uZmlnJztcbmltcG9ydCB7IFN0YWdlIH0gZnJvbSAnLi4vLi4vbG9nZ2VyL3N0YWdlLmVudW0nO1xuaW1wb3J0IHsgU3RhZ2VMb2dnZXIgfSBmcm9tICcuLi8uLi9sb2dnZXIvc3RhZ2UtbG9nZ2VyJztcbmltcG9ydCB7IFZhbGlkYXRpb25VdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvdmFsaWRhdGlvbi51dGlscyc7XG5pbXBvcnQgeyB0b1N0cmluZyB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBDYWNoZUtleSB9IGZyb20gJy4vY2FjaGUvbW9kZWwvY2FjaGUta2V5JztcbmltcG9ydCB7IFJlc291cmNlQ2FjaGVTZXJ2aWNlIH0gZnJvbSAnLi9jYWNoZS9yZXNvdXJjZS1jYWNoZS5zZXJ2aWNlJztcbmltcG9ydCB7IFJlc291cmNlT3B0aW9uIH0gZnJvbSAnLi4vLi4vY29uZmlnL2hhdGVvYXMtY29uZmlndXJhdGlvbi5pbnRlcmZhY2UnO1xuXG4vKipcbiAqIEdldCBpbnN0YW5jZSBvZiB0aGUgUmVzb3VyY2VIdHRwU2VydmljZSBieSBBbmd1bGFyIERlcGVuZGVuY3lJbmplY3Rvci5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFJlc291cmNlSHR0cFNlcnZpY2UoKTogUmVzb3VyY2VIdHRwU2VydmljZSB7XG4gIHJldHVybiBEZXBlbmRlbmN5SW5qZWN0b3IuZ2V0KFJlc291cmNlSHR0cFNlcnZpY2UpO1xufVxuXG4vKipcbiAqIFNlcnZpY2UgdG8gcGVyZm9ybSBIVFRQIHJlcXVlc3RzIHRvIGdldCB7QGxpbmsgUmVzb3VyY2V9IHR5cGUuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBSZXNvdXJjZUh0dHBTZXJ2aWNlIGV4dGVuZHMgSHR0cEV4ZWN1dG9yIHtcblxuICBjb25zdHJ1Y3RvcihodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgICAgICAgICAgICBjYWNoZVNlcnZpY2U6IFJlc291cmNlQ2FjaGVTZXJ2aWNlKSB7XG4gICAgc3VwZXIoaHR0cENsaWVudCwgY2FjaGVTZXJ2aWNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIEdFVCByZXF1ZXN0IHRvIHJldHJpZXZlIHJlc291cmNlLlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gb3B0aW9ucyByZXF1ZXN0IG9wdGlvbnNcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkIG9yIHJldHVybmVkIHJlc291cmNlIHR5cGUgaXMgbm90IHJlc291cmNlXG4gICAqL1xuICBwdWJsaWMgZ2V0PFQgZXh0ZW5kcyBCYXNlUmVzb3VyY2U+KHVybDogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBHZXRPcHRpb24pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBjb25zdCBodHRwT3B0aW9ucyA9IFVybFV0aWxzLmNvbnZlcnRUb0h0dHBPcHRpb25zKG9wdGlvbnMpO1xuICAgIHJldHVybiBzdXBlci5nZXRIdHRwKHVybCwgaHR0cE9wdGlvbnMsIG9wdGlvbnM/LnVzZUNhY2hlKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKCFpc1Jlc291cmNlKGRhdGEpKSB7XG4gICAgICAgICAgICBpZiAoTGliQ29uZmlnLmdldENvbmZpZygpLmNhY2hlLmVuYWJsZWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2UuZXZpY3RSZXNvdXJjZShDYWNoZUtleS5vZih1cmwsIGh0dHBPcHRpb25zKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBlcnJNc2cgPSBgWW91IHRyeSB0byBnZXQgd3JvbmcgcmVzb3VyY2UgdHlwZTogZXhwZWN0ZWQgUmVzb3VyY2UgdHlwZSwgYWN0dWFsICR7IGdldFJlc291cmNlVHlwZShkYXRhKSB9IHR5cGUuYDtcbiAgICAgICAgICAgIFN0YWdlTG9nZ2VyLnN0YWdlRXJyb3JMb2coU3RhZ2UuSU5JVF9SRVNPVVJDRSwge1xuICAgICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgICBlcnJvcjogZXJyTXNnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBSZXNvdXJjZVV0aWxzLmluc3RhbnRpYXRlUmVzb3VyY2UoZGF0YSwgaHR0cE9wdGlvbnM/LnBhcmFtcz8uaGFzKCdwcm9qZWN0aW9uJykpIGFzIFQ7XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IG9ic2VydmFibGVUaHJvd0Vycm9yKGVycm9yKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gUE9TVCByZXF1ZXN0LlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gYm9keSByZXF1ZXN0IGJvZHlcbiAgICogQHBhcmFtIG9wdGlvbnMgcmVxdWVzdCBvcHRpb25zXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHBvc3QodXJsOiBzdHJpbmcsIGJvZHk6IGFueSB8IG51bGwsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gc3VwZXIucG9zdEh0dHAodXJsLCBib2R5LCBVcmxVdGlscy5jb252ZXJ0VG9IdHRwT3B0aW9ucyhvcHRpb25zKSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgIGlmIChpc1Jlc291cmNlKGRhdGEpKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzb3VyY2VVdGlscy5pbnN0YW50aWF0ZVJlc291cmNlKGRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfSksXG4gICAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4gb2JzZXJ2YWJsZVRocm93RXJyb3IoZXJyb3IpKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFBVVCByZXF1ZXN0LlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gYm9keSByZXF1ZXN0IGJvZHlcbiAgICogQHBhcmFtIG9wdGlvbnMgcmVxdWVzdCBvcHRpb25zXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHB1dCh1cmw6IHN0cmluZywgYm9keTogYW55IHwgbnVsbCwgb3B0aW9ucz86IFJlcXVlc3RPcHRpb24pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBzdXBlci5wdXRIdHRwKHVybCwgYm9keSwgVXJsVXRpbHMuY29udmVydFRvSHR0cE9wdGlvbnMob3B0aW9ucykpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAoaXNSZXNvdXJjZShkYXRhKSkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc291cmNlVXRpbHMuaW5zdGFudGlhdGVSZXNvdXJjZShkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IG9ic2VydmFibGVUaHJvd0Vycm9yKGVycm9yKSlcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBQQVRDSCByZXF1ZXN0LlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gYm9keSByZXF1ZXN0IGJvZHlcbiAgICogQHBhcmFtIG9wdGlvbnMgcmVxdWVzdCBvcHRpb25zXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHBhdGNoKHVybDogc3RyaW5nLCBib2R5OiBhbnkgfCBudWxsLCBvcHRpb25zPzogUmVxdWVzdE9wdGlvbik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHN1cGVyLnBhdGNoSHR0cCh1cmwsIGJvZHksIFVybFV0aWxzLmNvbnZlcnRUb0h0dHBPcHRpb25zKG9wdGlvbnMpKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKGlzUmVzb3VyY2UoZGF0YSkpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVV0aWxzLmluc3RhbnRpYXRlUmVzb3VyY2UoZGF0YSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pLFxuICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IG9ic2VydmFibGVUaHJvd0Vycm9yKGVycm9yKSlcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBERUxFVEUgcmVxdWVzdC5cbiAgICpcbiAgICogQHBhcmFtIHVybCB0byBwZXJmb3JtIHJlcXVlc3RcbiAgICogQHBhcmFtIG9wdGlvbnMgcmVxdWVzdCBvcHRpb25zXG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIGRlbGV0ZSh1cmw6IHN0cmluZywgb3B0aW9ucz86IFJlcXVlc3RPcHRpb24pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBzdXBlci5kZWxldGVIdHRwKHVybCwge1xuICAgICAgLi4uVXJsVXRpbHMuY29udmVydFRvSHR0cE9wdGlvbnMob3B0aW9ucyksXG4gICAgICBvYnNlcnZlOiBvcHRpb25zPy5vYnNlcnZlID8gb3B0aW9ucz8ub2JzZXJ2ZSA6ICdyZXNwb25zZSdcbiAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKGlzUmVzb3VyY2UoZGF0YSkpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXNvdXJjZVV0aWxzLmluc3RhbnRpYXRlUmVzb3VyY2UoZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiBvYnNlcnZhYmxlVGhyb3dFcnJvcihlcnJvcikpXG4gICAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gZ2V0IHJlc291cmNlIHJlcXVlc3Qgd2l0aCB1cmwgYnVpbHQgYnkgdGhlIHJlc291cmNlIG5hbWUuXG4gICAqXG4gICAqIEBwYXJhbSByZXNvdXJjZU5hbWUgdXNlZCB0byBidWlsZCByb290IHVybCB0byB0aGUgcmVzb3VyY2VcbiAgICogQHBhcmFtIHJlc291cmNlT3B0aW9ucyBhZGRpdGlvbmFsIHJlc291cmNlIG9wdGlvbnMge0BsaW5rIFJlc291cmNlT3B0aW9ufVxuICAgKiBAcGFyYW0gaWQgcmVzb3VyY2UgaWRcbiAgICogQHBhcmFtIG9wdGlvbnMgKG9wdGlvbmFsKSBvcHRpb25zIHRoYXQgYXBwbGllZCB0byB0aGUgcmVxdWVzdFxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWRcbiAgICovXG4gIHB1YmxpYyBnZXRSZXNvdXJjZTxUIGV4dGVuZHMgQmFzZVJlc291cmNlPihyZXNvdXJjZU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlT3B0aW9uczogUmVzb3VyY2VPcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogbnVtYmVyIHwgc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucz86IEdldE9wdGlvbik6IE9ic2VydmFibGU8VD4ge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtyZXNvdXJjZU5hbWUsIGlkfSk7XG5cbiAgICBjb25zdCB1cmwgPSBVcmxVdGlscy5nZW5lcmF0ZVJlc291cmNlVXJsKFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSwgcmVzb3VyY2VOYW1lKS5jb25jYXQoJy8nLCB0b1N0cmluZyhpZCkpO1xuXG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUFJFUEFSRV9VUkwsIHtcbiAgICAgIHJlc3VsdDogdXJsLFxuICAgICAgdXJsUGFydHM6IGBiYXNlVXJsOiAnJHsgVXJsVXRpbHMuZ2V0QXBpVXJsKHJlc291cmNlT3B0aW9ucy5yb3V0ZU5hbWUpIH0nLCByZXNvdXJjZTogJyR7IHJlc291cmNlTmFtZSB9JywgaWQ6ICckeyBpZCB9J2AsXG4gICAgICBvcHRpb25zXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5nZXQodXJsLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFBPU1QgcmVzb3VyY2UgcmVxdWVzdCB3aXRoIHVybCBidWlsdCBieSB0aGUgcmVzb3VyY2UgbmFtZS5cbiAgICpcbiAgICogQHBhcmFtIHJlc291cmNlTmFtZSB0byBiZSBwb3N0XG4gICAqIEBwYXJhbSByZXNvdXJjZU9wdGlvbnMgYWRkaXRpb25hbCByZXNvdXJjZSBvcHRpb25zIHtAbGluayBSZXNvdXJjZU9wdGlvbn1cbiAgICogQHBhcmFtIGJvZHkgcmVzb3VyY2UgdG8gY3JlYXRlXG4gICAqIEBwYXJhbSBvcHRpb25zIChvcHRpb25hbCkgb3B0aW9ucyB0aGF0IGFwcGxpZWQgdG8gdGhlIHJlcXVlc3RcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgcG9zdFJlc291cmNlKHJlc291cmNlTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlT3B0aW9uczogUmVzb3VyY2VPcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgYm9keTogQmFzZVJlc291cmNlLFxuICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVzb3VyY2VOYW1lLCBib2R5fSk7XG5cbiAgICBjb25zdCB1cmwgPSBVcmxVdGlscy5nZW5lcmF0ZVJlc291cmNlVXJsKFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSwgcmVzb3VyY2VOYW1lKTtcblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICByZXN1bHQ6IHVybCxcbiAgICAgIHVybFBhcnRzOiBgYmFzZVVybDogJyR7IFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSB9JywgcmVzb3VyY2U6ICckeyByZXNvdXJjZU5hbWUgfSdgLFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMucG9zdCh1cmwsIGJvZHksIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gUEFUQ0ggcmVzb3VyY2UgcmVxdWVzdCB3aXRoIHVybCBidWlsdCBieSB0aGUgcmVzb3VyY2UgbmFtZSBhbmQgcmVzb3VyY2UgaWQuXG4gICAqXG4gICAqIEBwYXJhbSByZXNvdXJjZU5hbWUgdG8gYmUgcGF0Y2hlZFxuICAgKiBAcGFyYW0gcmVzb3VyY2VPcHRpb25zIGFkZGl0aW9uYWwgcmVzb3VyY2Ugb3B0aW9ucyB7QGxpbmsgUmVzb3VyY2VPcHRpb259XG4gICAqIEBwYXJhbSBpZCByZXNvdXJjZSBpZFxuICAgKiBAcGFyYW0gYm9keSBjb250YWlucyBkYXRhIHRvIHBhdGNoIHJlc291cmNlIHByb3BlcnRpZXNcbiAgICogQHBhcmFtIG9wdGlvbnMgKG9wdGlvbmFsKSBvcHRpb25zIHRoYXQgYXBwbGllZCB0byB0aGUgcmVxdWVzdFxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWRcbiAgICovXG4gIHB1YmxpYyBwYXRjaFJlc291cmNlKHJlc291cmNlTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZU9wdGlvbnM6IFJlc291cmNlT3B0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICBpZDogbnVtYmVyIHwgc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBhbnksXG4gICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVzb3VyY2VOYW1lLCBpZCwgYm9keX0pO1xuXG4gICAgY29uc3QgdXJsID0gVXJsVXRpbHMuZ2VuZXJhdGVSZXNvdXJjZVVybChVcmxVdGlscy5nZXRBcGlVcmwocmVzb3VyY2VPcHRpb25zLnJvdXRlTmFtZSksIHJlc291cmNlTmFtZSwgdG9TdHJpbmcoaWQpKTtcblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICByZXN1bHQ6IHVybCxcbiAgICAgIHVybFBhcnRzOiBgYmFzZVVybDogJyR7IFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSB9JywgcmVzb3VyY2U6ICckeyByZXNvdXJjZU5hbWUgfScsIHJlc291cmNlSWQ6ICckeyBpZCB9J2AsXG4gICAgICBvcHRpb25zXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5wYXRjaCh1cmwsIGJvZHksIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gUFVUIHJlc291cmNlIHJlcXVlc3Qgd2l0aCB1cmwgYnVpbHQgYnkgdGhlIHJlc291cmNlIG5hbWUgYW5kIHJlc291cmNlIGlkLlxuICAgKlxuICAgKiBAcGFyYW0gcmVzb3VyY2VOYW1lIHRvIGJlIHB1dFxuICAgKiBAcGFyYW0gcmVzb3VyY2VPcHRpb25zIGFkZGl0aW9uYWwgcmVzb3VyY2Ugb3B0aW9ucyB7QGxpbmsgUmVzb3VyY2VPcHRpb259XG4gICAqIEBwYXJhbSBpZCByZXNvdXJjZSBpZFxuICAgKiBAcGFyYW0gYm9keSBjb250YWlucyBkYXRhIHRvIHJlcGxhY2UgcmVzb3VyY2UgcHJvcGVydGllc1xuICAgKiBAcGFyYW0gb3B0aW9ucyAob3B0aW9uYWwpIG9wdGlvbnMgdGhhdCBhcHBsaWVkIHRvIHRoZSByZXF1ZXN0XG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHB1dFJlc291cmNlKHJlc291cmNlTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VPcHRpb25zOiBSZXNvdXJjZU9wdGlvbixcbiAgICAgICAgICAgICAgICAgICAgIGlkOiBudW1iZXIgfCBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICBib2R5OiBhbnksXG4gICAgICAgICAgICAgICAgICAgICBvcHRpb25zPzogUmVxdWVzdE9wdGlvbik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgVmFsaWRhdGlvblV0aWxzLnZhbGlkYXRlSW5wdXRQYXJhbXMoe3Jlc291cmNlTmFtZSwgaWQsIGJvZHl9KTtcblxuICAgIGNvbnN0IHVybCA9IFVybFV0aWxzLmdlbmVyYXRlUmVzb3VyY2VVcmwoVXJsVXRpbHMuZ2V0QXBpVXJsKHJlc291cmNlT3B0aW9ucy5yb3V0ZU5hbWUpLCByZXNvdXJjZU5hbWUsIHRvU3RyaW5nKGlkKSk7XG5cbiAgICBTdGFnZUxvZ2dlci5zdGFnZUxvZyhTdGFnZS5QUkVQQVJFX1VSTCwge1xuICAgICAgcmVzdWx0OiB1cmwsXG4gICAgICB1cmxQYXJ0czogYGJhc2VVcmw6ICckeyBVcmxVdGlscy5nZXRBcGlVcmwocmVzb3VyY2VPcHRpb25zLnJvdXRlTmFtZSkgfScsIHJlc291cmNlOiAnJHsgcmVzb3VyY2VOYW1lIH0nLCByZXNvdXJjZUlkOiAnJHsgaWQgfSdgLFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMucHV0KHVybCwgYm9keSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBERUxFVEUgcmVzb3VyY2UgcmVxdWVzdCB3aXRoIHVybCBidWlsdCBieSB0aGUgcmVzb3VyY2UgbmFtZSBhbmQgcmVzb3VyY2UgaWQuXG4gICAqXG4gICAqIEBwYXJhbSByZXNvdXJjZU5hbWUgdG8gYmUgZGVsZXRlZFxuICAgKiBAcGFyYW0gcmVzb3VyY2VPcHRpb25zIGFkZGl0aW9uYWwgcmVzb3VyY2Ugb3B0aW9ucyB7QGxpbmsgUmVzb3VyY2VPcHRpb259XG4gICAqIEBwYXJhbSBpZCByZXNvdXJjZSBpZFxuICAgKiBAcGFyYW0gb3B0aW9ucyAob3B0aW9uYWwpIGFkZGl0aW9uYWwgb3B0aW9ucyB0aGF0IHdpbGwgYmUgYXBwbGllZCB0byB0aGUgcmVxdWVzdFxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWRcbiAgICovXG4gIHB1YmxpYyBkZWxldGVSZXNvdXJjZShyZXNvdXJjZU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlT3B0aW9uczogUmVzb3VyY2VPcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogbnVtYmVyIHwgc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucz86IFJlcXVlc3RPcHRpb24pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtyZXNvdXJjZU5hbWUsIGlkfSk7XG5cbiAgICBjb25zdCB1cmwgPSBVcmxVdGlscy5nZW5lcmF0ZVJlc291cmNlVXJsKFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSwgcmVzb3VyY2VOYW1lLCB0b1N0cmluZyhpZCkpO1xuXG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUFJFUEFSRV9VUkwsIHtcbiAgICAgIHJlc3VsdDogdXJsLFxuICAgICAgdXJsUGFydHM6IGBiYXNlVXJsOiAnJHsgVXJsVXRpbHMuZ2V0QXBpVXJsKHJlc291cmNlT3B0aW9ucy5yb3V0ZU5hbWUpIH0nLCByZXNvdXJjZTogJyR7IHJlc291cmNlTmFtZSB9JywgcmVzb3VyY2VJZDogJyR7IGlkIH0nYCxcbiAgICAgIG9wdGlvbnNcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmRlbGV0ZSh1cmwsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gc2VhcmNoIHNpbmdsZSByZXNvdXJjZSByZXF1ZXN0IHdpdGggdXJsIGJ1aWx0IGJ5IHRoZSByZXNvdXJjZSBuYW1lLlxuICAgKlxuICAgKiBAcGFyYW0gcmVzb3VyY2VOYW1lIHVzZWQgdG8gYnVpbGQgcm9vdCB1cmwgdG8gdGhlIHJlc291cmNlXG4gICAqIEBwYXJhbSByZXNvdXJjZU9wdGlvbnMgYWRkaXRpb25hbCByZXNvdXJjZSBvcHRpb25zIHtAbGluayBSZXNvdXJjZU9wdGlvbn1cbiAgICogQHBhcmFtIHNlYXJjaFF1ZXJ5IG5hbWUgb2YgdGhlIHNlYXJjaCBtZXRob2RcbiAgICogQHBhcmFtIG9wdGlvbnMgKG9wdGlvbmFsKSBvcHRpb25zIHRoYXQgYXBwbGllZCB0byB0aGUgcmVxdWVzdFxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWRcbiAgICovXG4gIHB1YmxpYyBzZWFyY2g8VCBleHRlbmRzIEJhc2VSZXNvdXJjZT4ocmVzb3VyY2VOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VPcHRpb25zOiBSZXNvdXJjZU9wdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hRdWVyeTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBHZXRPcHRpb24pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVzb3VyY2VOYW1lLCBzZWFyY2hRdWVyeX0pO1xuXG4gICAgY29uc3QgdXJsID0gVXJsVXRpbHMuZ2VuZXJhdGVSZXNvdXJjZVVybChVcmxVdGlscy5nZXRBcGlVcmwocmVzb3VyY2VPcHRpb25zLnJvdXRlTmFtZSksIHJlc291cmNlTmFtZSlcbiAgICAgIC5jb25jYXQoJy9zZWFyY2gvJyArIHNlYXJjaFF1ZXJ5KTtcblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICByZXN1bHQ6IHVybCxcbiAgICAgIHVybFBhcnRzOiBgYmFzZVVybDogJyR7IFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSB9JywgcmVzb3VyY2U6ICckeyByZXNvdXJjZU5hbWUgfScsIHNlYXJjaFF1ZXJ5OiAnJHsgc2VhcmNoUXVlcnkgfSdgLFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0KHVybCwgb3B0aW9ucyk7XG4gIH1cblxufVxuIl19