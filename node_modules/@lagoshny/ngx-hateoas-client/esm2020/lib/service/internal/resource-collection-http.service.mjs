import { Injectable } from '@angular/core';
import { LibConfig } from '../../config/lib-config';
import { throwError as observableThrowError } from 'rxjs';
import { catchError, map } from 'rxjs/operators';
import { getResourceType, isResourceCollection } from '../../model/resource-type';
import { ResourceUtils } from '../../util/resource.utils';
import { DependencyInjector } from '../../util/dependency-injector';
import { UrlUtils } from '../../util/url.utils';
import { HttpExecutor } from '../http-executor';
import { StageLogger } from '../../logger/stage-logger';
import { Stage } from '../../logger/stage.enum';
import { ValidationUtils } from '../../util/validation.utils';
import { CacheKey } from './cache/model/cache-key';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./cache/resource-cache.service";
export function getResourceCollectionHttpService() {
    return DependencyInjector.get(ResourceCollectionHttpService);
}
/**
 * Service to perform HTTP requests to get {@link ResourceCollection} type.
 */
export class ResourceCollectionHttpService extends HttpExecutor {
    constructor(httpClient, cacheService) {
        super(httpClient, cacheService);
    }
    /**
     * Perform GET request to retrieve collection of the resources.
     *
     * @param url to perform request
     * @param options request options
     * @throws error when required params are not valid or returned resource type is not collection of the resources
     */
    get(url, options) {
        const httpOptions = UrlUtils.convertToHttpOptions(options);
        return super.getHttp(url, httpOptions, options?.useCache)
            .pipe(map((data) => {
            if (!isResourceCollection(data)) {
                if (LibConfig.getConfig().cache.enabled) {
                    this.cacheService.evictResource(CacheKey.of(url, httpOptions));
                }
                const errMsg = `You try to get the wrong resource type: expected ResourceCollection type, actual ${getResourceType(data)} type.`;
                StageLogger.stageErrorLog(Stage.INIT_RESOURCE, { error: errMsg, options });
                throw new Error(errMsg);
            }
            return ResourceUtils.instantiateResourceCollection(data, httpOptions?.params?.has('projection'));
        }), catchError(error => observableThrowError(error)));
    }
    /**
     * Perform get resource collection request with url built by the resource name.
     *
     * @param resourceName used to build root url to the resource
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    getResourceCollection(resourceName, resourceOptions, options) {
        ValidationUtils.validateInputParams({ resourceName });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName);
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}'`,
            options
        });
        return this.get(url, options);
    }
    /**
     *  Perform search resource collection request with url built by the resource name.
     *
     * @param resourceName used to build root url to the resource
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param searchQuery name of the search method
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    search(resourceName, resourceOptions, searchQuery, options) {
        ValidationUtils.validateInputParams({ resourceName, searchQuery });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName)
            .concat('/search/' + searchQuery);
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', searchQuery: '${searchQuery}'`,
            options
        });
        return this.get(url, options);
    }
}
ResourceCollectionHttpService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceCollectionHttpService, deps: [{ token: i1.HttpClient }, { token: i2.ResourceCacheService }], target: i0.ɵɵFactoryTarget.Injectable });
ResourceCollectionHttpService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceCollectionHttpService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceCollectionHttpService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: i2.ResourceCacheService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtY29sbGVjdGlvbi1odHRwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtaGF0ZW9hcy1jbGllbnQvc3JjL2xpYi9zZXJ2aWNlL2ludGVybmFsL3Jlc291cmNlLWNvbGxlY3Rpb24taHR0cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBYyxVQUFVLElBQUksb0JBQW9CLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZUFBZSxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRzFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRXBFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7O0FBSW5ELE1BQU0sVUFBVSxnQ0FBZ0M7SUFDOUMsT0FBTyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztBQUMvRCxDQUFDO0FBRUQ7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cUIsV0FBWSxHQUFHO1lBQ3pJLE9BQU87U0FDUixDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7OzBIQXBGVSw2QkFBNkI7OEhBQTdCLDZCQUE2QixjQUY1QixNQUFNOzJGQUVQLDZCQUE2QjtrQkFIekMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTGliQ29uZmlnIH0gZnJvbSAnLi4vLi4vY29uZmlnL2xpYi1jb25maWcnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciBhcyBvYnNlcnZhYmxlVGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZ2V0UmVzb3VyY2VUeXBlLCBpc1Jlc291cmNlQ29sbGVjdGlvbiB9IGZyb20gJy4uLy4uL21vZGVsL3Jlc291cmNlLXR5cGUnO1xuaW1wb3J0IHsgUmVzb3VyY2VVdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvcmVzb3VyY2UudXRpbHMnO1xuaW1wb3J0IHsgUmVzb3VyY2VDb2xsZWN0aW9uIH0gZnJvbSAnLi4vLi4vbW9kZWwvcmVzb3VyY2UvcmVzb3VyY2UtY29sbGVjdGlvbic7XG5pbXBvcnQgeyBCYXNlUmVzb3VyY2UgfSBmcm9tICcuLi8uLi9tb2RlbC9yZXNvdXJjZS9iYXNlLXJlc291cmNlJztcbmltcG9ydCB7IERlcGVuZGVuY3lJbmplY3RvciB9IGZyb20gJy4uLy4uL3V0aWwvZGVwZW5kZW5jeS1pbmplY3Rvcic7XG5pbXBvcnQgeyBHZXRPcHRpb24gfSBmcm9tICcuLi8uLi9tb2RlbC9kZWNsYXJhdGlvbnMnO1xuaW1wb3J0IHsgVXJsVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3VybC51dGlscyc7XG5pbXBvcnQgeyBIdHRwRXhlY3V0b3IgfSBmcm9tICcuLi9odHRwLWV4ZWN1dG9yJztcbmltcG9ydCB7IFN0YWdlTG9nZ2VyIH0gZnJvbSAnLi4vLi4vbG9nZ2VyL3N0YWdlLWxvZ2dlcic7XG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uLy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcbmltcG9ydCB7IFZhbGlkYXRpb25VdGlscyB9IGZyb20gJy4uLy4uL3V0aWwvdmFsaWRhdGlvbi51dGlscyc7XG5pbXBvcnQgeyBDYWNoZUtleSB9IGZyb20gJy4vY2FjaGUvbW9kZWwvY2FjaGUta2V5JztcbmltcG9ydCB7IFJlc291cmNlQ2FjaGVTZXJ2aWNlIH0gZnJvbSAnLi9jYWNoZS9yZXNvdXJjZS1jYWNoZS5zZXJ2aWNlJztcbmltcG9ydCB7IFJlc291cmNlT3B0aW9uIH0gZnJvbSAnLi4vLi4vY29uZmlnL2hhdGVvYXMtY29uZmlndXJhdGlvbi5pbnRlcmZhY2UnO1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVzb3VyY2VDb2xsZWN0aW9uSHR0cFNlcnZpY2UoKTogUmVzb3VyY2VDb2xsZWN0aW9uSHR0cFNlcnZpY2Uge1xuICByZXR1cm4gRGVwZW5kZW5jeUluamVjdG9yLmdldChSZXNvdXJjZUNvbGxlY3Rpb25IdHRwU2VydmljZSk7XG59XG5cbi8qKlxuICogU2VydmljZSB0byBwZXJmb3JtIEhUVFAgcmVxdWVzdHMgdG8gZ2V0IHtAbGluayBSZXNvdXJjZUNvbGxlY3Rpb259IHR5cGUuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBSZXNvdXJjZUNvbGxlY3Rpb25IdHRwU2VydmljZSBleHRlbmRzIEh0dHBFeGVjdXRvciB7XG5cbiAgY29uc3RydWN0b3IoaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICAgICAgICAgICAgY2FjaGVTZXJ2aWNlOiBSZXNvdXJjZUNhY2hlU2VydmljZSkge1xuICAgIHN1cGVyKGh0dHBDbGllbnQsIGNhY2hlU2VydmljZSk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBHRVQgcmVxdWVzdCB0byByZXRyaWV2ZSBjb2xsZWN0aW9uIG9mIHRoZSByZXNvdXJjZXMuXG4gICAqXG4gICAqIEBwYXJhbSB1cmwgdG8gcGVyZm9ybSByZXF1ZXN0XG4gICAqIEBwYXJhbSBvcHRpb25zIHJlcXVlc3Qgb3B0aW9uc1xuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWQgb3IgcmV0dXJuZWQgcmVzb3VyY2UgdHlwZSBpcyBub3QgY29sbGVjdGlvbiBvZiB0aGUgcmVzb3VyY2VzXG4gICAqL1xuICBwdWJsaWMgZ2V0PFQgZXh0ZW5kcyBSZXNvdXJjZUNvbGxlY3Rpb248QmFzZVJlc291cmNlPj4odXJsOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zPzogR2V0T3B0aW9uKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgY29uc3QgaHR0cE9wdGlvbnMgPSBVcmxVdGlscy5jb252ZXJ0VG9IdHRwT3B0aW9ucyhvcHRpb25zKTtcblxuICAgIHJldHVybiBzdXBlci5nZXRIdHRwKHVybCwgaHR0cE9wdGlvbnMsIG9wdGlvbnM/LnVzZUNhY2hlKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKCFpc1Jlc291cmNlQ29sbGVjdGlvbihkYXRhKSkge1xuICAgICAgICAgICAgaWYgKExpYkNvbmZpZy5nZXRDb25maWcoKS5jYWNoZS5lbmFibGVkKSB7XG4gICAgICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLmV2aWN0UmVzb3VyY2UoQ2FjaGVLZXkub2YodXJsLCBodHRwT3B0aW9ucykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZXJyTXNnID0gYFlvdSB0cnkgdG8gZ2V0IHRoZSB3cm9uZyByZXNvdXJjZSB0eXBlOiBleHBlY3RlZCBSZXNvdXJjZUNvbGxlY3Rpb24gdHlwZSwgYWN0dWFsICR7IGdldFJlc291cmNlVHlwZShkYXRhKSB9IHR5cGUuYDtcbiAgICAgICAgICAgIFN0YWdlTG9nZ2VyLnN0YWdlRXJyb3JMb2coU3RhZ2UuSU5JVF9SRVNPVVJDRSwge2Vycm9yOiBlcnJNc2csIG9wdGlvbnN9KTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBSZXNvdXJjZVV0aWxzLmluc3RhbnRpYXRlUmVzb3VyY2VDb2xsZWN0aW9uKGRhdGEsIGh0dHBPcHRpb25zPy5wYXJhbXM/LmhhcygncHJvamVjdGlvbicpKSBhcyBUO1xuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiBvYnNlcnZhYmxlVGhyb3dFcnJvcihlcnJvcikpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIGdldCByZXNvdXJjZSBjb2xsZWN0aW9uIHJlcXVlc3Qgd2l0aCB1cmwgYnVpbHQgYnkgdGhlIHJlc291cmNlIG5hbWUuXG4gICAqXG4gICAqIEBwYXJhbSByZXNvdXJjZU5hbWUgdXNlZCB0byBidWlsZCByb290IHVybCB0byB0aGUgcmVzb3VyY2VcbiAgICogQHBhcmFtIHJlc291cmNlT3B0aW9ucyBhZGRpdGlvbmFsIHJlc291cmNlIG9wdGlvbnMge0BsaW5rIFJlc291cmNlT3B0aW9ufVxuICAgKiBAcGFyYW0gb3B0aW9ucyAob3B0aW9uYWwpIG9wdGlvbnMgdGhhdCBhcHBsaWVkIHRvIHRoZSByZXF1ZXN0XG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIGdldFJlc291cmNlQ29sbGVjdGlvbjxUIGV4dGVuZHMgUmVzb3VyY2VDb2xsZWN0aW9uPEJhc2VSZXNvdXJjZT4+KHJlc291cmNlTmFtZTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VPcHRpb25zOiBSZXNvdXJjZU9wdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBHZXRPcHRpb24pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVzb3VyY2VOYW1lfSk7XG5cbiAgICBjb25zdCB1cmwgPSBVcmxVdGlscy5nZW5lcmF0ZVJlc291cmNlVXJsKFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSwgcmVzb3VyY2VOYW1lKTtcblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICByZXN1bHQ6IHVybCxcbiAgICAgIHVybFBhcnRzOiBgYmFzZVVybDogJyR7IFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSB9JywgcmVzb3VyY2U6ICckeyByZXNvdXJjZU5hbWUgfSdgLFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0KHVybCwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogIFBlcmZvcm0gc2VhcmNoIHJlc291cmNlIGNvbGxlY3Rpb24gcmVxdWVzdCB3aXRoIHVybCBidWlsdCBieSB0aGUgcmVzb3VyY2UgbmFtZS5cbiAgICpcbiAgICogQHBhcmFtIHJlc291cmNlTmFtZSB1c2VkIHRvIGJ1aWxkIHJvb3QgdXJsIHRvIHRoZSByZXNvdXJjZVxuICAgKiBAcGFyYW0gcmVzb3VyY2VPcHRpb25zIGFkZGl0aW9uYWwgcmVzb3VyY2Ugb3B0aW9ucyB7QGxpbmsgUmVzb3VyY2VPcHRpb259XG4gICAqIEBwYXJhbSBzZWFyY2hRdWVyeSBuYW1lIG9mIHRoZSBzZWFyY2ggbWV0aG9kXG4gICAqIEBwYXJhbSBvcHRpb25zIChvcHRpb25hbCkgb3B0aW9ucyB0aGF0IGFwcGxpZWQgdG8gdGhlIHJlcXVlc3RcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgc2VhcmNoPFQgZXh0ZW5kcyBSZXNvdXJjZUNvbGxlY3Rpb248QmFzZVJlc291cmNlPj4ocmVzb3VyY2VOYW1lOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZU9wdGlvbnM6IFJlc291cmNlT3B0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoUXVlcnk6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBHZXRPcHRpb24pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7cmVzb3VyY2VOYW1lLCBzZWFyY2hRdWVyeX0pO1xuXG4gICAgY29uc3QgdXJsID0gVXJsVXRpbHMuZ2VuZXJhdGVSZXNvdXJjZVVybChVcmxVdGlscy5nZXRBcGlVcmwocmVzb3VyY2VPcHRpb25zLnJvdXRlTmFtZSksIHJlc291cmNlTmFtZSlcbiAgICAgIC5jb25jYXQoJy9zZWFyY2gvJyArIHNlYXJjaFF1ZXJ5KTtcblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLlBSRVBBUkVfVVJMLCB7XG4gICAgICByZXN1bHQ6IHVybCxcbiAgICAgIHVybFBhcnRzOiBgYmFzZVVybDogJyR7IFVybFV0aWxzLmdldEFwaVVybChyZXNvdXJjZU9wdGlvbnMucm91dGVOYW1lKSB9JywgcmVzb3VyY2U6ICckeyByZXNvdXJjZU5hbWUgfScsIHNlYXJjaFF1ZXJ5OiAnJHsgc2VhcmNoUXVlcnkgfSdgLFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZ2V0KHVybCwgb3B0aW9ucyk7XG4gIH1cblxufVxuIl19