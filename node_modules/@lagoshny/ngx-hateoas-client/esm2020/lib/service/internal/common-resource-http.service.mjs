import { HttpExecutor } from '../http-executor';
import { Injectable } from '@angular/core';
import { throwError as observableThrowError } from 'rxjs';
import { HttpMethod } from '../../model/declarations';
import { UrlUtils } from '../../util/url.utils';
import { map } from 'rxjs/operators';
import { isPagedResourceCollection, isResource, isResourceCollection } from '../../model/resource-type';
import { ResourceUtils } from '../../util/resource.utils';
import { Stage } from '../../logger/stage.enum';
import { StageLogger } from '../../logger/stage-logger';
import { ValidationUtils } from '../../util/validation.utils';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./cache/resource-cache.service";
/**
 * Service to perform HTTP requests to get any type of the {@link Resource}, {@link PagedResourceCollection}, {@link ResourceCollection}.
 */
export class CommonResourceHttpService extends HttpExecutor {
    constructor(httpClient, cacheService) {
        super(httpClient, cacheService);
    }
    /**
     * Perform custom HTTP request.
     *
     * Return type depends on result data it can be {@link Resource}, {@link ResourceCollection},
     * {@link PagedResourceCollection} or any data.
     *
     * @param resourceName used to build root url to the resource
     * @param resourceOptions additional resource options {@link ResourceOption}
     * @param method HTTP method that will be perform {@link HttpMethod}
     * @param query url path that applied to the result url at the end
     * @param body (optional) request body
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    customQuery(resourceName, resourceOptions, method, query, body, options) {
        ValidationUtils.validateInputParams({ resourceName, method, query });
        const url = UrlUtils.generateResourceUrl(UrlUtils.getApiUrl(resourceOptions.routeName), resourceName, query);
        StageLogger.stageLog(Stage.PREPARE_URL, {
            result: url,
            urlParts: `baseUrl: '${UrlUtils.getApiUrl(resourceOptions.routeName)}', resource: '${resourceName}', query: '${query}'`,
            options
        });
        const httpOptions = UrlUtils.convertToHttpOptions(options);
        let result;
        switch (method) {
            case HttpMethod.GET:
                result = super.getHttp(url, httpOptions, false);
                break;
            case HttpMethod.POST:
                result = super.postHttp(url, body, httpOptions);
                break;
            case HttpMethod.PUT:
                result = super.putHttp(url, body, httpOptions);
                break;
            case HttpMethod.PATCH:
                result = super.patchHttp(url, body, httpOptions);
                break;
            default:
                const errMsg = `allowed ony GET/POST/PUT/PATCH http methods you pass ${method}`;
                StageLogger.stageErrorLog(Stage.HTTP_REQUEST, { error: errMsg, options });
                return observableThrowError(new Error(errMsg));
        }
        return result.pipe(map(data => {
            const isProjection = httpOptions?.params?.has('projection');
            if (isPagedResourceCollection(data)) {
                return ResourceUtils.instantiatePagedResourceCollection(data, isProjection);
            }
            else if (isResourceCollection(data)) {
                return ResourceUtils.instantiateResourceCollection(data, isProjection);
            }
            else if (isResource(data)) {
                return ResourceUtils.instantiateResource(data, isProjection);
            }
            else {
                return data;
            }
        }));
    }
}
CommonResourceHttpService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: CommonResourceHttpService, deps: [{ token: i1.HttpClient }, { token: i2.ResourceCacheService }], target: i0.ɵɵFactoryTarget.Injectable });
CommonResourceHttpService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: CommonResourceHttpService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: CommonResourceHttpService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: i2.ResourceCacheService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLXJlc291cmNlLWh0dHAuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oYXRlb2FzLWNsaWVudC9zcmMvbGliL3NlcnZpY2UvaW50ZXJuYWwvY29tbW9uLXJlc291cmNlLWh0dHAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsVUFBVSxJQUFJLG9CQUFvQixFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxVQUFVLEVBQWtCLE1BQU0sMEJBQTBCLENBQUM7QUFDdEUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRWhELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsVUFBVSxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEcsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzFELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDOzs7O0FBSTlEOztHQUVHO0FBSUgsTUFBTSxPQUFPLHlCQUEwQixTQUFRLFlBQVk7SUFFekQsWUFBWSxVQUFzQixFQUN0QixZQUFrQztRQUM1QyxLQUFLLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7OztPQWFHO0lBQ0ksV0FBVyxDQUFDLFlBQW9CLEVBQ3BCLGVBQStCLEVB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LWV4ZWN1dG9yJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgYXMgb2JzZXJ2YWJsZVRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEh0dHBNZXRob2QsIFBhZ2VkR2V0T3B0aW9uIH0gZnJvbSAnLi4vLi4vbW9kZWwvZGVjbGFyYXRpb25zJztcbmltcG9ydCB7IFVybFV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbC91cmwudXRpbHMnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGlzUGFnZWRSZXNvdXJjZUNvbGxlY3Rpb24sIGlzUmVzb3VyY2UsIGlzUmVzb3VyY2VDb2xsZWN0aW9uIH0gZnJvbSAnLi4vLi4vbW9kZWwvcmVzb3VyY2UtdHlwZSc7XG5pbXBvcnQgeyBSZXNvdXJjZVV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbC9yZXNvdXJjZS51dGlscyc7XG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uLy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcbmltcG9ydCB7IFN0YWdlTG9nZ2VyIH0gZnJvbSAnLi4vLi4vbG9nZ2VyL3N0YWdlLWxvZ2dlcic7XG5pbXBvcnQgeyBWYWxpZGF0aW9uVXRpbHMgfSBmcm9tICcuLi8uLi91dGlsL3ZhbGlkYXRpb24udXRpbHMnO1xuaW1wb3J0IHsgUmVzb3VyY2VDYWNoZVNlcnZpY2UgfSBmcm9tICcuL2NhY2hlL3Jlc291cmNlLWNhY2hlLnNlcnZpY2UnO1xuaW1wb3J0IHsgUmVzb3VyY2VPcHRpb24gfSBmcm9tICcuLi8uLi9jb25maWcvaGF0ZW9hcy1jb25maWd1cmF0aW9uLmludGVyZmFjZSc7XG5cbi8qKlxuICogU2VydmljZSB0byBwZXJmb3JtIEhUVFAgcmVxdWVzdHMgdG8gZ2V0IGFueSB0eXBlIG9mIHRoZSB7QGxpbmsgUmVzb3VyY2V9LCB7QGxpbmsgUGFnZWRSZXNvdXJjZUNvbGxlY3Rpb259LCB7QGxpbmsgUmVzb3VyY2VDb2xsZWN0aW9ufS5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIENvbW1vblJlc291cmNlSHR0cFNlcnZpY2UgZXh0ZW5kcyBIdHRwRXhlY3V0b3Ige1xuXG4gIGNvbnN0cnVjdG9yKGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXG4gICAgICAgICAgICAgIGNhY2hlU2VydmljZTogUmVzb3VyY2VDYWNoZVNlcnZpY2UpIHtcbiAgICBzdXBlcihodHRwQ2xpZW50LCBjYWNoZVNlcnZpY2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gY3VzdG9tIEhUVFAgcmVxdWVzdC5cbiAgICpcbiAgICogUmV0dXJuIHR5cGUgZGVwZW5kcyBvbiByZXN1bHQgZGF0YSBpdCBjYW4gYmUge0BsaW5rIFJlc291cmNlfSwge0BsaW5rIFJlc291cmNlQ29sbGVjdGlvbn0sXG4gICAqIHtAbGluayBQYWdlZFJlc291cmNlQ29sbGVjdGlvbn0gb3IgYW55IGRhdGEuXG4gICAqXG4gICAqIEBwYXJhbSByZXNvdXJjZU5hbWUgdXNlZCB0byBidWlsZCByb290IHVybCB0byB0aGUgcmVzb3VyY2VcbiAgICogQHBhcmFtIHJlc291cmNlT3B0aW9ucyBhZGRpdGlvbmFsIHJlc291cmNlIG9wdGlvbnMge0BsaW5rIFJlc291cmNlT3B0aW9ufVxuICAgKiBAcGFyYW0gbWV0aG9kIEhUVFAgbWV0aG9kIHRoYXQgd2lsbCBiZSBwZXJmb3JtIHtAbGluayBIdHRwTWV0aG9kfVxuICAgKiBAcGFyYW0gcXVlcnkgdXJsIHBhdGggdGhhdCBhcHBsaWVkIHRvIHRoZSByZXN1bHQgdXJsIGF0IHRoZSBlbmRcbiAgICogQHBhcmFtIGJvZHkgKG9wdGlvbmFsKSByZXF1ZXN0IGJvZHlcbiAgICogQHBhcmFtIG9wdGlvbnMgKG9wdGlvbmFsKSBvcHRpb25zIHRoYXQgYXBwbGllZCB0byB0aGUgcmVxdWVzdFxuICAgKiBAdGhyb3dzIGVycm9yIHdoZW4gcmVxdWlyZWQgcGFyYW1zIGFyZSBub3QgdmFsaWRcbiAgICovXG4gIHB1YmxpYyBjdXN0b21RdWVyeShyZXNvdXJjZU5hbWU6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlT3B0aW9uczogUmVzb3VyY2VPcHRpb24sXG4gICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IEh0dHBNZXRob2QsXG4gICAgICAgICAgICAgICAgICAgICBxdWVyeTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgYm9keT86IGFueSxcbiAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM/OiBQYWdlZEdldE9wdGlvbik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgVmFsaWRhdGlvblV0aWxzLnZhbGlkYXRlSW5wdXRQYXJhbXMoe3Jlc291cmNlTmFtZSwgbWV0aG9kLCBxdWVyeX0pO1xuXG4gICAgY29uc3QgdXJsID0gVXJsVXRpbHMuZ2VuZXJhdGVSZXNvdXJjZVVybChVcmxVdGlscy5nZXRBcGlVcmwocmVzb3VyY2VPcHRpb25zLnJvdXRlTmFtZSksIHJlc291cmNlTmFtZSwgcXVlcnkpO1xuXG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuUFJFUEFSRV9VUkwsIHtcbiAgICAgIHJlc3VsdDogdXJsLFxuICAgICAgdXJsUGFydHM6IGBiYXNlVXJsOiAnJHsgVXJsVXRpbHMuZ2V0QXBpVXJsKHJlc291cmNlT3B0aW9ucy5yb3V0ZU5hbWUpIH0nLCByZXNvdXJjZTogJyR7IHJlc291cmNlTmFtZSB9JywgcXVlcnk6ICckeyBxdWVyeSB9J2AsXG4gICAgICBvcHRpb25zXG4gICAgfSk7XG5cbiAgICBjb25zdCBodHRwT3B0aW9ucyA9IFVybFV0aWxzLmNvbnZlcnRUb0h0dHBPcHRpb25zKG9wdGlvbnMpO1xuXG4gICAgbGV0IHJlc3VsdDogT2JzZXJ2YWJsZTxhbnk+O1xuICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICBjYXNlIEh0dHBNZXRob2QuR0VUOlxuICAgICAgICByZXN1bHQgPSBzdXBlci5nZXRIdHRwKHVybCwgaHR0cE9wdGlvbnMsIGZhbHNlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEh0dHBNZXRob2QuUE9TVDpcbiAgICAgICAgcmVzdWx0ID0gc3VwZXIucG9zdEh0dHAodXJsLCBib2R5LCBodHRwT3B0aW9ucyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBIdHRwTWV0aG9kLlBVVDpcbiAgICAgICAgcmVzdWx0ID0gc3VwZXIucHV0SHR0cCh1cmwsIGJvZHksIGh0dHBPcHRpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIEh0dHBNZXRob2QuUEFUQ0g6XG4gICAgICAgIHJlc3VsdCA9IHN1cGVyLnBhdGNoSHR0cCh1cmwsIGJvZHksIGh0dHBPcHRpb25zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zdCBlcnJNc2cgPSBgYWxsb3dlZCBvbnkgR0VUL1BPU1QvUFVUL1BBVENIIGh0dHAgbWV0aG9kcyB5b3UgcGFzcyAkeyBtZXRob2QgfWA7XG4gICAgICAgIFN0YWdlTG9nZ2VyLnN0YWdlRXJyb3JMb2coU3RhZ2UuSFRUUF9SRVFVRVNULCB7ZXJyb3I6IGVyck1zZywgb3B0aW9uc30pO1xuICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZVRocm93RXJyb3IobmV3IEVycm9yKGVyck1zZykpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQucGlwZShcbiAgICAgIG1hcChkYXRhID0+IHtcbiAgICAgICAgY29uc3QgaXNQcm9qZWN0aW9uID0gaHR0cE9wdGlvbnM/LnBhcmFtcz8uaGFzKCdwcm9qZWN0aW9uJyk7XG4gICAgICAgIGlmIChpc1BhZ2VkUmVzb3VyY2VDb2xsZWN0aW9uKGRhdGEpKSB7XG4gICAgICAgICAgcmV0dXJuIFJlc291cmNlVXRpbHMuaW5zdGFudGlhdGVQYWdlZFJlc291cmNlQ29sbGVjdGlvbihkYXRhLCBpc1Byb2plY3Rpb24pO1xuICAgICAgICB9IGVsc2UgaWYgKGlzUmVzb3VyY2VDb2xsZWN0aW9uKGRhdGEpKSB7XG4gICAgICAgICAgcmV0dXJuIFJlc291cmNlVXRpbHMuaW5zdGFudGlhdGVSZXNvdXJjZUNvbGxlY3Rpb24oZGF0YSwgaXNQcm9qZWN0aW9uKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc1Jlc291cmNlKGRhdGEpKSB7XG4gICAgICAgICAgcmV0dXJuIFJlc291cmNlVXRpbHMuaW5zdGFudGlhdGVSZXNvdXJjZShkYXRhLCBpc1Byb2plY3Rpb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxufVxuIl19