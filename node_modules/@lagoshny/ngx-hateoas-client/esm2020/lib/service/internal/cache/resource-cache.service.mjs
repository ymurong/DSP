import { Injectable } from '@angular/core';
import { CachedResource } from './model/cached-resource';
import { StageLogger } from '../../../logger/stage-logger';
import { Stage } from '../../../logger/stage.enum';
import { ValidationUtils } from '../../../util/validation.utils';
import { LibConfig } from '../../../config/lib-config';
import { UrlUtils } from '../../../util/url.utils';
import { isEmpty, isNil } from 'lodash-es';
import * as i0 from "@angular/core";
export class ResourceCacheService {
    constructor() {
        this.cacheMap = new Map();
    }
    /**
     * Get cached resource value.
     *
     * @param key cache key
     * @return cached value or {@code null} when cached value is not exist or expired
     */
    getResource(key) {
        ValidationUtils.validateInputParams({ key });
        const cacheValue = this.cacheMap.get(key.value);
        if (isNil(cacheValue)) {
            StageLogger.stageLog(Stage.CACHE_GET, { cacheKey: key.value, result: null });
            return null;
        }
        const cacheExpiredTime = new Date(cacheValue.cachedTime);
        cacheExpiredTime.setMilliseconds(cacheExpiredTime.getMilliseconds() + LibConfig.getConfig().cache.lifeTime);
        if (cacheExpiredTime.getTime() < new Date().getTime()) {
            this.evictResource(key);
            StageLogger.stageLog(Stage.CACHE_GET, { cacheKey: key.value, message: 'cache was expired', result: null });
            return null;
        }
        StageLogger.stageLog(Stage.CACHE_GET, { cacheKey: key.value, result: cacheValue.value });
        return cacheValue.value;
    }
    /**
     * Add resource value to the cache.
     * Before add new value, previous will be deleted if it was exist.
     *
     * @param key cache key
     * @param value cache value
     */
    putResource(key, value) {
        ValidationUtils.validateInputParams({ key, value });
        this.cacheMap.set(key.value, new CachedResource(value, new Date()));
        StageLogger.stageLog(Stage.CACHE_PUT, { cacheKey: key.value, value });
    }
    /**
     * Delete cached resource value by passed key.
     *
     * @param key cache key
     */
    evictResource(key) {
        ValidationUtils.validateInputParams({ key });
        // Get resource name by url to evict all resource cache with collection/paged collection data
        const resourceName = UrlUtils.getResourceNameFromUrl(key.url);
        if (!resourceName) {
            return;
        }
        const evictedCache = [];
        for (const cacheKey of this.cacheMap.keys()) {
            const resourceRoute = UrlUtils.guessResourceRoute(key.url);
            if (cacheKey.startsWith(`url=${resourceRoute.rootUrl}/${resourceName}`) ||
                (!isEmpty(resourceRoute.proxyUrl) && cacheKey.startsWith(`url=${resourceRoute.proxyUrl}/${resourceName}`))) {
                evictedCache.push({
                    key: cacheKey
                });
                this.cacheMap.delete(cacheKey);
            }
        }
        if (evictedCache.length > 0) {
            StageLogger.stageLog(Stage.CACHE_EVICT, { cacheKey: key.value, evicted: evictedCache });
        }
    }
    evictAll() {
        this.cacheMap.clear();
        StageLogger.stageLog(Stage.CACHE_EVICT_ALL, { message: 'All resources cache evicted' });
    }
}
ResourceCacheService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceCacheService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
ResourceCacheService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceCacheService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.1.3", ngImport: i0, type: ResourceCacheService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UtY2FjaGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oYXRlb2FzLWNsaWVudC9zcmMvbGliL3NlcnZpY2UvaW50ZXJuYWwvY2FjaGUvcmVzb3VyY2UtY2FjaGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDM0QsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRW5ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUVqRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ25ELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDOztBQUszQyxNQUFNLE9BQU8sb0JBQW9CO0lBSGpDO1FBS1UsYUFBUSxHQUFnQyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztLQWdGbkY7SUE5RUM7Ozs7O09BS0c7SUFDSSxXQUFXLENBQUMsR0FBYTtRQUM5QixlQUFlLENBQUMsbUJBQW1CLENBQUMsRUFBQyxHQUFHLEVBQUMsQ0FBQyxDQUFDO1FBRTNDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNoRCxJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUNyQixXQUFXLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsRUFBQyxRQUFRLEVBQUUsR0FBRyxDQUFD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S0FBSyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDO1NBQ3ZGO0lBQ0gsQ0FBQztJQUVNLFFBQVE7UUFDYixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3RCLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxFQUFDLE9BQU8sRUFBRSw2QkFBNkIsRUFBQyxDQUFDLENBQUM7SUFDeEYsQ0FBQzs7aUhBaEZVLG9CQUFvQjtxSEFBcEIsb0JBQW9CLGNBRm5CLE1BQU07MkZBRVAsb0JBQW9CO2tCQUhoQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENhY2hlZFJlc291cmNlIH0gZnJvbSAnLi9tb2RlbC9jYWNoZWQtcmVzb3VyY2UnO1xuaW1wb3J0IHsgU3RhZ2VMb2dnZXIgfSBmcm9tICcuLi8uLi8uLi9sb2dnZXIvc3RhZ2UtbG9nZ2VyJztcbmltcG9ydCB7IFN0YWdlIH0gZnJvbSAnLi4vLi4vLi4vbG9nZ2VyL3N0YWdlLmVudW0nO1xuaW1wb3J0IHsgQ2FjaGVLZXkgfSBmcm9tICcuL21vZGVsL2NhY2hlLWtleSc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uVXRpbHMgfSBmcm9tICcuLi8uLi8uLi91dGlsL3ZhbGlkYXRpb24udXRpbHMnO1xuaW1wb3J0IHsgUmVzb3VyY2VJZGVudGlmaWFibGUgfSBmcm9tICcuLi8uLi8uLi9tb2RlbC9kZWNsYXJhdGlvbnMnO1xuaW1wb3J0IHsgTGliQ29uZmlnIH0gZnJvbSAnLi4vLi4vLi4vY29uZmlnL2xpYi1jb25maWcnO1xuaW1wb3J0IHsgVXJsVXRpbHMgfSBmcm9tICcuLi8uLi8uLi91dGlsL3VybC51dGlscyc7XG5pbXBvcnQgeyBpc0VtcHR5LCBpc05pbCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBSZXNvdXJjZUNhY2hlU2VydmljZSB7XG5cbiAgcHJpdmF0ZSBjYWNoZU1hcDogTWFwPHN0cmluZywgQ2FjaGVkUmVzb3VyY2U+ID0gbmV3IE1hcDxzdHJpbmcsIENhY2hlZFJlc291cmNlPigpO1xuXG4gIC8qKlxuICAgKiBHZXQgY2FjaGVkIHJlc291cmNlIHZhbHVlLlxuICAgKlxuICAgKiBAcGFyYW0ga2V5IGNhY2hlIGtleVxuICAgKiBAcmV0dXJuIGNhY2hlZCB2YWx1ZSBvciB7QGNvZGUgbnVsbH0gd2hlbiBjYWNoZWQgdmFsdWUgaXMgbm90IGV4aXN0IG9yIGV4cGlyZWRcbiAgICovXG4gIHB1YmxpYyBnZXRSZXNvdXJjZShrZXk6IENhY2hlS2V5KTogUmVzb3VyY2VJZGVudGlmaWFibGUge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtrZXl9KTtcblxuICAgIGNvbnN0IGNhY2hlVmFsdWUgPSB0aGlzLmNhY2hlTWFwLmdldChrZXkudmFsdWUpO1xuICAgIGlmIChpc05pbChjYWNoZVZhbHVlKSkge1xuICAgICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuQ0FDSEVfR0VULCB7Y2FjaGVLZXk6IGtleS52YWx1ZSwgcmVzdWx0OiBudWxsfSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBjYWNoZUV4cGlyZWRUaW1lID0gbmV3IERhdGUoY2FjaGVWYWx1ZS5jYWNoZWRUaW1lKTtcbiAgICBjYWNoZUV4cGlyZWRUaW1lLnNldE1pbGxpc2Vjb25kcyhjYWNoZUV4cGlyZWRUaW1lLmdldE1pbGxpc2Vjb25kcygpICsgTGliQ29uZmlnLmdldENvbmZpZygpLmNhY2hlLmxpZmVUaW1lKTtcbiAgICBpZiAoY2FjaGVFeHBpcmVkVGltZS5nZXRUaW1lKCkgPCBuZXcgRGF0ZSgpLmdldFRpbWUoKSkge1xuICAgICAgdGhpcy5ldmljdFJlc291cmNlKGtleSk7XG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUxvZyhTdGFnZS5DQUNIRV9HRVQsIHtjYWNoZUtleToga2V5LnZhbHVlLCBtZXNzYWdlOiAnY2FjaGUgd2FzIGV4cGlyZWQnLCByZXN1bHQ6IG51bGx9KTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLkNBQ0hFX0dFVCwge2NhY2hlS2V5OiBrZXkudmFsdWUsIHJlc3VsdDogY2FjaGVWYWx1ZS52YWx1ZX0pO1xuICAgIHJldHVybiBjYWNoZVZhbHVlLnZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCByZXNvdXJjZSB2YWx1ZSB0byB0aGUgY2FjaGUuXG4gICAqIEJlZm9yZSBhZGQgbmV3IHZhbHVlLCBwcmV2aW91cyB3aWxsIGJlIGRlbGV0ZWQgaWYgaXQgd2FzIGV4aXN0LlxuICAgKlxuICAgKiBAcGFyYW0ga2V5IGNhY2hlIGtleVxuICAgKiBAcGFyYW0gdmFsdWUgY2FjaGUgdmFsdWVcbiAgICovXG4gIHB1YmxpYyBwdXRSZXNvdXJjZShrZXk6IENhY2hlS2V5LCB2YWx1ZTogUmVzb3VyY2VJZGVudGlmaWFibGUpOiB2b2lkIHtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7a2V5LCB2YWx1ZX0pO1xuXG4gICAgdGhpcy5jYWNoZU1hcC5zZXQoa2V5LnZhbHVlLCBuZXcgQ2FjaGVkUmVzb3VyY2UodmFsdWUsIG5ldyBEYXRlKCkpKTtcblxuICAgIFN0YWdlTG9nZ2VyLnN0YWdlTG9nKFN0YWdlLkNBQ0hFX1BVVCwge2NhY2hlS2V5OiBrZXkudmFsdWUsIHZhbHVlfSk7XG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIGNhY2hlZCByZXNvdXJjZSB2YWx1ZSBieSBwYXNzZWQga2V5LlxuICAgKlxuICAgKiBAcGFyYW0ga2V5IGNhY2hlIGtleVxuICAgKi9cbiAgcHVibGljIGV2aWN0UmVzb3VyY2Uoa2V5OiBDYWNoZUtleSk6IHZvaWQge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHtrZXl9KTtcblxuICAgIC8vIEdldCByZXNvdXJjZSBuYW1lIGJ5IHVybCB0byBldmljdCBhbGwgcmVzb3VyY2UgY2FjaGUgd2l0aCBjb2xsZWN0aW9uL3BhZ2VkIGNvbGxlY3Rpb24gZGF0YVxuICAgIGNvbnN0IHJlc291cmNlTmFtZSA9IFVybFV0aWxzLmdldFJlc291cmNlTmFtZUZyb21Vcmwoa2V5LnVybCk7XG4gICAgaWYgKCFyZXNvdXJjZU5hbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBldmljdGVkQ2FjaGUgPSBbXTtcbiAgICBmb3IgKGNvbnN0IGNhY2hlS2V5IG9mIHRoaXMuY2FjaGVNYXAua2V5cygpKSB7XG4gICAgICBjb25zdCByZXNvdXJjZVJvdXRlID0gVXJsVXRpbHMuZ3Vlc3NSZXNvdXJjZVJvdXRlKGtleS51cmwpO1xuXG4gICAgICBpZiAoY2FjaGVLZXkuc3RhcnRzV2l0aChgdXJsPSR7IHJlc291cmNlUm91dGUucm9vdFVybCB9LyR7IHJlc291cmNlTmFtZSB9YCkgfHxcbiAgICAgICAgKCFpc0VtcHR5KHJlc291cmNlUm91dGUucHJveHlVcmwpICYmIGNhY2hlS2V5LnN0YXJ0c1dpdGgoYHVybD0keyByZXNvdXJjZVJvdXRlLnByb3h5VXJsIH0vJHsgcmVzb3VyY2VOYW1lIH1gKSkpIHtcbiAgICAgICAgZXZpY3RlZENhY2hlLnB1c2goe1xuICAgICAgICAgIGtleTogY2FjaGVLZXlcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY2FjaGVNYXAuZGVsZXRlKGNhY2hlS2V5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGV2aWN0ZWRDYWNoZS5sZW5ndGggPiAwKSB7XG4gICAgICBTdGFnZUxvZ2dlci5zdGFnZUxvZyhTdGFnZS5DQUNIRV9FVklDVCwge2NhY2hlS2V5OiBrZXkudmFsdWUsIGV2aWN0ZWQ6IGV2aWN0ZWRDYWNoZX0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBldmljdEFsbCgpOiB2b2lkIHtcbiAgICB0aGlzLmNhY2hlTWFwLmNsZWFyKCk7XG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuQ0FDSEVfRVZJQ1RfQUxMLCB7bWVzc2FnZTogJ0FsbCByZXNvdXJjZXMgY2FjaGUgZXZpY3RlZCd9KTtcbiAgfVxuXG59XG4iXX0=