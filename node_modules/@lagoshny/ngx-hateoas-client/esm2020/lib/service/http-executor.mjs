import { of as observableOf } from 'rxjs';
import { tap } from 'rxjs/operators';
import { StageLogger } from '../logger/stage-logger';
import { Stage } from '../logger/stage.enum';
import { ValidationUtils } from '../util/validation.utils';
import { CacheKey } from './internal/cache/model/cache-key';
import { isResourceObject } from '../model/resource-type';
import { LibConfig } from '../config/lib-config';
import { CacheUtils } from '../util/cache.utils';
/**
 * Base class with common logics to perform HTTP requests.
 */
/* tslint:disable:no-string-literal */
export class HttpExecutor {
    constructor(httpClient, cacheService) {
        this.httpClient = httpClient;
        this.cacheService = cacheService;
    }
    static logRequest(method, url, options, body) {
        const params = {
            method,
            url,
            options: {
                ...options,
                params: options?.params?.keys().length > 0 ? options?.params.toString() : '',
            }
        };
        if (body) {
            params['body'] = body;
        }
        StageLogger.stageLog(Stage.HTTP_REQUEST, params);
    }
    static logResponse(method, url, options, data) {
        StageLogger.stageLog(Stage.HTTP_RESPONSE, {
            method,
            url,
            options: {
                ...options,
                params: options?.params?.keys().length > 0 ? options?.params.toString() : '',
            },
            result: data
        });
    }
    /**
     * Perform GET request.
     *
     * @param url to perform request
     * @param options (optional) options that applied to the request
     * @param useCache value {@code true} if need to use cache, {@code false} otherwise
     * @throws error when required params are not valid
     */
    getHttp(url, options, useCache) {
        ValidationUtils.validateInputParams({ url });
        if (CacheUtils.shouldUseCache(useCache)) {
            const cachedValue = this.cacheService.getResource(CacheKey.of(url, options));
            if (cachedValue != null) {
                return observableOf(cachedValue);
            }
        }
        HttpExecutor.logRequest('GET', url, options);
        let response;
        if (options?.observe === 'response') {
            response = this.httpClient.get(url, { ...options, observe: 'response' });
        }
        else {
            response = this.httpClient.get(url, { ...options, observe: 'body' });
        }
        return response.pipe(tap((data) => {
            HttpExecutor.logResponse('GET', url, options, data);
            if (CacheUtils.shouldUseCache(useCache) && isResourceObject(data)) {
                this.cacheService.putResource(CacheKey.of(url, options), data);
            }
        }));
    }
    /**
     * Perform POST request.
     *
     * @param url to perform request
     * @param body to send with request
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    postHttp(url, body, options) {
        HttpExecutor.logRequest('POST', url, options, body);
        ValidationUtils.validateInputParams({ url });
        let response;
        if (options?.observe === 'response') {
            response = this.httpClient.post(url, body, { ...options, observe: 'response' });
        }
        else {
            response = this.httpClient.post(url, body, { ...options, observe: 'body' });
        }
        return response.pipe(tap((data) => {
            HttpExecutor.logResponse('POST', url, options, data);
            if (LibConfig.getConfig().cache.enabled) {
                this.cacheService.evictResource(CacheKey.of(url, options));
            }
        }));
    }
    /**
     * Perform PUT request.
     *
     * @param url to perform request
     * @param body to send with request
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    putHttp(url, body, options) {
        HttpExecutor.logRequest('PUT', url, options, body);
        ValidationUtils.validateInputParams({ url });
        let response;
        if (options?.observe === 'response') {
            response = this.httpClient.put(url, body, { ...options, observe: 'response' });
        }
        else {
            response = this.httpClient.put(url, body, { ...options, observe: 'body' });
        }
        return response.pipe(tap((data) => {
            HttpExecutor.logResponse('PUT', url, options, data);
            if (LibConfig.getConfig().cache.enabled) {
                this.cacheService.evictResource(CacheKey.of(url, options));
            }
        }));
    }
    /**
     * Perform PATCH request.
     *
     * @param url to perform request
     * @param body to send with request
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    patchHttp(url, body, options) {
        HttpExecutor.logRequest('PATCH', url, options, body);
        ValidationUtils.validateInputParams({ url });
        let response;
        if (options?.observe === 'response') {
            response = this.httpClient.patch(url, body, { ...options, observe: 'response' });
        }
        else {
            response = this.httpClient.patch(url, body, { ...options, observe: 'body' });
        }
        return response.pipe(tap((data) => {
            HttpExecutor.logResponse('PATCH', url, options, data);
            if (LibConfig.getConfig().cache.enabled) {
                this.cacheService.evictResource(CacheKey.of(url, options));
            }
        }));
    }
    /**
     * Perform DELETE request.
     *
     * @param url to perform request
     * @param options (optional) options that applied to the request
     * @throws error when required params are not valid
     */
    deleteHttp(url, options) {
        HttpExecutor.logRequest('DELETE', url, options);
        ValidationUtils.validateInputParams({ url });
        let response;
        if (options?.observe === 'response') {
            response = this.httpClient.delete(url, { ...options, observe: 'response' });
        }
        else {
            response = this.httpClient.delete(url, { ...options, observe: 'body' });
        }
        return response.pipe(tap((data) => {
            HttpExecutor.logResponse('DELETE', url, options, data);
            if (LibConfig.getConfig().cache.enabled) {
                this.cacheService.evictResource(CacheKey.of(url, options));
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1leGVjdXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1oYXRlb2FzLWNsaWVudC9zcmMvbGliL3NlcnZpY2UvaHR0cC1leGVjdXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQWMsRUFBRSxJQUFJLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTFELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFakQ7O0dBRUc7QUFFSCxzQ0FBc0M7QUFDdEMsTUFBTSxPQUFPLFlBQVk7SUFFdkIsWUFBc0IsVUFBc0IsRUFDdEIsWUFBa0M7UUFEbEMsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixpQkFBWSxHQUFaLFlBQVksQ0FBc0I7SUFDeEQsQ0FBQztJQUVPLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBYyxFQUNkLEdBQVcsRUFDWCxPQUEwQixFQUMxQixJQUFVO1FBQ2xDLE1BQU0sTUFBTSxHQUFHO1lBQ2IsTUFBTTtZQUNOLEdBQUc7WUFDSCxPQUFPLEVBQUU7Z0JBQ1AsR0FBRyxPQUFPO2dCQUNWLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxD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QyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ1gsWUFBWSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztZQUN2RCxJQUFJLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFO2dCQUN2QyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO2FBQzVEO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiBhcyBvYnNlcnZhYmxlT2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN0YWdlTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyL3N0YWdlLWxvZ2dlcic7XG5pbXBvcnQgeyBTdGFnZSB9IGZyb20gJy4uL2xvZ2dlci9zdGFnZS5lbnVtJztcbmltcG9ydCB7IFZhbGlkYXRpb25VdGlscyB9IGZyb20gJy4uL3V0aWwvdmFsaWRhdGlvbi51dGlscyc7XG5pbXBvcnQgeyBDYWNoZUtleSB9IGZyb20gJy4vaW50ZXJuYWwvY2FjaGUvbW9kZWwvY2FjaGUta2V5JztcbmltcG9ydCB7IGlzUmVzb3VyY2VPYmplY3QgfSBmcm9tICcuLi9tb2RlbC9yZXNvdXJjZS10eXBlJztcbmltcG9ydCB7IFJlc291cmNlQ2FjaGVTZXJ2aWNlIH0gZnJvbSAnLi9pbnRlcm5hbC9jYWNoZS9yZXNvdXJjZS1jYWNoZS5zZXJ2aWNlJztcbmltcG9ydCB7IExpYkNvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9saWItY29uZmlnJztcbmltcG9ydCB7IEh0dHBDbGllbnRPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWwvZGVjbGFyYXRpb25zJztcbmltcG9ydCB7IENhY2hlVXRpbHMgfSBmcm9tICcuLi91dGlsL2NhY2hlLnV0aWxzJztcblxuLyoqXG4gKiBCYXNlIGNsYXNzIHdpdGggY29tbW9uIGxvZ2ljcyB0byBwZXJmb3JtIEhUVFAgcmVxdWVzdHMuXG4gKi9cblxuLyogdHNsaW50OmRpc2FibGU6bm8tc3RyaW5nLWxpdGVyYWwgKi9cbmV4cG9ydCBjbGFzcyBIdHRwRXhlY3V0b3Ige1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgICAgICAgICAgICBwcm90ZWN0ZWQgY2FjaGVTZXJ2aWNlOiBSZXNvdXJjZUNhY2hlU2VydmljZSkge1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgbG9nUmVxdWVzdChtZXRob2Q6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBIdHRwQ2xpZW50T3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5PzogYW55KSB7XG4gICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgbWV0aG9kLFxuICAgICAgdXJsLFxuICAgICAgb3B0aW9uczoge1xuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICBwYXJhbXM6IG9wdGlvbnM/LnBhcmFtcz8ua2V5cygpLmxlbmd0aCA+IDAgPyBvcHRpb25zPy5wYXJhbXMudG9TdHJpbmcoKSA6ICcnLFxuICAgICAgfVxuICAgIH07XG4gICAgaWYgKGJvZHkpIHtcbiAgICAgIHBhcmFtc1snYm9keSddID0gYm9keTtcbiAgICB9XG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuSFRUUF9SRVFVRVNULCBwYXJhbXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgbG9nUmVzcG9uc2UobWV0aG9kOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBIdHRwQ2xpZW50T3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogYW55KSB7XG4gICAgU3RhZ2VMb2dnZXIuc3RhZ2VMb2coU3RhZ2UuSFRUUF9SRVNQT05TRSwge1xuICAgICAgbWV0aG9kLFxuICAgICAgdXJsLFxuICAgICAgb3B0aW9uczoge1xuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICBwYXJhbXM6IG9wdGlvbnM/LnBhcmFtcz8ua2V5cygpLmxlbmd0aCA+IDAgPyBvcHRpb25zPy5wYXJhbXMudG9TdHJpbmcoKSA6ICcnLFxuICAgICAgfSxcbiAgICAgIHJlc3VsdDogZGF0YVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gR0VUIHJlcXVlc3QuXG4gICAqXG4gICAqIEBwYXJhbSB1cmwgdG8gcGVyZm9ybSByZXF1ZXN0XG4gICAqIEBwYXJhbSBvcHRpb25zIChvcHRpb25hbCkgb3B0aW9ucyB0aGF0IGFwcGxpZWQgdG8gdGhlIHJlcXVlc3RcbiAgICogQHBhcmFtIHVzZUNhY2hlIHZhbHVlIHtAY29kZSB0cnVlfSBpZiBuZWVkIHRvIHVzZSBjYWNoZSwge0Bjb2RlIGZhbHNlfSBvdGhlcndpc2VcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgZ2V0SHR0cCh1cmw6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgb3B0aW9ucz86IEh0dHBDbGllbnRPcHRpb25zLFxuICAgICAgICAgICAgICAgICB1c2VDYWNoZT86IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHt1cmx9KTtcbiAgICBpZiAoQ2FjaGVVdGlscy5zaG91bGRVc2VDYWNoZSh1c2VDYWNoZSkpIHtcbiAgICAgIGNvbnN0IGNhY2hlZFZhbHVlID0gdGhpcy5jYWNoZVNlcnZpY2UuZ2V0UmVzb3VyY2UoQ2FjaGVLZXkub2YodXJsLCBvcHRpb25zKSk7XG4gICAgICBpZiAoY2FjaGVkVmFsdWUgIT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZU9mKGNhY2hlZFZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgSHR0cEV4ZWN1dG9yLmxvZ1JlcXVlc3QoJ0dFVCcsIHVybCwgb3B0aW9ucyk7XG5cbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgaWYgKG9wdGlvbnM/Lm9ic2VydmUgPT09ICdyZXNwb25zZScpIHtcbiAgICAgIHJlc3BvbnNlID0gdGhpcy5odHRwQ2xpZW50LmdldCh1cmwsIHsuLi5vcHRpb25zLCBvYnNlcnZlOiAncmVzcG9uc2UnfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3BvbnNlID0gdGhpcy5odHRwQ2xpZW50LmdldCh1cmwsIHsuLi5vcHRpb25zLCBvYnNlcnZlOiAnYm9keSd9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2UucGlwZShcbiAgICAgIHRhcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgIEh0dHBFeGVjdXRvci5sb2dSZXNwb25zZSgnR0VUJywgdXJsLCBvcHRpb25zLCBkYXRhKTtcbiAgICAgICAgaWYgKENhY2hlVXRpbHMuc2hvdWxkVXNlQ2FjaGUodXNlQ2FjaGUpICYmIGlzUmVzb3VyY2VPYmplY3QoZGF0YSkpIHtcbiAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZS5wdXRSZXNvdXJjZShDYWNoZUtleS5vZih1cmwsIG9wdGlvbnMpLCBkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gUE9TVCByZXF1ZXN0LlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gYm9keSB0byBzZW5kIHdpdGggcmVxdWVzdFxuICAgKiBAcGFyYW0gb3B0aW9ucyAob3B0aW9uYWwpIG9wdGlvbnMgdGhhdCBhcHBsaWVkIHRvIHRoZSByZXF1ZXN0XG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHBvc3RIdHRwKHVybDogc3RyaW5nLCBib2R5OiBhbnkgfCBudWxsLCBvcHRpb25zPzogSHR0cENsaWVudE9wdGlvbnMpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIEh0dHBFeGVjdXRvci5sb2dSZXF1ZXN0KCdQT1NUJywgdXJsLCBvcHRpb25zLCBib2R5KTtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7dXJsfSk7XG5cbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgaWYgKG9wdGlvbnM/Lm9ic2VydmUgPT09ICdyZXNwb25zZScpIHtcbiAgICAgIHJlc3BvbnNlID0gdGhpcy5odHRwQ2xpZW50LnBvc3QodXJsLCBib2R5LCB7Li4ub3B0aW9ucywgb2JzZXJ2ZTogJ3Jlc3BvbnNlJ30pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNwb25zZSA9IHRoaXMuaHR0cENsaWVudC5wb3N0KHVybCwgYm9keSwgey4uLm9wdGlvbnMsIG9ic2VydmU6ICdib2R5J30pO1xuICAgIH1cblxuICAgIHJldHVybiByZXNwb25zZS5waXBlKFxuICAgICAgdGFwKChkYXRhKSA9PiB7XG4gICAgICAgIEh0dHBFeGVjdXRvci5sb2dSZXNwb25zZSgnUE9TVCcsIHVybCwgb3B0aW9ucywgZGF0YSk7XG4gICAgICAgIGlmIChMaWJDb25maWcuZ2V0Q29uZmlnKCkuY2FjaGUuZW5hYmxlZCkge1xuICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLmV2aWN0UmVzb3VyY2UoQ2FjaGVLZXkub2YodXJsLCBvcHRpb25zKSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIFBVVCByZXF1ZXN0LlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gYm9keSB0byBzZW5kIHdpdGggcmVxdWVzdFxuICAgKiBAcGFyYW0gb3B0aW9ucyAob3B0aW9uYWwpIG9wdGlvbnMgdGhhdCBhcHBsaWVkIHRvIHRoZSByZXF1ZXN0XG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHB1dEh0dHAodXJsOiBzdHJpbmcsIGJvZHk6IGFueSB8IG51bGwsIG9wdGlvbnM/OiBIdHRwQ2xpZW50T3B0aW9ucyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgSHR0cEV4ZWN1dG9yLmxvZ1JlcXVlc3QoJ1BVVCcsIHVybCwgb3B0aW9ucywgYm9keSk7XG4gICAgVmFsaWRhdGlvblV0aWxzLnZhbGlkYXRlSW5wdXRQYXJhbXMoe3VybH0pO1xuXG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIGlmIChvcHRpb25zPy5vYnNlcnZlID09PSAncmVzcG9uc2UnKSB7XG4gICAgICByZXNwb25zZSA9IHRoaXMuaHR0cENsaWVudC5wdXQodXJsLCBib2R5LCB7Li4ub3B0aW9ucywgb2JzZXJ2ZTogJ3Jlc3BvbnNlJ30pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNwb25zZSA9IHRoaXMuaHR0cENsaWVudC5wdXQodXJsLCBib2R5LCB7Li4ub3B0aW9ucywgb2JzZXJ2ZTogJ2JvZHknfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3BvbnNlLnBpcGUoXG4gICAgICB0YXAoKGRhdGEpID0+IHtcbiAgICAgICAgSHR0cEV4ZWN1dG9yLmxvZ1Jlc3BvbnNlKCdQVVQnLCB1cmwsIG9wdGlvbnMsIGRhdGEpO1xuICAgICAgICBpZiAoTGliQ29uZmlnLmdldENvbmZpZygpLmNhY2hlLmVuYWJsZWQpIHtcbiAgICAgICAgICB0aGlzLmNhY2hlU2VydmljZS5ldmljdFJlc291cmNlKENhY2hlS2V5Lm9mKHVybCwgb3B0aW9ucykpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBQQVRDSCByZXF1ZXN0LlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRvIHBlcmZvcm0gcmVxdWVzdFxuICAgKiBAcGFyYW0gYm9keSB0byBzZW5kIHdpdGggcmVxdWVzdFxuICAgKiBAcGFyYW0gb3B0aW9ucyAob3B0aW9uYWwpIG9wdGlvbnMgdGhhdCBhcHBsaWVkIHRvIHRoZSByZXF1ZXN0XG4gICAqIEB0aHJvd3MgZXJyb3Igd2hlbiByZXF1aXJlZCBwYXJhbXMgYXJlIG5vdCB2YWxpZFxuICAgKi9cbiAgcHVibGljIHBhdGNoSHR0cCh1cmw6IHN0cmluZywgYm9keTogYW55IHwgbnVsbCwgb3B0aW9ucz86IEh0dHBDbGllbnRPcHRpb25zKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBIdHRwRXhlY3V0b3IubG9nUmVxdWVzdCgnUEFUQ0gnLCB1cmwsIG9wdGlvbnMsIGJvZHkpO1xuICAgIFZhbGlkYXRpb25VdGlscy52YWxpZGF0ZUlucHV0UGFyYW1zKHt1cmx9KTtcblxuICAgIGxldCByZXNwb25zZTtcbiAgICBpZiAob3B0aW9ucz8ub2JzZXJ2ZSA9PT0gJ3Jlc3BvbnNlJykge1xuICAgICAgcmVzcG9uc2UgPSB0aGlzLmh0dHBDbGllbnQucGF0Y2godXJsLCBib2R5LCB7Li4ub3B0aW9ucywgb2JzZXJ2ZTogJ3Jlc3BvbnNlJ30pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNwb25zZSA9IHRoaXMuaHR0cENsaWVudC5wYXRjaCh1cmwsIGJvZHksIHsuLi5vcHRpb25zLCBvYnNlcnZlOiAnYm9keSd9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2UucGlwZShcbiAgICAgIHRhcCgoZGF0YSkgPT4ge1xuICAgICAgICBIdHRwRXhlY3V0b3IubG9nUmVzcG9uc2UoJ1BBVENIJywgdXJsLCBvcHRpb25zLCBkYXRhKTtcbiAgICAgICAgaWYgKExpYkNvbmZpZy5nZXRDb25maWcoKS5jYWNoZS5lbmFibGVkKSB7XG4gICAgICAgICAgdGhpcy5jYWNoZVNlcnZpY2UuZXZpY3RSZXNvdXJjZShDYWNoZUtleS5vZih1cmwsIG9wdGlvbnMpKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gREVMRVRFIHJlcXVlc3QuXG4gICAqXG4gICAqIEBwYXJhbSB1cmwgdG8gcGVyZm9ybSByZXF1ZXN0XG4gICAqIEBwYXJhbSBvcHRpb25zIChvcHRpb25hbCkgb3B0aW9ucyB0aGF0IGFwcGxpZWQgdG8gdGhlIHJlcXVlc3RcbiAgICogQHRocm93cyBlcnJvciB3aGVuIHJlcXVpcmVkIHBhcmFtcyBhcmUgbm90IHZhbGlkXG4gICAqL1xuICBwdWJsaWMgZGVsZXRlSHR0cCh1cmw6IHN0cmluZywgb3B0aW9ucz86IEh0dHBDbGllbnRPcHRpb25zKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBIdHRwRXhlY3V0b3IubG9nUmVxdWVzdCgnREVMRVRFJywgdXJsLCBvcHRpb25zKTtcbiAgICBWYWxpZGF0aW9uVXRpbHMudmFsaWRhdGVJbnB1dFBhcmFtcyh7dXJsfSk7XG5cbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgaWYgKG9wdGlvbnM/Lm9ic2VydmUgPT09ICdyZXNwb25zZScpIHtcbiAgICAgIHJlc3BvbnNlID0gdGhpcy5odHRwQ2xpZW50LmRlbGV0ZSh1cmwsIHsuLi5vcHRpb25zLCBvYnNlcnZlOiAncmVzcG9uc2UnfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3BvbnNlID0gdGhpcy5odHRwQ2xpZW50LmRlbGV0ZSh1cmwsIHsuLi5vcHRpb25zLCBvYnNlcnZlOiAnYm9keSd9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzcG9uc2UucGlwZShcbiAgICAgIHRhcCgoZGF0YSkgPT4ge1xuICAgICAgICBIdHRwRXhlY3V0b3IubG9nUmVzcG9uc2UoJ0RFTEVURScsIHVybCwgb3B0aW9ucywgZGF0YSk7XG4gICAgICAgIGlmIChMaWJDb25maWcuZ2V0Q29uZmlnKCkuY2FjaGUuZW5hYmxlZCkge1xuICAgICAgICAgIHRoaXMuY2FjaGVTZXJ2aWNlLmV2aWN0UmVzb3VyY2UoQ2FjaGVLZXkub2YodXJsLCBvcHRpb25zKSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG59XG4iXX0=